–î—É–∂–µ –¥–æ–±—Ä–µ ‚Äî —è –±–∞—á—É –∑ —Ñ–æ—Ç–æ, —â–æ –≤ —Ç–µ–±–µ –∑–∞—Ä–∞–∑ —É PL/SQL –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—É:

> —á–∏ —ñ—Å–Ω—É—î –∑–∞–ø–∏—Å **–∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ** –∑ —Ç—ñ—î—é –∂ *company_id + unit_id + department_id*,
> —ñ —è–∫—â–æ —ñ—Å–Ω—É—î, —Ç–æ —Ç–∏ –ø—ñ–¥–Ω—ñ–º–∞—î—à `raise_application_error(-20002, '...')`.

–¢–µ–ø–µ—Ä –º–∏ —Ö–æ—á–µ–º–æ –¥–æ–∑–≤–æ–ª–∏—Ç–∏, —â–æ–± **—É –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ —Ü–µ—Ö—É (department)** **—Ä—ñ–∑–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** –º–æ–≥–ª–∏ –≤–Ω–æ—Å–∏—Ç–∏ –∑–∞–ø–∏—Å–∏, —Ç–æ–º—É:

* —Å—Ç–∞—Ä–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ `department_id + company_id + unit_id` —Å—Ç–∞—î –∑–∞–π–≤–æ—é;
* –Ω–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—é **`creator (user_id)` + `company_id` + `unit_id`**.

---

## üîß –û–Ω–æ–≤–ª–µ–Ω–∏–π PL/SQL –±–ª–æ–∫

–û—Å—å –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–∏–π –∫–æ–¥ —Ç–≤–æ—î—ó –ª–æ–≥—ñ–∫–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –Ω–æ–≤–æ–≥–æ —É–Ω—ñ–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞:

```plsql
DECLARE
    v_exists      NUMBER;
    v_error_code  NUMBER;
    v_company_name VARCHAR2(255);
    v_unit_name    VARCHAR2(255);
    v_date_rec     DATE;
BEGIN
    -- üîπ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –≤–∂–µ —î —Ç–∞–∫–∏–π –∑–∞–ø–∏—Å –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    SELECT COUNT(*)
      INTO v_exists
      FROM external_personal ep
     WHERE ep.company_id = :P8_COMPANY
       AND ep.unit_id    = :P8_UNIT
       AND ep.creator    = :P0_CUR_USER_TABNO
       AND TRUNC(ep.date_create) = TRUNC(SYSDATE)
       AND ep.date_end IS NULL;

    apex_debug.info('–Ü—Å–Ω—É—é—á–∏—Ö –∑–∞–ø–∏—Å—ñ–≤: ' || v_exists);

    IF v_exists > 0 THEN
        -- üîπ –û—Ç—Ä–∏–º—É—î–º–æ –¥–µ—Ç–∞–ª—ñ —ñ—Å–Ω—É—é—á–æ–≥–æ –∑–∞–ø–∏—Å—É
        SELECT c.name AS company_name,
               u.name AS unit_name,
               ep.date_create
          INTO v_company_name, v_unit_name, v_date_rec
          FROM external_personal ep
               JOIN company c ON c.id = ep.company_id
               JOIN units u   ON u.id = ep.unit_id
         WHERE ep.company_id = :P8_COMPANY
           AND ep.unit_id    = :P8_UNIT
           AND ep.creator    = :P0_CUR_USER_TABNO
           AND TRUNC(ep.date_create) = TRUNC(SYSDATE)
           AND ep.date_end IS NULL;

        raise_application_error(
            -20002,
            '–ó–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î –¥–ª—è –∫–æ–º–ø–∞–Ω—ñ—ó "' || v_company_name ||
            '" —ñ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É "' || v_unit_name ||
            '" (—Å—Ç–≤–æ—Ä–µ–Ω–æ: ' || TO_CHAR(v_date_rec, 'DD.MM.YYYY HH24:MI') || '). ' ||
            '–í–∏ –º–æ–∂–µ—Ç–µ –π–æ–≥–æ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.'
        );
    ELSE
        -- üîπ –Ø–∫—â–æ –∑–∞–ø–∏—Å—É —â–µ –Ω–µ–º–∞—î ‚Äî –≤—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–æ–≤–∏–π
        INSERT INTO external_personal (
            department_id,
            unit_id,
            work_type_id,
            work_type_text,
            people_count,
            company_id,
            date_create,
            creator,
            date_end
        )
        VALUES (
            :P0_DEPARTMENT_ID_FROM_DB,
            :P8_UNIT,
            :P8_WORK_TYPE,
            :P8_WORK_TYPE_TEXT,
            :P8_PEOPLE_COUNT,
            :P8_COMPANY,
            SYSDATE,
            :P0_CUR_USER_TABNO,
            NULL
        );
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        raise_application_error(-20001, '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ.');
    WHEN OTHERS THEN
        v_error_code := SQLCODE;
        apex_debug.error('–ü–æ–º–∏–ª–∫–∞: ' || v_error_code || ' ‚Äî ' || SQLERRM);
        IF v_error_code != -20002 THEN
            raise_application_error(-20003, '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É: ' || SQLERRM);
        END IF;
END;
```

---

## üß© –ü–æ—è—Å–Ω–µ–Ω–Ω—è

| –õ–æ–≥—ñ–∫–∞                                   | –û–ø–∏—Å                                               |
| ---------------------------------------- | -------------------------------------------------- |
| `ep.creator = :P0_CUR_USER_TABNO`        | —Ñ—ñ–∫—Å—É—î, —â–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ–¥–µ—Ç—å—Å—è –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ |
| `TRUNC(ep.date_create) = TRUNC(SYSDATE)` | –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–∏—à–µ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å                    |
| `AND ep.date_end IS NULL`                | –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å                                     |
| `raise_application_error(-20002, ...)`   | –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –ø—Ä–æ –¥—É–±–ª—å                 |
| `INSERT INTO external_personal`          | –≤—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —è–∫—â–æ –¥—É–±–ª—è –Ω–µ–º–∞—î            |

---

## üîí –ù–æ–≤–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å —É –±–∞–∑—ñ

–°—Ç–≤–æ—Ä–∏ –Ω–æ–≤–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å:

```sql
CREATE UNIQUE INDEX EXT_PERSONAL_UK1
ON external_personal (creator, company_id, unit_id);
```

> üî∏ –Ø–∫—â–æ —Å—Ç–∞—Ä–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –±—É–≤ –Ω–∞ `(department_id, company_id, unit_id)`, –π–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏:
>
> ```sql
> DROP INDEX EXT_PERSONAL_UK_OLD;
> ```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

* –î–≤–æ—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –æ–¥–Ω–æ–≥–æ —Ü–µ—Ö—É –º–æ–∂—É—Ç—å –≤–≤–æ–¥–∏—Ç–∏ **—Å–≤–æ—ó** –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ–¥–Ω—ñ—î—ó –∫–æ–º–ø–∞–Ω—ñ—ó –π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É.
* –ö–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫—â–æ **–≤–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞–≤ —Å–≤—ñ–π –∑–∞–ø–∏—Å —Å—å–æ–≥–æ–¥–Ω—ñ** –¥–ª—è —Ç—ñ—î—ó —Å–∞–º–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó + unit.
* –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å —É –±–∞–∑—ñ –≥–∞—Ä–∞–Ω—Ç—É—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è.

---

–•–æ—á–µ—à, —è –¥–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ –≤–∏–Ω–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ (`–ó–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î ...`) —É –±–∞–≥–∞—Ç–æ–º–æ–≤–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç ‚Äî —â–æ–± APEX –º—ñ–≥ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –π–æ–≥–æ —è–∫ –∫—Ä–∞—Å–∏–≤–∏–π `apex.error.add_error` –∑ —ñ–∫–æ–Ω–∫–æ—é –∑–∞–º—ñ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —á–µ—Ä–≤–æ–Ω–æ–≥–æ –±–ª–æ–∫–∞?
