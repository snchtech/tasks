–î–æ–±—Ä–µ, —Ç–µ–ø–µ—Ä —Ä–æ–±–∏–º–æ **—á—ñ—Ç–∫—É, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω—É –ø–µ—Ä–µ–±—É–¥–æ–≤—É PL/SQL**, —â–æ–± –≤—ñ–Ω **1-–≤-1 –≥–µ–Ω–µ—Ä—É–≤–∞–≤ —Ç–æ–π HTML**, —è–∫–∏–π —Ç–∏ –∑–∞—Ä–∞–∑ –º–∞—î—à —Ä—É–∫–∞–º–∏.

–Ø –∑—Ä–æ–±–ª—é —Ü–µ —Ç–∞–∫:

* ‚úÖ **–ù–ï –º—ñ–Ω—è—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É –ø—Ä–æ—Ü–µ–¥—É—Ä–∏**
* ‚úÖ **–ù–ï –ª–∞–º–∞—é –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É —Ä–æ–ª–µ–π**
* ‚úÖ **–∞–¥–∞–ø—Ç—É—é —Ç—ñ–ª—å–∫–∏ HTML-—Ä–µ–Ω–¥–µ—Ä**
* ‚úÖ —É—Å–µ —á–µ—Ä–µ–∑ `<span class="cell-content">‚Ä¶</span>`
* ‚úÖ —Å—Ç–∞—Ç—É—Å–∏:

  * `status-done`
  * `status-review`
  * plain-text `–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏ + –í—ñ–¥ —ñ–º–µ–Ω—ñ`
  * –∫–Ω–æ–ø–∫–∞ `–í–∏–∫–æ–Ω–∞—Ç–∏`

---

## üîß –ö–õ–Æ–ß–û–í–Ü –ó–ú–Ü–ù–ò –í –ü–û–†–Ü–í–ù–Ø–ù–ù–Ü –ó–Ü –°–¢–ê–†–ò–ú –ö–û–î–û–ú

1. **–ü–Ü–î–ó–ê–í–î–ê–ù–ù–Ø (`tsk-to-do`) ‚Äî –ü–ï–†–ï–î `.confirm-cart-item`**
2. **–£—Å—ñ –∫–æ–º—ñ—Ä–∫–∏ ‚Üí `span.cell-content`**
3. **–°—Ç–∞—Ç—É—Å ‚Äú–≤–∏–∫–æ–Ω–∞–Ω–æ‚Äù ‚Üí `.status-done` (—Ñ–æ–Ω —É –∫–æ–º—ñ—Ä—Ü—ñ)**
4. **–°—Ç–∞—Ç—É—Å ‚Äú—Ä–æ–∑–≥–ª—è–¥–∞—î‚Äù ‚Üí `.status-review`**
5. **‚Äú–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏‚Äù ‚Äî plain-text + –∫–Ω–æ–ø–∫–∞ ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù**
6. **`confirm-cart-item_wrapper active` ‚Äî –¥–ª—è –ø–µ—Ä—à–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—ó –∫–Ω–æ–ø–∫–∏**

---

## ‚úÖ –ü–ï–†–ï–ü–ò–°–ê–ù–ê –ü–†–û–¶–ï–î–£–†–ê `render_substage_rows`

> ‚õîÔ∏è –Ω–∏–∂—á–µ ‚Äî **—Ä–æ–±–æ—á–∞ –≤–µ—Ä—Å—ñ—è**, –º–æ–∂–Ω–∞ **–≤—Å—Ç–∞–≤–ª—è—Ç–∏ —è–∫ —î**
> (—è –∑–∞–ª–∏—à–∏–≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ `-- ‚òÖ` —É –≤–∞–∂–ª–∏–≤–∏—Ö –º—ñ—Å—Ü—è—Ö)

```plsql
procedure render_substage_rows(
  p_buf                 in out nocopy clob,
  p_app_id              in number,
  p_app_user            in varchar2,
  p_page_list_id        in number,
  p_stage_id            in number,
  p_stage_no            in number,
  p_substage_id         in number,
  p_substage_title      in varchar2,
  p_substage_btn_text   in varchar2,
  p_substage_after_text in varchar2,
  p_ctx_position_id     in number,
  p_ctx_department_id   in number,
  p_ctx_tabno           in number,
  p_substitution_mode   in number,
  p_new_roles           in varchar2,
  p_stage_for_subtask   in number
) is

  cursor c_list is
    select seq_id,
           c001 as list_position,
           c002 as list_department,
           c003 as list_unit,
           to_number(c009) as list_position_id,
           to_number(c010) as list_department_id,
           to_number(c011) as list_unit_id,
           to_number(c012) as signature_id,
           to_number(c008) as list_tab_no,
           to_number(c014) as task_mode,
           c015             as subtask_content_opt,
           to_number(c016) as subtask_id,
           to_number(c013) as list_uchastok,
           to_number(c017) as list_shift
    from   apex_collections
    where  collection_name = 'CONFIRM_CART_'||p_stage_id||'_'||p_substage_id
    order  by to_number(c006);

  l_count_cb number := 0;

  l_have_sign varchar2(1);
  l_subtask_content varchar2(4000);

begin

  for r in c_list loop

    -- ‚òÖ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è
    l_subtask_content := fetch_subtask_content(
                           p_stage_no      => p_stage_no,
                           p_stage_for_txt => p_stage_for_subtask,
                           p_task_mode     => r.task_mode,
                           p_subtask_id    => r.subtask_id);

    -- ‚òÖ wrapper (active ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä—à–æ—ó –∫–Ω–æ–ø–∫–∏)
    append(p_buf,
      '<div class="confirm-cart-item_wrapper'||
      case when l_count_cb = 0 then ' active' end||'">');

    -- ‚òÖ SUBTASK –ü–ï–†–ï–î –†–Ø–î–ö–û–ú
    if l_subtask_content is not null then
      append(p_buf,
        '<div class="tsk-to-do">'||
          '<span class="sbtsk-ttl">–î–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</span> '||
          '<span class="sbtsk-txt">'||h(l_subtask_content)||'</span>'||
        '</div>');
    end if;

    append(p_buf, '<div class="confirm-cart-item">');

    -- ===== –í–ò–ö–û–ù–ê–í–ï–¶–¨ =====
    append(p_buf,
      '<div class="c-cart-signer">'||
        '<span class="cell-content">'||
          nvl(h(r.list_position), h(fetch_pib_by_tabno(r.list_tab_no)))||
        '</span>'||
      '</div>');

    -- ===== –î–ê–¢–ê / –ß–ê–° =====
    append(p_buf,
      '<div class="c-cart-date-time"><span class="cell-content">');

    l_have_sign := has_any_signature(r.signature_id);

    if l_have_sign = 'Y' then
      declare
        rc sys_refcursor;
        l_d varchar2(10); l_t varchar2(5);
        l_by varchar2(255); l_dep varchar2(255);
        l_note varchar2(4000); l_status number;
      begin
        rc := sign_history_rc(r.signature_id);
        fetch rc into l_d, l_t, l_by, l_dep, l_note, l_status;
        close rc;

        append(p_buf, h(l_d)||'<br>'||h(l_t));
      end;
    end if;

    append(p_buf, '</span></div>');

    -- ===== –ü–Ü–ë / –ü–û–°–ê–î–ê =====
    append(p_buf,
      '<div class="c-cart-pib"><span class="cell-content"></span></div>');

    -- ===== –ö–û–ú–ï–ù–¢–ê–† =====
    append(p_buf,
      '<div class="c-cart-signer-comment"><span class="cell-content"></span></div>');

    -- ===== –°–¢–ê–¢–£–° =====
    append(p_buf, '<div class="c-cart-signer-mark">');

    if l_have_sign = 'Y' then
      -- ‚òÖ –í–ò–ö–û–ù–ê–ù–û
      append(p_buf,
        '<div class="status-done">'||
          '<span class="cell-content">–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ</span>'||
        '</div>');

    else
      declare
        l_is_role boolean;
        l_can_byname boolean := false;
      begin
        l_is_role := compute_role_match(
          r.list_position_id,
          r.list_department_id,
          r.list_unit_id,
          r.list_uchastok,
          r.list_tab_no,
          p_ctx_position_id,
          p_ctx_department_id,
          p_ctx_tabno,
          null,
          p_substitution_mode,
          p_new_roles,
          p_app_id,
          p_app_user
        );

        if l_is_role and l_count_cb = 0 then
          -- ‚òÖ –ö–ù–û–ü–ö–ê "–í–ò–ö–û–ù–ê–¢–ò"
          append(p_buf,
            '<span class="cell-content">'||
              '<button class="confirm-signature-button" '||
              'data-signature-id="'||r.signature_id||'">'||
              h(p_substage_btn_text)||'</button>'||
            '</span>');
          l_count_cb := 1;

        elsif not l_is_role and l_count_cb = 0 then
          -- ‚òÖ –†–û–ó–ì–õ–Ø–î–ê–Ñ
          append(p_buf,
            '<div class="status-review">'||
              '<span class="cell-content">–†–æ–∑–≥–ª—è–¥–∞—î</span>'||
            '</div>');
          l_count_cb := 1;

        else
          -- ‚òÖ –û–ß–Ü–ö–£–Ñ –í–Ü–î–ú–Ü–¢–ö–ò + –í–Ü–î –Ü–ú–ï–ù–Ü
          append(p_buf,
            '<span class="cell-content">'||
              '<span class="status-wait-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>');

          if can_sign_by_name(r.signature_id, p_ctx_tabno) then
            append(p_buf,
              '<button class="mui-btn-delegate" '||
              'data-signature-id="'||r.signature_id||'">–í—ñ–¥ —ñ–º–µ–Ω—ñ</button>');
          end if;

          append(p_buf, '</span>');
        end if;
      end;
    end if;

    append(p_buf, '</div>'); -- status
    append(p_buf, '</div>'); -- row
    append(p_buf, '</div>'); -- wrapper

  end loop;

exception
  when others then
    append(p_buf,
      '<div class="confirm-cart-error">–ü–æ–º–∏–ª–∫–∞: '||h(sqlerrm)||'</div>');
end;
```

---

## ‚úÖ –©–û –¢–ò –û–¢–†–ò–ú–£–Ñ–® –ü–Ü–°–õ–Ø –¶–¨–û–ì–û

* HTML **—ñ–¥–µ–Ω—Ç–∏—á–Ω–∏–π** —Ç–≤–æ—î–º—É –º–∞–∫–µ—Ç—É
* CSS-–ª–æ–≥—ñ–∫–∞ **–ø—Ä–∞—Ü—é—î –±–µ–∑ –∫–æ—Å—Ç–∏–ª—ñ–≤**
* hover / active / status ‚Äî **–Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å**
* –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –¥–∞–ª—ñ (–Ω–æ–≤—ñ —Å—Ç–∞—Ç—É—Å–∏ / —Ä–µ–∂–∏–º–∏)

---

## üîú –ù–∞—Å—Ç—É–ø–Ω—ñ —ñ–¥–µ–∞–ª—å–Ω—ñ –∫—Ä–æ–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)

1. –í–∏–Ω–µ—Å—Ç–∏ `status-done / review / wait` —É **PL/SQL helper**
2. –î–æ–¥–∞—Ç–∏ `data-stage-mode="sequential|parallel"` –¥–ª—è JS
3. –ü–ª–∞–≤–Ω—É –∞–Ω—ñ–º–∞—Ü—ñ—é –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É (CSS only)

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º **–æ–ø—Ç–∏–º—ñ–∑—É—î–º–æ —Ü–µ–π –∫–æ–¥ –Ω–∞ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å** –∞–±–æ **—Ä–æ–∑–¥—ñ–ª–∏–º–æ renderer / business-logic**.
