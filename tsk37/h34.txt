–¢–∞–∫, —Ç–∞–∫ –º–æ–∂–Ω–∞ üí°
–Ü —Ü–µ —è–∫—Ä–∞–∑ —Ö–æ—Ä–æ—à–∏–π –∫–æ–º–ø—Ä–æ–º—ñ—Å: **–¥–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ‚Äì –Ω–∞ —Ä—ñ–≤–Ω—ñ –ø–∞–∫–µ—Ç–∞**, –∞ **cursor c_due ‚Äì –ª–æ–∫–∞–ª—å–Ω–∏–π –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `instantiate_for_day`**.

–¢–æ–¥—ñ:

* –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä –º–µ–Ω—à–µ ¬´–ø–ª—É—Ç–∞—î—Ç—å—Å—è¬ª –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏;
* –∫—É—Ä—Å–æ—Ä —Å–ø–æ–∫—ñ–π–Ω–æ –∂–∏–≤–µ –≤ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ–π —Å–µ–∫—Ü—ñ—ó –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ —ñ –±–∞—á–∏—Ç—å —Ü—ñ —Ñ—É–Ω–∫—Ü—ñ—ó, –±–æ –≤–æ–Ω–∏ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≤ —Ç–æ–º—É –∂ package body.

---

## 1. –í–∏–Ω–æ—Å–∏–º–æ –¥–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ package body (–ø—Ä–∏–≤–∞—Ç–Ω—ñ)

–£ —Ç—ñ–ª—ñ –ø–∞–∫–µ—Ç–∞ (–ù–ï –≤ spec!), –¥–µ—Å—å –≤–∏—â–µ –∑–∞ `instantiate_for_day`, –¥–æ–¥–∞—î—à:

```plsql
  ---------------------------------------------------------------------------
  -- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º–∞—Å–æ–≤–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
  ---------------------------------------------------------------------------
  function apply_time(p_base date, p_time date) return date is
  begin
    if p_time is null then
      return p_base;
    else
      return trunc(p_base) + (p_time - trunc(p_time));
    end if;
  end apply_time;

  function iso_dow(p_d date) return number is
  begin
    -- –ü–Ω = 1 ‚Ä¶ –ù–¥ = 7
    return to_number(to_char(p_d, 'D', 'NLS_TERRITORY=UNITED KINGDOM'));
  end iso_dow;

  function exists_task(p_template_id number, p_planned_dt date) return boolean is
    l_dummy number;
  begin
    select 1
      into l_dummy
      from tasks
     where template_id = p_template_id
       and is_generated = 1
       and trunc(planning_date_start) = trunc(p_planned_dt)
       and ( planning_date_start = p_planned_dt
          or planning_date_start between p_planned_dt - 1/1440
                                     and p_planned_dt + 1/1440 );
    return true;
  exception
    when no_data_found then
      return false;
  end exists_task;
```

> –¶–µ **–ø—Ä–∏–≤–∞—Ç–Ω—ñ** —Ñ—É–Ω–∫—Ü—ñ—ó: —ó—Ö –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –≤ package spec, –≤–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—Å—å–æ–≥–æ `task_template_inst_pkg`.

---

## 2. –£—Å–µ—Ä–µ–¥–∏–Ω—ñ `instantiate_for_day` –ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ cursor + –∑–º—ñ–Ω–Ω—ñ

–¢–µ–ø–µ—Ä –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

```plsql
  procedure instantiate_for_day(
    p_run_date           in date   default trunc(sysdate),
    p_service_creator_id in number default null,
    p_default_status_id  in number default null
  ) is
    l_task_id number;

    cursor c_due is
      select
        t.id                                    as template_id,
        nvl(p_service_creator_id, t.creator_id) as creator_id,
        case
          when t.period_mode = 'WEEKLY' then apply_time(p_run_date, t.weekly_time)
          else                               apply_time(p_run_date, t.period_time)
        end as planned_dt
      from task_templates t
      where nvl(t.status_id, 0) <> 0
        and (t.date_end is null or t.date_end > p_run_date)
        and (t.period_start_date is null or t.period_start_date <= p_run_date)
        and (
              (t.period_mode = 'ONCE'
               and trunc(t.next_run_date) = trunc(p_run_date))
           or (t.period_mode = 'DAILY'
               and mod(
                     trunc(p_run_date)
                     - trunc(nvl(t.period_start_date, t.date_create)),
                     greatest(nvl(t.period_interval, 1), 1)
                   ) = 0)
           or (t.period_mode = 'WEEKLY'
               and exists (
                     select 1
                       from task_weekdays w
                      where w.template_id = t.id
                        and w.weekday     = iso_dow(p_run_date)
                   ))
            );
  begin
    for r in c_due loop
      if not exists_task(r.template_id, r.planned_dt) then
        instantiate_once(
          p_template_id => r.template_id,
          p_creator_id  => r.creator_id,
          p_now         => r.planned_dt,
          o_task_id     => l_task_id
        );

        if p_default_status_id is not null then
          update tasks
             set status_id  = p_default_status_id,
                 date_update = sysdate,
                 updator     = r.creator_id
           where id = l_task_id;
        end if;
      end if;
    end loop;

    commit;
  exception
    when others then
      rollback;
      raise;
  end instantiate_for_day;
```

–¢—É—Ç –≤–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏:

* `cursor c_due` **–æ–≥–æ–ª–æ—à–µ–Ω–∏–π –º—ñ–∂ `is` —ñ `begin`** ‚Äî —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –º—ñ—Å—Ü–µ.
* –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —É–∂–µ **–Ω–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏**, —Ç–æ–∂ –ø–∞—Ä—Å–µ—Ä –Ω–µ ¬´–ª–∞–º–∞—î –≥–æ–ª–æ–≤—É¬ª, –¥–µ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —è–∫–∞ `end;`.
* –£ –∫—É—Ä—Å–æ—Ä—ñ –º–∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–ª–∏–∫–∞—î–º–æ `apply_time`, `iso_dow`, `exists_task`, —è–∫—ñ —î –≤ —Ç–æ–º—É –∂ package body.

---

## –ß–æ–º—É —Ç–≤–æ—è –ø–æ–ø–µ—Ä–µ–¥–Ω—è –≤–µ—Ä—Å—ñ—è –º–æ–≥–ª–∞ –¥–∞–≤–∞—Ç–∏ LS-00103

1. –î–µ—Å—å –≤–∏—â–µ –≤ –ø–∞–∫–µ—Ç—ñ –º–æ–≥–ª–∞ –±—É—Ç–∏ –¥—Ä—ñ–±–Ω–∏—Ü—è: ‚Äú–∫—Ä–∞—Å–∏–≤–∏–π‚Äù —Å–∏–º–≤–æ–ª, –ø–æ–≥–∞–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è, –Ω–µ–≤–∏–¥–∏–º–∏–π —Å–∏–º–≤–æ–ª, –Ω–µ-ASCII —Ç–∏—Ä–µ ‚Äî —ñ –ø–∞—Ä—Å–µ—Ä –¥—É–º–∞–≤, —â–æ —Ç–∏ –≤—Å–µ —â–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó/–ø—Ä–æ—Ü–µ–¥—É—Ä–∏.
2. –õ–æ–∫–∞–ª—å–Ω—ñ –≤–∫–ª–∞–¥–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó + –∫—É—Ä—Å–æ—Ä —ñ–Ω–æ–¥—ñ –ø—Ä–æ–≤–æ–∫—É—é—Ç—å –¥–∏–≤–Ω—ñ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, –∫–æ–ª–∏ –¥–µ—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–æ `end` / `;` –Ω–µ –≤ —Ç–æ–º—É –º—ñ—Å—Ü—ñ, –¥–µ –ø–æ–∫–∞–∑—É—î –ø–æ–º–∏–ª–∫–∞.

–ü–µ—Ä–µ–Ω—ñ—Å—à–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–∞–≥–æ—Ä—É, –º–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–ø—Ä–æ—â—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `instantiate_for_day`, —ñ –ø–æ–º–∏–ª–∫–∞ **–∞–±–æ –∑–Ω–∏–∫–∞—î**, –∞–±–æ, —è–∫—â–æ —â–µ —â–æ—Å—å –Ω–µ —Ç–∞–∫, –ø–æ–∫–∞–∂–µ –≤–∂–µ —Ç–æ—á–Ω—ñ—à–µ –º—ñ—Å—Ü–µ.

---

–Ø–∫—â–æ –ø—ñ—Å–ª—è —Ç–∞–∫–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –≤—Å–µ –æ–¥–Ω–æ –±—É–¥–µ –ø–æ–º–∏–ª–∫–∞ —Å–∞–º–µ –Ω–∞ `cursor c_due` ‚Äî —Ç–æ–¥—ñ 99%, —â–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ü—ñ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ñ, –∞ **–≤ —è–∫–æ–º—É—Å—å `end;/comment` –≤–∏—â–µ –≤ –ø–∞–∫–µ—Ç—ñ**. –¢–æ–¥—ñ –º–æ–∂–Ω–∞ –±—É–¥–µ –ø—Ä–æ–±—ñ–≥—Ç–∏—Å—è –ø–æ –≤—Å—å–æ–º—É body, –∞–ª–µ, —à–≤–∏–¥—à–µ –∑–∞ –≤—Å–µ, –∑ —Ç–∞–∫–∏–º —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è–º –≤–æ–Ω–æ –≤–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å–∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è.
