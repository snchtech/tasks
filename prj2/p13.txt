–î–æ–±—Ä–µ üëç –∑—Ä–æ–±–∏–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç —ñ–∑ **–ª–æ–≥-—Ç–∞–±–ª–∏—Ü–µ—é**.
–¢–æ–¥—ñ —É –≤–∞—Å –±—É–¥—É—Ç—å:

* –æ—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ –≤ `prt_prot` —ñ `prt_n`;
* —ñ—Å—Ç–æ—Ä—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è job —É `prt_transfer_log`.

---

### üîπ 1. –õ–æ–≥-—Ç–∞–±–ª–∏—Ü—è

```sql
CREATE TABLE prt_transfer_log (
    id         NUMBER PRIMARY KEY,
    job_date   DATE,
    prot_id    NUMBER,
    row_count  NUMBER,
    status     VARCHAR2(20),
    error_msg  VARCHAR2(4000)
);
```

‚ö†Ô∏è –¢—É—Ç —Ç—Ä–µ–±–∞ sequence (–±–æ —Ü–µ —á–∏—Å—Ç–æ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ —Ç–∞–±–ª–∏—Ü—è):

```sql
CREATE SEQUENCE prt_transfer_log_seq START WITH 1 INCREMENT BY 1;
```

---

### üîπ 2. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫

```sql
CREATE OR REPLACE PROCEDURE job_transfer_data IS
    v_count NUMBER;
    v_id    prt_prot.id%TYPE;
BEGIN
    -- 1. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥–µ–Ω—å
    SELECT COUNT(*)
    INTO v_count
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 2. –í—Å—Ç–∞–≤–ª—è—î–º–æ —É prt_prot (id –≥–µ–Ω–µ—Ä—É—î —Ç—Ä–∏–≥–µ—Ä)
    INSERT INTO prt_prot (full_file_name, file_name, result, creator, create_date)
    VALUES ('text1',
            'text.sql',
            TO_CHAR(SYSDATE,'dd.mm.yyyy hh24:mi:ss') || ' + –î–æ–¥–∞–Ω–æ: ' || v_count,
            'PP',
            SYSDATE)
    RETURNING id INTO v_id;

    -- 3. –í—Å—Ç–∞–≤–ª—è—î–º–æ —É prt_n
    INSERT INTO prt_n (prt_prot_id, user_id, data_time, oznaka, creator, create_date, f_id)
    SELECT v_id,
           t.user_id,
           r.request_date,
           r.action_type_id,
           'PP',
           SYSDATE,
           kp.id
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 4. –õ–æ–≥ —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    INSERT INTO prt_transfer_log (id, job_date, prot_id, row_count, status)
    VALUES (prt_transfer_log_seq.NEXTVAL, SYSDATE, v_id, v_count, 'SUCCESS');

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        -- –õ–æ–≥ –∑ –ø–æ–º–∏–ª–∫–æ—é
        INSERT INTO prt_transfer_log (id, job_date, prot_id, row_count, status, error_msg)
        VALUES (prt_transfer_log_seq.NEXTVAL,
                SYSDATE,
                v_id,
                v_count,
                'FAILED',
                SUBSTR(SQLERRM, 1, 4000));
        ROLLBACK; -- —è–∫—â–æ —Ç—Ä–µ–±–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ —Ö–æ—á–∞ –± –∑–∞–ø–∏—Å —É log, –º–æ–∂–Ω–∞ COMMIT –ø–µ—Ä–µ–¥ ROLLBACK
        RAISE;
END;
/
```

---

### üîπ 3. –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è job (—á–µ—Ä–µ–∑ DBMS\_JOB –¥–ª—è Oracle 10g)

```sql
DECLARE
   v_job NUMBER;
BEGIN
   DBMS_JOB.SUBMIT (
      job       => v_job,
      what      => 'BEGIN job_transfer_data; END;',
      next_date => TRUNC(SYSDATE+1) + 2/24, -- –∑–∞–≤—Ç—Ä–∞ –æ 02:00
      interval  => 'TRUNC(SYSDATE+1) + 2/24'
   );
   COMMIT;
END;
/
```

---

‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:

* –£ `prt_prot` —ñ `prt_n` –¥–∞–Ω—ñ –ø–∏—à—É—Ç—å—Å—è, —è–∫ –∑–∞–¥—É–º–∞–Ω–æ.
* –£ `prt_transfer_log` –∑–∞–≤–∂–¥–∏ –±—É–¥–µ –∑–∞–ø–∏—Å:

  * `SUCCESS` –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ä—è–¥–∫—ñ–≤, —è–∫—â–æ –≤—Å–µ –≤—ñ–¥–ø—Ä–∞—Ü—é–≤–∞–ª–æ;
  * `FAILED` —ñ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –ø—Ä–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫.

---

–•–æ—á–µ—Ç–µ, —è —â–µ –ø—ñ–¥–∫–∞–∂—É –≤–∞—Ä—ñ–∞–Ω—Ç, —è–∫ **–∑–±–µ—Ä–µ–≥—Ç–∏ log –Ω–∞–≤—ñ—Ç—å –ø—Ä–∏ ROLLBACK** (—â–æ–± —É –±—É–¥—å-—è–∫–æ–º—É —Ä–∞–∑—ñ –∑–∞–ø–∏—Å —ñ–∑ –ø–æ–º–∏–ª–∫–æ—é –ª–∏—à–∞–≤—Å—è)?
