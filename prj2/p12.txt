–¢–∞–∫, —É PL/SQL (Oracle 10g —Ç–µ–∂) –º–æ–∂–Ω–∞ —ñ —Ç—Ä–µ–±–∞ –æ–±—Ä–æ–±–ª—è—Ç–∏ `EXCEPTION`.
–¶–µ —è–∫—Ä–∞–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º, —â–æ–±:

* –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏—Å—è –¥–∞–Ω—ñ –≤ `prt_n`);
* –∑–∞–ø–∏—Å–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤ –ª–æ–≥ (–∞–±–æ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å —É `prt_prot`);
* –≤–∏—Ä—ñ—à–∏—Ç–∏, —á–∏ —Ä–æ–±–∏—Ç–∏ `ROLLBACK` —á–∏ –∑–∞–ª–∏—à–∞—Ç–∏ —Ö–æ—á–∞ –± —á–∞—Å—Ç–∏–Ω—É –¥–∞–Ω–∏—Ö.

---

### üîπ –ü—Ä–∏–∫–ª–∞–¥ —ñ–∑ `prt_prot.transfer_status`

```sql
CREATE OR REPLACE PROCEDURE job_transfer_data IS
    v_count NUMBER;
    v_id    prt_prot.id%TYPE;
BEGIN
    -- —Ä–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
    SELECT COUNT(*)
    INTO v_count
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- –≤—Å—Ç–∞–≤–∫–∞ –≤ prt_prot –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º IN_PROGRESS
    INSERT INTO prt_prot (full_file_name, file_name, result, creator, create_date, transfer_status)
    VALUES ('text1',
            'text.sql',
            TO_CHAR(SYSDATE,'dd.mm.yyyy hh24:mi:ss') || ' + –î–æ–¥–∞–Ω–æ: ' || v_count,
            'PP',
            SYSDATE,
            'IN_PROGRESS')
    RETURNING id INTO v_id;

    -- –≤—Å—Ç–∞–≤–∫–∞ –≤ prt_n
    INSERT INTO prt_n (prt_prot_id, user_id, data_time, oznaka, creator, create_date, f_id)
    SELECT v_id,
           t.user_id,
           r.request_date,
           r.action_type_id,
           'PP',
           SYSDATE,
           kp.id
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- –≤—Å–µ –æ–∫ ‚Üí —Å—Ç–∞–≤–∏–º–æ DONE
    UPDATE prt_prot SET transfer_status = 'DONE' WHERE id = v_id;

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        -- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ ‚Üí –ø–∏—à–µ–º–æ —Å—Ç–∞—Ç—É—Å FAILED
        UPDATE prt_prot 
        SET transfer_status = 'FAILED',
            result = NVL(result, '') || ' | ERROR: ' || SQLERRM
        WHERE id = v_id;

        ROLLBACK; -- –∞–±–æ COMMIT, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ –ª–∏—à–∏—Ç–∏ —á–∞—Å—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ
        RAISE;    -- –ø—Ä–æ–±—Ä–æ—Å–∏–º–æ –ø–æ–º–∏–ª–∫—É –¥–∞–ª—ñ, —â–æ–± job —É –ª–æ–≥–∞—Ö —Ç–µ–∂ –±—É–ª–æ –≤–∏–¥–Ω–æ
END;
/
```

---

### üîπ –ü—Ä–∏–∫–ª–∞–¥ —ñ–∑ –ª–æ–≥-—Ç–∞–±–ª–∏—Ü–µ—é

```sql
EXCEPTION
    WHEN OTHERS THEN
        INSERT INTO prt_transfer_log (id, job_date, prot_id, row_count, status, error_msg)
        VALUES (prt_transfer_log_seq.NEXTVAL,
                SYSDATE,
                v_id,
                v_count,
                'FAILED',
                SUBSTR(SQLERRM,1,4000));
        ROLLBACK;
END;
```

---

‚úÖ –¢–∞–∫–∏–º —á–∏–Ω–æ–º –≤–∏ –∑–∞–≤–∂–¥–∏ –±—É–¥–µ—Ç–µ –∑–Ω–∞—Ç–∏:

* `DONE` ‚Äî –¥–∞–Ω—ñ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ñ;
* `FAILED` ‚Äî —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ (—É –ø–æ–ª—ñ `result` –∞–±–æ –ª–æ–≥-—Ç–∞–±–ª–∏—Ü—ñ —î —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏).

---

–•–æ—á–µ—Ç–µ, —è –∑—Ä–æ–±–ª—é —Ñ—ñ–Ω–∞–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é **–ø—Ä–æ—Ü–µ–¥—É—Ä–∏ –∑ –æ–±–æ–º–∞ –º–µ—Ö–∞–Ω—ñ–∑–º–∞–º–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ**: —ñ `transfer_status` —É `prt_prot`, —ñ `prt_transfer_log` –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó?
