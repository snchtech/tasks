–ë–∞—á—É –≤ —á–æ–º—É –ø—Ä–æ–±–ª–µ–º–∞ üëá

–ö–æ–ª–∏ —Ç–∏ –¥–æ–¥–∞–≤ `INSERT INTO`, —É —Ç–≤–æ—î–º—É –±–ª–æ—Ü—ñ `EXCEPTION` –∑–∞–ª–∏—à–∏–ª–∞—Å—è **—Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞/–ª–æ–≥—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞**, —á–µ—Ä–µ–∑ —â–æ —Å–∞–º PL/SQL-–ø—Ä–æ—Ü–µ—Å –ø–∞–¥–∞—î —ñ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î `error:` –∑–∞–º—ñ—Å—Ç—å `success:`.

---

### –û—Å–Ω–æ–≤–Ω—ñ –º–æ–º–µ–Ω—Ç–∏, —è–∫—ñ —Ç—Ä–µ–±–∞ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏

1. **–°–∏–Ω—Ç–∞–∫—Å–∏—Å**
   –£ —Ç–≤–æ—î–º—É –∫–æ–¥—ñ —î –ø—Ä–æ–ø—É—â–µ–Ω—ñ `;`, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (`1_ip` –∑–∞–º—ñ—Å—Ç—å `l_ip`, `1` –∑–∞–º—ñ—Å—Ç—å `lu.action_id('CHECK')` —Ç–æ—â–æ). –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ APEX –Ω–µ –º–æ–∂–µ —Å–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å.

2. **–õ–æ–≥—ñ–∫–∞ –≤ `EXCEPTION`**
   –£ –±–ª–æ—Ü—ñ `EXCEPTION` –º–æ–∂–Ω–∞ —Ä–æ–±–∏—Ç–∏ DML (INSERT), –∞–ª–µ –ø—ñ—Å–ª—è –Ω—å–æ–≥–æ **–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ** —Ç—Ä–µ–±–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä–∏—Ç–∏ JSON (`apex_json.open_object ‚Ä¶ apex_json.close_object`) —ñ `RETURN`.
   –Ø–∫—â–æ —Ç–∏ –Ω–µ –≤—ñ–¥–∫—Ä–∏—î—à JSON –ø–µ—Ä–µ–¥ `apex_json.write`, –∞–±–æ –∑–∞–ª–∏—à–∏—à –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –∫—É—Ä—Å–æ—Ä ‚Äî –ø—Ä–æ—Ü–µ—Å –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø–æ–º–∏–ª–∫–æ—é.

3. **–°–µ—Å—ñ—è**
   –Ø–∫—â–æ –≤ JSON —Ö–æ—á–µ—à –≤—ñ–¥–¥–∞–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–≤—ñ—Ç—å —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏, —Ç—Ä–µ–±–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –æ–±‚Äô—î–∫—Ç —è–≤–Ω–æ (`apex_json.open_object`).

---

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø—Ä–æ—Ü–µ—Å—É

```plsql
DECLARE
  l_user_id   users.user_id%TYPE;
  l_method    NUMBER;
BEGIN
  BEGIN
    WITH indata AS (
      SELECT :P2_NUMBER AS code, norm_nfc(:P2_NUMBER) AS code_nfc FROM dual
    )
    SELECT user_id, method
      INTO l_user_id, l_method
      FROM (
        SELECT n.user_id, 2 AS method, 1 AS ord
          FROM user_nfc n
          JOIN indata d ON n.nfc_id = d.code_nfc
        UNION ALL
        SELECT u.user_id, 1 AS method, 2 AS ord
          FROM users u
          JOIN indata d ON u.user_id = TO_NUMBER(d.code)
      )
     ORDER BY ord
     FETCH FIRST 1 ROW ONLY;

    -- —è–∫—â–æ –∑–Ω–∞–π—à–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Üí —Ç—É—Ç —ñ–Ω—à–∞ –≥—ñ–ª–∫–∞ (–Ω–µ –ø–æ–∫–∞–∑—É—é)

  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      -- –ª–æ–≥ –Ω–µ–≤–¥–∞—á—ñ
      INSERT INTO request_log(
        user_id,
        device_ip,
        action_type_id,
        request_date,
        device_session_id,
        user_agent_id,
        result_status_id,
        auth_method_id,
        raw_input
      ) VALUES (
        NULL,
        :x04,                -- device IP
        1,                   -- action_type_id (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ CHECK)
        SYSTIMESTAMP,
        v('APP_SESSION'),
        :x03,                -- user_agent_id
        2,                   -- FAIL
        NULL,
        :x02                 -- raw input
      );

      apex_json.open_object;
      apex_json.write('ok', false);
      apex_json.write('message', '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
      apex_json.close_object;
      RETURN;
  END;
END;
```

---

### –í–∞–∂–ª–∏–≤—ñ –Ω—é–∞–Ω—Å–∏

* **–ü–µ—Ä–µ–¥ `apex_json.write` –∑–∞–≤–∂–¥–∏ –≤–∏–∫–ª–∏–∫–∞–π `apex_json.open_object`.**
* –ü—ñ—Å–ª—è –∑–∞–ø–∏—Å—É –¥–∞–Ω–∏—Ö –∑–∞–∫—Ä–∏–≤–∞–π JSON: `apex_json.close_object`.
* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `RETURN;` –ø—ñ—Å–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è JSON, —â–æ–± –Ω–µ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞–≤—Å—è –∫–æ–¥ –Ω–∏–∂—á–µ.
* –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É –∫–æ–¥—ñ –∑–º—ñ–Ω–Ω—ñ –Ω–∞ –∫—à—Ç–∞–ª—Ç `1_ip` (—Ü–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–æ –Ω–µ–≤—ñ—Ä–Ω–æ). –¢—Ä–µ–±–∞ –∞–±–æ –±—Ä–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ `:x01 ‚Ä¶ :x04`, –∞–±–æ –∑ `:P2_NUMBER`.

---

### –ß–æ–º—É JS –∫–∏–¥–∞—î –≤ `error`

–Ø–∫—â–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –ø—Ä–æ—Ü–µ—Å –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –∑ **ORA-–ø–æ–º–∏–ª–∫–æ—é** (—Å–∏–Ω—Ç–∞–∫—Å–∏—Å, NULL —É NOT NULL –∫–æ–ª–æ–Ω–∫—É, –≤—ñ–¥—Å—É—Ç–Ω—è –¥—É–∂–∫–∞ —Ç–æ—â–æ), —Ç–æ APEX –Ω–µ –≤—ñ–¥–¥–∞—î JSON, –∞ –≤—ñ–¥–¥–∞—î HTML –∑—ñ —Å—Ç–µ–∫—Ç—Ä–µ–π—Å–æ–º ‚Üí –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ jQuery –±–∞—á–∏—Ç—å —Ü–µ —è–∫ "–ø–æ–º–∏–ª–∫–∞" —ñ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å —É `error:`.

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –≤–∏—â–µ (`open_object / close_object`, –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ) ‚Äî —É –≤–∏–ø–∞–¥–∫—É –Ω–µ–Ω–∞–π–¥–µ–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∫–ª—ñ—î–Ω—Ç –∑–∞–≤–∂–¥–∏ –±—É–¥–µ –≤ `success:` —ñ —Ç–∏ –∑–º–æ–∂–µ—à –æ–±—Ä–æ–±–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

---

–•–æ—á–µ—à, —è –∑–±–µ—Ä—É –ø–æ–≤–Ω–∏–π —Ä–æ–±–æ—á–∏–π –ø—Ä–∏–∫–ª–∞–¥ **—ñ –¥–ª—è success, —ñ –¥–ª—è fail** –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –¥–æ–≤—ñ–¥–Ω–∏–∫—ñ–≤ `action_type_id` / `result_status_id`, —â–æ–± –≤—ñ–Ω –±—É–≤ –æ–¥—Ä–∞–∑—É production-ready?
