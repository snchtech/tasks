–ß—É–¥–æ–≤–æ üëå, —Ç–æ–¥—ñ —Ç—Ä–µ–±–∞ —Ç—Ä–æ—Ö–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ –ø.2 —É –≤–∞—à—ñ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ñ.
–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ **—Å–∞–º—ñ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ `id` –∑ `seq_prt_prot`** (–∞ –Ω–µ –ø–æ–∫–ª–∞–¥–∞—Ç–∏—Å—è –Ω–∞ —Ç—Ä–∏–≥–µ—Ä), —Ç–æ —Å—Ö–µ–º–∞ —Ç–∞–∫–∞:

---

### üîπ –û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥ (—Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø.2)

```sql
DECLARE
    v_count NUMBER;
    v_id    prt_prot.id%TYPE;
BEGIN
    -- 1. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥–µ–Ω—å
    SELECT COUNT(*)
    INTO v_count
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 2. –ì–µ–Ω–µ—Ä—É—î–º–æ id –∑ sequence
    SELECT seq_prt_prot.NEXTVAL INTO v_id FROM dual;

    -- 2a. –í—Å—Ç–∞–≤–∫–∞ —É prt_prot –∑ —É–∂–µ –≥–æ—Ç–æ–≤–∏–º id
    INSERT INTO prt_prot (id, full_file_name, file_name, result, creator, create_date)
    VALUES (v_id,
            'text1',
            'text.sql',
            TO_CHAR(SYSDATE,'dd.mm.yyyy hh24:mi:ss') || ' + –î–æ–¥–∞–Ω–æ: ' || v_count,
            'PP',
            SYSDATE);
```

---

### üîπ –ü–æ–≤–Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑ –ª–æ–≥–æ–º

```sql
CREATE OR REPLACE PROCEDURE job_transfer_data IS
    v_count NUMBER;
    v_id    prt_prot.id%TYPE;
BEGIN
    -- 1. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥–µ–Ω—å
    SELECT COUNT(*)
    INTO v_count
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 2. –û—Ç—Ä–∏–º—É—î–º–æ id –∑ sequence
    SELECT seq_prt_prot.NEXTVAL INTO v_id FROM dual;

    -- 2a. –í—Å—Ç–∞–≤–ª—è—î–º–æ —É prt_prot
    INSERT INTO prt_prot (id, full_file_name, file_name, result, creator, create_date)
    VALUES (v_id,
            'text1',
            'text.sql',
            TO_CHAR(SYSDATE,'dd.mm.yyyy hh24:mi:ss') || ' + –î–æ–¥–∞–Ω–æ: ' || v_count,
            'PP',
            SYSDATE);

    -- 3. –í—Å—Ç–∞–≤–ª—è—î–º–æ —É prt_n
    INSERT INTO prt_n (prt_prot_id, user_id, data_time, oznaka, creator, create_date, f_id)
    SELECT v_id,
           t.user_id,
           r.request_date,
           r.action_type_id,
           'PP',
           SYSDATE,
           kp.id
    FROM USER_SESSIONS t
    LEFT JOIN request_log r ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 4. –õ–æ–≥ —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    INSERT INTO prt_transfer_log (id, job_date, prot_id, row_count, status)
    VALUES (prt_transfer_log_seq.NEXTVAL, SYSDATE, v_id, v_count, 'SUCCESS');

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        -- –õ–æ–≥ –∑ –ø–æ–º–∏–ª–∫–æ—é
        INSERT INTO prt_transfer_log (id, job_date, prot_id, row_count, status, error_msg)
        VALUES (prt_transfer_log_seq.NEXTVAL,
                SYSDATE,
                v_id,
                v_count,
                'FAILED',
                SUBSTR(SQLERRM, 1, 4000));
        ROLLBACK; -- –º–æ–∂–Ω–∞ COMMIT –ø–µ—Ä–µ–¥ —Ü–∏–º, —è–∫—â–æ —Ç—Ä–µ–±–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ log
        RAISE;
END;
/
```

---

üëâ –¢–∞–∫–∏–º —á–∏–Ω–æ–º:

* ID –≤–∏ **–≥–µ–Ω–µ—Ä—É—î—Ç–µ —Å–∞–º—ñ** —á–µ—Ä–µ–∑ `seq_prt_prot.NEXTVAL`.
* –¶–µ–π `v_id` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ –¥–ª—è `prt_prot`, —ñ –¥–ª—è `prt_n`, —ñ –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è.
* `RETURNING INTO` –≤–∂–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω.

---

–•–æ—á–µ—Ç–µ, —è —â–µ –ø–æ–∫–∞–∂—É –≤–∞—Ä—ñ–∞–Ω—Ç, —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏ **–∑–∞–ø–∏—Å —É –ª–æ–≥ –Ω–∞–≤—ñ—Ç—å —É –≤–∏–ø–∞–¥–∫—É `ROLLBACK`** (—á–µ—Ä–µ–∑ –∞–≤—Ç–æ–Ω–æ–º–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é)?
