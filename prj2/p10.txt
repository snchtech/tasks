–î–æ–±—Ä–µ üëç
–Ø–∫—â–æ —É —Ç–∞–±–ª–∏—Ü—ñ `prt_prot` **id –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—Ä–∏–≥–µ—Ä–æ–º** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `BEFORE INSERT` –±–µ—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ sequence), —Ç–æ –¥–æ—Å—Ç—É–ø—É –¥–æ sequence –Ω–∞–ø—Ä—è–º—É –≤–∞–º –Ω–µ —Ç—Ä–µ–±–∞. –£ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –æ—Å—å —Ç–∞–∫:

---

### –í–∞—Ä—ñ–∞–Ω—Ç –∑ —Ç—Ä–∏–≥–µ—Ä–æ–º (–±–µ–∑ –≤–∏–∫–ª–∏–∫—É `NEXTVAL`)

```sql
CREATE OR REPLACE PROCEDURE job_transfer_data IS
    v_count NUMBER;
    v_id    prt_prot.id%TYPE; -- id –∑ prt_prot
BEGIN
    -- 1. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –≤—á–æ—Ä–∞
    SELECT COUNT(*)
    INTO v_count
    FROM USER_SESSIONS t
    LEFT JOIN request_log r 
           ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp 
           ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    -- 2. –í—Å—Ç–∞–≤–ª—è—î–º–æ —É prt_prot —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ id
    INSERT INTO prt_prot (full_file_name, file_name, result, creator, create_date)
    VALUES ('text1',
            'text.sql',
            TO_CHAR(SYSDATE,'dd.mm.yyyy hh24:mi:ss') || ' + –î–æ–¥–∞–Ω–æ: ' || v_count,
            'PP',
            SYSDATE)
    RETURNING id INTO v_id; -- —Ç—É—Ç —Å–ø—Ä–∞—Ü—é—î —Ç—Ä–∏–≥–µ—Ä —ñ –º–∏ –æ—Ç—Ä–∏–º–∞—î–º–æ id

    -- 3. –í—Å—Ç–∞–≤–ª—è—î–º–æ –≤—Å—ñ —Ä—è–¥–∫–∏ —É prt_n
    INSERT INTO prt_n (prt_prot_id, user_id, data_time, oznaka, creator, create_date, f_id)
    SELECT v_id,
           t.user_id,
           r.request_date,
           r.action_type_id,
           'PP',
           SYSDATE,
           kp.id
    FROM USER_SESSIONS t
    LEFT JOIN request_log r 
           ON r.user_session_row_id = t.id
    LEFT JOIN pp.pp_points kp 
           ON kp.id = r.id_pp_point
    WHERE TRUNC(r.request_date) = TRUNC(SYSDATE - 1);

    COMMIT;
END;
/
```

---

### –ó–∞–ø—É—Å–∫ —è–∫ JOB (Oracle 10g)

–£ 10g —â–µ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ **DBMS\_JOB** (DBMS\_SCHEDULER –≤–∂–µ —î, –∞–ª–µ —Å—Ç–∞—Ä—ñ —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é—Ç—å —á–µ—Ä–µ–∑ DBMS\_JOB).
–í–∞—Ä—ñ–∞–Ω—Ç —ñ–∑ `DBMS_JOB`:

```sql
DECLARE
   v_job NUMBER;
BEGIN
   DBMS_JOB.SUBMIT (
      job       => v_job,
      what      => 'BEGIN job_transfer_data; END;',
      next_date => TRUNC(SYSDATE+1) + 2/24, -- –∑–∞–≤—Ç—Ä–∞ –æ 02:00
      interval  => 'TRUNC(SYSDATE+1) + 2/24' -- —â–æ–¥–Ω—è –æ 02:00
   );
   COMMIT;
END;
/
```

---

‚úÖ –£ —Ü—å–æ–º—É –≤–∞—Ä—ñ–∞–Ω—Ç—ñ:

* `id` –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è **—Ç—Ä–∏–≥–µ—Ä–æ–º** ‚Üí `RETURNING id INTO v_id` –ø—Ä–∞—Ü—é—î.
* –î–æ—Å—Ç—É–ø –¥–æ `sequence` –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω.
* –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ `DBMS_JOB` (—Å—É–º—ñ—Å–Ω–∏–π —ñ–∑ 10g), –∞–ª–µ –∑–∞ –±–∞–∂–∞–Ω–Ω—è –º–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏ `DBMS_SCHEDULER`.

---

–•–æ—á–µ—Ç–µ, —è –ø–æ–∫–∞–∂—É –ø—Ä–∏–∫–ª–∞–¥ **—Ç—Ä–∏–≥–µ—Ä–∞ –¥–ª—è prt\_prot**, —â–æ–± —É–ø–µ–≤–Ω–∏—Ç–∏—Å—å, —â–æ `RETURNING INTO` —Å–ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ —É –≤–∞—Å?
