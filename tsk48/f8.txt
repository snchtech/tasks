–ß—É–¥–æ–≤–æ, —Ç–æ–¥—ñ —Ä–æ–±–∏–º–æ **—á–∏—Å—Ç—É, —Ü—ñ–ª—ñ—Å–Ω—É –≤–µ—Ä—Å—ñ—é**, –±–µ–∑ `l_count_cb`, –±–µ–∑ ‚Äú–º–∞–≥—ñ—ó‚Äù, –∑ —á—ñ—Ç–∫–∏–º —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è–º –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç–µ–π.
–Ø –¥–∞–º **–≥–æ—Ç–æ–≤–∏–π –¥–æ –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–¥**, —Ä–æ–∑–±–∏—Ç–∏–π –ª–æ–≥—ñ—á–Ω–æ, —ñ –ø—Ä–æ–∫–æ–º–µ–Ω—Ç—É—é –∫–ª—é—á–æ–≤—ñ –º—ñ—Å—Ü—è.

---

# ‚úÖ –¶–Ü–õ–Ü–°–ù–ê –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê

## –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ (–≤–∞–∂–ª–∏–≤–æ –∑–∞–ø–∞–º‚Äô—è—Ç–∞—Ç–∏)

1. **–°—Ç–∞—Ç—É—Å–∏ ‚â† –∫–Ω–æ–ø–∫–∏**
2. **–ê–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø –∫–µ—Ä—É—î –≤—Å—ñ–º**
3. **‚Äú–†–æ–∑–≥–ª—è–¥–∞—î‚Äù ‚Äî —Ä—ñ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –µ—Ç–∞–ø**
4. **‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù ‚Äî —Ç—ñ–ª—å–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –µ—Ç–∞–ø—ñ**
5. **MAIN_SIGNER ‚Äî —Ç—ñ–ª—å–∫–∏ –≤ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ—Ü—ñ, –Ω–µ –≤ UI**

---

# 1Ô∏è‚É£ –û—Å–Ω–æ–≤–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (–Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä–µ–Ω–¥–µ—Ä–∞ –µ—Ç–∞–ø—É)

```plsql
-- –§–ª–∞–≥–∏ —Ä—ñ–≤–Ω—è –µ—Ç–∞–ø—É
l_stage_has_current    BOOLEAN := FALSE; -- —á–∏ –≤–∂–µ —î "–†–æ–∑–≥–ª—è–¥–∞—î" –≤ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ
```

---

# 2Ô∏è‚É£ –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ SIGNATURERIGHTS

```plsql
DECLARE
   l_is_first_active_row BOOLEAN := FALSE;
   l_show_sign_button    BOOLEAN := FALSE;
   l_can_byname          BOOLEAN := FALSE;
BEGIN
   ------------------------------------------------------
   -- 1. –í–∏–∑–Ω–∞—á–∞—î–º–æ –ü–ï–†–®–ò–ô –∞–∫—Ç–∏–≤–Ω–∏–π —Ä—è–¥–æ–∫ –µ—Ç–∞–ø—É
   ------------------------------------------------------
   IF p_is_active_stage AND NOT l_stage_has_current THEN
      l_is_first_active_row := TRUE;
      l_stage_has_current  := TRUE;
   END IF;

   ------------------------------------------------------
   -- 2. –ß–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –û–°–ù–û–í–ù–û–ì–û –ø—ñ–¥–ø–∏—Å—É
   ------------------------------------------------------
   IF p_is_active_stage THEN
      IF l_parallel THEN
         l_show_sign_button := l_is_role;
      ELSE
         l_show_sign_button := l_is_role AND l_is_first_active_row;
      END IF;
   END IF;

   ------------------------------------------------------
   -- 3. –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥–ø–∏—Å—É –∞–±–æ —Å—Ç–∞—Ç—É—Å—É
   ------------------------------------------------------
   IF l_show_sign_button THEN
      append(
         p_buf,
         '<button class="confirm-signature-button"
                  data-signature-id="'||l_signature_id||'">'
         || h(p_substage_btn_text) ||
         '</button>'
      );
   ELSE
      IF NOT p_is_active_stage THEN
         append(
            p_buf,
            '<span class="wait-confirm-signature-text">
               –û—á—ñ–∫—É—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –µ—Ç–∞–ø—ñ–≤
             </span>'
         );
      ELSIF l_is_first_active_row THEN
         append(
            p_buf,
            '<span class="wait-confirm-signature-text wait-confirm-signature-text-current">
               –†–æ–∑–≥–ª—è–¥–∞—î
             </span>'
         );
      ELSE
         append(
            p_buf,
            '<span class="wait-confirm-signature-text">
               –û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏
             </span>'
         );
      END IF;
   END IF;
```

---

# 3Ô∏è‚É£ –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ **‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù**

## 3.1 –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –û–¢—ñ–ó –≤–∏–∫–æ–Ω–∞–≤—Ü—è

```plsql
   l_list_kategoria_otiz NUMBER := NULL;

   BEGIN
      IF l_list_tab_no IS NOT NULL THEN
         SELECT t.kategoria_otiz
           INTO l_list_kategoria_otiz
           FROM kbs.personal@to_tasktracker10 t
          WHERE t.tab_no = l_list_tab_no
            AND t.priznak IS NULL;

      ELSIF l_list_position_id IS NOT NULL
         AND l_list_department_id IS NOT NULL THEN

         SELECT t.kategoria_otiz
           INTO l_list_kategoria_otiz
           FROM kbs.personal@to_tasktracker10 t
          WHERE t.dolznost = l_list_position_id
            AND t.tseh_id  = l_list_department_id
            AND (l_list_uchastok IS NULL OR t.uchastok = l_list_uchastok)
            AND t.priznak IS NULL
            AND ROWNUM = 1;
      END IF;
   EXCEPTION
      WHEN NO_DATA_FOUND THEN
         l_list_kategoria_otiz := NULL;
   END;
```

---

## 3.2 –í–∏–∫–ª–∏–∫ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏

```plsql
   BEGIN
      l_can_byname :=
         task_tracker_pkg.can_sign_by_other_personal(
            p_signature_user_id      => l_list_tab_no,
            p_signature_position_id  => l_list_position_id,
            p_signature_department   => l_list_department_id,
            p_signature_uchastok     => l_list_uchastok,
            p_signature_kategoria    => l_list_kategoria_otiz,
            p_cur_position_id        => l_cur_position_id,
            p_cur_department_id      => l_cur_department_id,
            p_cur_uchastok           => l_cur_uchastok,
            p_cur_kategoria          => l_cur_kategoria
         );
   EXCEPTION
      WHEN OTHERS THEN
         l_can_byname := FALSE;
   END;
```

---

## 3.3 –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–∫–∏ **‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù**

```plsql
   IF p_is_active_stage
      AND l_can_byname
      AND (l_parallel OR l_is_first_active_row)
   THEN
      append(
         p_buf,
         '<button type="button"
                  class="byname-signature-button"
                  data-signature-id="'||l_signature_id||'">
            –í—ñ–¥ —ñ–º–µ–Ω—ñ
          </button>'
      );
   END IF;

   append(p_buf, '</div>');
END;
```

---

# 4Ô∏è‚É£ –û–ù–û–í–õ–ï–ù–ê –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞

`CAN_SIGN_BY_OTHER_PERSONAL`

```plsql
FUNCTION can_sign_by_other_personal(
   p_signature_user_id     IN NUMBER,
   p_signature_position_id IN NUMBER,
   p_signature_department  IN NUMBER,
   p_signature_uchastok    IN NUMBER,
   p_signature_kategoria   IN NUMBER,
   p_cur_position_id       IN NUMBER,
   p_cur_department_id     IN NUMBER,
   p_cur_uchastok          IN NUMBER,
   p_cur_kategoria         IN NUMBER
) RETURN BOOLEAN
IS
   v_sign_pos NUMBER;
   v_sign_dep NUMBER;
   v_sign_uch VARCHAR2(100);
   v_sign_kat NUMBER;

   FUNCTION has_main_signer_role RETURN BOOLEAN IS
   BEGIN
      RETURN apex_acl.has_user_role(
         p_application_id => :APP_ID,
         p_user_name      => :APP_USER,
         p_role_static_id => 'MAIN_SIGNER'
      );
   END;
BEGIN
   ------------------------------------------------------
   -- –î–∞–Ω—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—è
   ------------------------------------------------------
   IF p_signature_user_id IS NOT NULL THEN
      SELECT dolznost, tseh_id, uchastok, kategoria_otiz
        INTO v_sign_pos, v_sign_dep, v_sign_uch, v_sign_kat
        FROM kbs.personal@to_tasktracker10
       WHERE tab_no = p_signature_user_id
         AND priznak IS NULL;

   ELSIF p_signature_position_id IS NOT NULL
      AND p_signature_department IS NOT NULL THEN

      SELECT dolznost, tseh_id,
             CASE
               WHEN p_signature_uchastok IS NULL THEN NULL
               ELSE uchastok
             END,
             kategoria_otiz
        INTO v_sign_pos, v_sign_dep, v_sign_uch, v_sign_kat
        FROM kbs.personal@to_tasktracker10
       WHERE dolznost = p_signature_position_id
         AND tseh_id  = p_signature_department
         AND (p_signature_uchastok IS NULL OR uchastok = p_signature_uchastok)
         AND priznak IS NULL
         AND ROWNUM = 1;
   ELSE
      RETURN FALSE;
   END IF;

   ------------------------------------------------------
   -- –£–º–æ–≤–∏ –¥–æ—Å—Ç—É–ø—É
   ------------------------------------------------------
   IF v_sign_dep = p_cur_department_id
      AND (p_signature_uchastok IS NULL OR v_sign_uch = p_cur_uchastok)
      AND (
            (v_sign_kat <> 1 AND p_cur_kategoria = 1)
         OR has_main_signer_role
          )
   THEN
      RETURN TRUE;
   END IF;

   RETURN FALSE;

EXCEPTION
   WHEN NO_DATA_FOUND THEN
      RETURN FALSE;
   WHEN OTHERS THEN
      RETURN FALSE;
END;
```

---

# üß™ –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ —Ç–µ–ø–µ—Ä –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞

| –°–∏—Ç—É–∞—Ü—ñ—è         | –†–µ–∑—É–ª—å—Ç–∞—Ç                    |
| ---------------- | ---------------------------- |
| –ê–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø    | ‚úî                            |
| –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –µ—Ç–∞–ø | –∫—ñ–ª—å–∫–∞ ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù           |
| –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π –µ—Ç–∞–ø | —Ç—ñ–ª—å–∫–∏ 1                     |
| –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø  | ‚ùå –∂–æ–¥–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫              |
| MAIN_SIGNER      | ‚úî –Ω–∞–≤—ñ—Ç—å –∫–µ—Ä—ñ–≤–Ω–∏–∫ ‚Üí –∫–µ—Ä—ñ–≤–Ω–∏–∫ |
| ‚Äú–†–æ–∑–≥–ª—è–¥–∞—î‚Äù      | —Ä—ñ–≤–Ω–æ 1                      |

---

## –•–æ—á–µ—à –¥–∞–ª—ñ:

* üîç **—Ç–∞–±–ª–∏—Ü—é —Ç–µ—Å—Ç-–∫–µ–π—Å—ñ–≤**
* üß© **–≤–∏–Ω–µ—Å—Ç–∏ —Ä–µ–Ω–¥–µ—Ä —É –ø—Ä–æ—Ü–µ–¥—É—Ä–∏**
* ‚ö° **–æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ SELECT-–∏**
* üß† **—Å—Ö–µ–º—É —Å—Ç–∞–Ω—ñ–≤ –µ—Ç–∞–ø—ñ–≤**

–ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏ üëå
