–û–∫–µ–π, —Ç–µ–ø–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∞ **–ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∫–ª–∞–ª–∞—Å—å** üëç
–¢—É—Ç –ø—Ä–æ–±–ª–µ–º–∞ **–Ω–µ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—ñ** —Ç–≤–æ–≥–æ –∞–≥—Ä–µ–≥–∞—Ç–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É ‚Äî –≤—ñ–Ω –ª–æ–≥—ñ—á–Ω–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π.
–ü—Ä–æ–±–ª–µ–º–∞ **–≤ —Ç–æ–º—É, –ù–ê–î –ß–ò–ú —Å–∞–º–µ —Ç–∏ –π–æ–≥–æ –≤–∏–∫–æ–Ω—É—î—à —ñ –Ø–ö Oracle 21 —Ü–µ –æ–ø—Ç–∏–º—ñ–∑—É—î**.

–Ø —Ä–æ–∑–∫–ª–∞–¥—É –ø–æ –ø–æ–ª–∏—á–∫–∞—Ö.

---

# üî¥ –ì–û–õ–û–í–ù–ê –ü–†–û–ë–õ–ï–ú–ê (–∫–æ—Ä—ñ–Ω—å –∑–ª–∞)

–¢–∏ **—Ä–∞—Ö—É—î—à –∞–≥—Ä–µ–≥–∞—Ç–∏ –Ω–∞–¥ view, —è–∫–µ:**

* –º—ñ—Å—Ç–∏—Ç—å **–ø–æ–ª—è –∑ DBLINK**
* –º—ñ—Å—Ç–∏—Ç—å **–ø—ñ–¥–∑–∞–ø–∏—Ç–∏ –∑ DBLINK —É—Å–µ—Ä–µ–¥–∏–Ω—ñ CASE**
* –º—ñ—Å—Ç–∏—Ç—å **EXISTS / NOT EXISTS –∑ DBLINK**
* –º—ñ—Å—Ç–∏—Ç—å **DATE + NULL-–ª–æ–≥—ñ–∫—É**
* —ñ –ø—Ä–∏ —Ü—å–æ–º—É **Oracle 21 –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è pushdown'–∏—Ç–∏ —á–∞—Å—Ç–∏–Ω—É –ª–æ–≥—ñ–∫–∏ –Ω–∞ Oracle 10**

üëâ –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ Oracle:

* –∞–Ω–∞–ª—ñ–∑—É—î **–í–°–Ü –∫–æ–ª–æ–Ω–∫–∏ view**
* –∞–Ω–∞–ª—ñ–∑—É—î **–í–°–Ü –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ –≤ CASE**
* –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è **–≤–∏–∫–æ–Ω–∞—Ç–∏ —á–∞—Å—Ç–∏–Ω—É EXISTS –≤—ñ–¥–¥–∞–ª–µ–Ω–æ**
* —ñ –Ω–∞—Ç–∏–∫–∞—î—Ç—å—Å—è –Ω–∞ **–Ω–µ—Å—É–º—ñ—Å–Ω—É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é**

–¢–æ–º—É:

```
ORA-02063: preceding line from <dblink>
```

–∞ —è–∫ ¬´–≤–∏–Ω–Ω—É¬ª –∫–æ–ª–æ–Ω–∫—É –ø–æ–∫–∞–∑—É—î **–ø–µ—Ä—à—É —Ç–µ–∫—Å—Ç–æ–≤—É –∑ view** (`DEP.SHORT_NAME`), –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∞ –Ω–µ –≤ SELECT.

---

# üß† –ß–æ–º—É –ë–ï–ó SUM() –≤—Å–µ –ø—Ä–∞—Ü—é—î

–ë–µ–∑ –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤:

* Oracle —Ä–æ–±–∏—Ç—å **row-by-row fetch**
* –Ω–µ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏
* –Ω–µ —Ä–æ–±–∏—Ç—å query rewrite
* –Ω–µ –∞–Ω–∞–ª—ñ–∑—É—î CASE –ø–æ–≤–Ω—ñ—Å—Ç—é

–ó `SUM(CASE WHEN ...)`:

* Oracle **–ø–æ–≤–∏–Ω–µ–Ω –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å**
* —Ç–æ–º—É –∞–Ω–∞–ª—ñ–∑—É—î:

  * –≤—Å—ñ WHEN
  * –≤—Å—ñ EXISTS
  * –≤—Å—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏
  * –≤—Å—ñ –∫–æ–ª–æ–Ω–∫–∏ view
* —ñ **–Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —á–∞—Å—Ç–∏–Ω—É –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞ remote**

---

# ‚ö†Ô∏è –ö–û–ù–ö–†–ï–¢–ù–Ü –ü–†–û–ë–õ–ï–ú–ù–Ü –ú–Ü–°–¶–Ø –£ –¢–í–û–Ñ–ú–£ –ö–û–î–Ü

## 1Ô∏è‚É£ EXISTS / NOT EXISTS –∑ DBLINK —É—Å–µ—Ä–µ–¥–∏–Ω—ñ CASE

–ù–∞–ø—Ä–∏–∫–ª–∞–¥:

```sql
AND NOT EXISTS (
  SELECT 1
  FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h
  WHERE h.signright_id = r_id
    AND h.new_status_id IS NOT NULL
)
```

üî¥ **–¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ** –¥–ª—è Oracle 21:

* EXISTS —É CASE
* –∞–≥—Ä–µ–≥–∞—Ç –∑–≤–µ—Ä—Ö—É
* DBLINK —É—Å–µ—Ä–µ–¥–∏–Ω—ñ

üëâ Oracle **–Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–Ω–µ—Å—Ç–∏ EXISTS —É remote**
üëâ Oracle 10 **–Ω–µ –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç–∞–∫–∏–π rewrite**
üëâ ORA-02063

---

## 2Ô∏è‚É£ –ó–º—ñ—à—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —ñ remote-—É–º–æ–≤

```sql
WHEN status_main_id <> 0
 AND (
      planning_date_end < SYSDATE
   OR EXISTS (SELECT 1 FROM remote_table@dblink ...)
 )
```

* `SYSDATE` ‚Äî –ª–æ–∫–∞–ª—å–Ω–∏–π
* `remote_table@dblink` ‚Äî remote
* Oracle 21 –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —Ü–µ **–æ–± º—î–¥–Ω–∞—Ç–∏**

üëâ –Ω–∞ Oracle 12 –ø—Ä–æ–∫–æ–≤—Ç—É–≤–∞–ª–æ—Å—å
üëâ –Ω–∞ Oracle 21 ‚Äî **–Ω—ñ**

---

## 3Ô∏è‚É£ CASE + DATE + NULL + DBLINK

```sql
WHEN planning_date_end < SYSDATE
 AND actual_date_end IS NULL
```

`actual_date_end` —É —Ç–µ–±–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å:

* –∞–±–æ –∑ remote
* –∞–±–æ –∑ –ø—ñ–¥–∑–∞–ø–∏—Ç—É –∑ remote

üëâ Oracle 21 –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è **–ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–∏–ø–∏ —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ —á–∞—Å—Ç–∫–æ–≤–æ –Ω–∞ remote**

---

# ‚úÖ –Ø–ö –ü–†–ê–í–ò–õ–¨–ù–û –¶–ï –í–ò–ü–†–ê–í–ò–¢–ò (—Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∞—Ü—é—î)

## üü¢ –ü–†–ê–í–ò–õ–û ‚Ññ1

üëâ **–£—Å—ñ –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó ‚Äî –¢–Ü–õ–¨–ö–ò –Ω–∞–¥ base-view**
üëâ **–ñ–û–î–ù–û–ì–û DBLINK —É—Å–µ—Ä–µ–¥–∏–Ω—ñ CASE**

---

## 1Ô∏è‚É£ –†–æ–∑—à–∏—Ä—é—î–º–æ `v_tasks_base` (—Ü–µ –∫–ª—é—á)

–¢–æ–±—ñ **–¢–†–ï–ë–ê –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –≤—Å—ñ –ª–æ–≥—ñ—á–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –ó–ê–ó–î–ê–õ–ï–ì–Ü–î–¨**, –±–µ–∑ EXISTS —É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É SUM.

### –î–æ–¥–∞—î–º–æ –≤ `v_tasks_base`:

```sql
CREATE OR REPLACE VIEW v_tasks_base AS
SELECT
    t.id AS task_id,
    t.page_list_id,
    t.status_main_id,
    t.planning_date_start,
    t.planning_date_end,
    ae.actual_date_end,

    /* ===== –ø—Ä–∞–ø–æ—Ä—Ü—ñ ===== */

    /* —á–∏ —î shift */
    CASE
      WHEN EXISTS (
        SELECT 1
        FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
        WHERE sr.task_id = t.id
          AND sr.shift_symbol_id IS NOT NULL
      )
      THEN 1 ELSE 0
    END AS has_shift,

    /* —á–∏ —î –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –µ—Ç–∞–ø–∏ */
    CASE
      WHEN EXISTS (
        SELECT 1
        FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r_prev
        WHERE r_prev.task_id = t.id
          AND NOT EXISTS (
            SELECT 1
            FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h2
            WHERE h2.signright_id = r_prev.id
              AND h2.new_status_id IS NOT NULL
          )
      )
      THEN 1 ELSE 0
    END AS has_open_prev_stage,

    /* –ø—Ä–æ–±–ª–µ–º–Ω–∞ */
    CASE
      WHEN t.planning_date_end < SYSDATE
       AND ae.actual_date_end IS NULL
      THEN 1 ELSE 0
    END AS is_problem

FROM TaskTracker.TASKS@TO_TASKTRACKER10 t
LEFT JOIN (
    SELECT sr3.task_id, MAX(h.signer_date) actual_date_end
    FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr3
    JOIN TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
      ON h.signright_id = sr3.id
    WHERE sr3.stages_id = 6
    GROUP BY sr3.task_id
) ae ON ae.task_id = t.id;
```

üîê –¢—É—Ç **–í–°–Ü EXISTS –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑**, –Ω–µ –≤ –∞–≥—Ä–µ–≥–∞—Ç—ñ.

---

## 2Ô∏è‚É£ –¢–µ–ø–µ—Ä —Ç–≤—ñ–π SUM —Å—Ç–∞—î –ë–ï–ó–ü–ï–ß–ù–ò–ú

```sql
SELECT
  SUM(CASE
        WHEN status_main_id <> 0
         AND (planning_date_end > SYSDATE OR actual_date_end IS NULL)
        THEN 1 ELSE 0
      END) AS CNT_PLANNED,

  SUM(CASE
        WHEN has_open_prev_stage = 1
        THEN 1 ELSE 0
      END) AS CNT_TODO,

  SUM(CASE
        WHEN has_shift = 1
        THEN 1 ELSE 0
      END) AS CNT_SHIFT,

  SUM(CASE
        WHEN is_problem = 1
        THEN 1 ELSE 0
      END) AS CNT_PROBLEM,

  SUM(CASE
        WHEN status_main_id = 0
        THEN 1 ELSE 0
      END) AS CNT_ARCHIVE

FROM v_tasks_base;
```

‚úÖ **–ñ–û–î–ù–û–ì–û DBLINK —É SELECT**
‚úÖ **Oracle 21 —â–∞—Å–ª–∏–≤–∏–π**
‚úÖ **ORA-02063 –∑–Ω–∏–∫–∞—î**

---

# üß† –ö–û–†–û–¢–ö–û –§–Ü–ù–ê–õ

üî¥ –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ SUM
üî¥ –ü—Ä–æ–±–ª–µ–º–∞ –≤ `SUM + CASE + EXISTS + DBLINK`

üü¢ –†—ñ—à–µ–Ω–Ω—è:

> **–≤–∏–Ω–µ—Å—Ç–∏ –≤—Å—é –ª–æ–≥—ñ–∫—É –∑ DBLINK —É base-view**,
> –∞ –∞–≥—Ä–µ–≥—É–≤–∞—Ç–∏ **—Ç—ñ–ª—å–∫–∏ —á–∏—Å–ª–æ–≤—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ**

---

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂—É:

* üîç –¥–æ–ø–æ–º–æ–≥—Ç–∏ **–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –í–°–Æ —Ç–≤–æ—é –ª–æ–≥—ñ–∫—É TODO / SHIFT / PROBLEM** —É base-view
* üß™ –ø–æ–∫–∞–∑–∞—Ç–∏, –¥–µ —Å–∞–º–µ Oracle 21 —Ä–æ–±–∏—Ç—å pushdown (EXPLAIN PLAN)
* üß± –∑—Ä–æ–±–∏—Ç–∏ —â–µ **–æ–∫—Ä–µ–º–∏–π analytic-view –¥–ª—è dashboard**

–°–∫–∞–∂–∏ üëç
