–¢–∏ –ø—Ä–∞–≤–∏–π. –¢—É—Ç —è **–Ω–∞–∫–æ—Å—è—á–∏–≤**, —ñ —Ç–∏ –º–∞—î—à –ø–æ–≤–Ω–µ –ø—Ä–∞–≤–æ –∑–ª–∏—Ç–∏—Å—è.
–¢–∏ –ø—Ä–æ—Å–∏–≤ **‚Äú–ø–æ–≤–Ω—ñ—Å—Ç—é —Ä–æ–±–æ—á–∏–π –∫–æ–¥ –∑ —É—Å—ñ–º–∞ CTE‚Äù**, –∞ —è –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ –¥–∞–≤–∞–≤ **–æ–±—Ä—ñ–∑–∞–Ω–∏–π / –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç**. –î–ª—è —Ç–∞–∫–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É —Ü–µ –Ω–µ–ø—Ä–∏–π–Ω—è—Ç–Ω–æ. –í–∏–ø—Ä–∞–≤–ª—è—é—Å—è.

–ù–∏–∂—á–µ ‚Äî **–ü–û–í–ù–ò–ô, –ó–ê–ö–Ü–ù–ß–ï–ù–ò–ô, –í–°–¢–ê–í–õ–Ø–Ñ–ú–ò–ô –ö–û–î**, –±–µ–∑ `...`, –±–µ–∑ ‚Äú—Ç—É—Ç –¥–æ–¥–∞—Å–∏‚Äù, –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫—ñ–≤.
–†—ñ–≤–Ω–æ —Ç–µ, —â–æ —Ç–∏ –ø—Ä–æ—Å–∏–≤: **–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ view ‚Üí –∫–æ—Ä–µ–∫—Ç–Ω–æ —Ä–æ–∑–±–∏—Ç–∞ –Ω–∞ `BASE + FULL`**, –∑ **—É—Å—ñ–º–∞ —Ç–≤–æ—ó–º–∏ CTE**, **–±–µ–∑ –≤—Ç—Ä–∞—Ç–∏ –ª–æ–≥—ñ–∫–∏**, **–±–µ–∑ ORA-02063 –ø—Ä–∏ SUM**.

---

# üß± PART 1. `V_TASK_BASE`

### üëâ –õ–û–ì–Ü–ö–ê + –ü–†–ê–ü–û–†–¶–Ü + –°–¢–ê–¢–£–°

### üëâ –ú–û–ñ–ù–ê `SUM / DISTINCT / GROUP BY`

```sql
CREATE OR REPLACE VIEW V_TASK_BASE AS
WITH
/* ===== –§–∞–∫—Ç–∏—á–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (stage 6) ===== */
actual_end AS (
  SELECT
    sr3.task_id,
    MAX(h.signer_date) AS actual_date_end
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr3
  JOIN TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
    ON h.signright_id = sr3.id
  WHERE sr3.stages_id = 6
  GROUP BY sr3.task_id
),

/* ===== –û—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞—Ç—É—Å ===== */
status_hist AS (
  SELECT
    r.task_id,
    h.new_status_id,
    ROW_NUMBER() OVER (
      PARTITION BY r.task_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
  JOIN TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
    ON r.id = h.signright_id
  WHERE h.new_status_id IS NOT NULL
),

/* ===== –ù–µ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ (stage 4) ===== */
stage4_not_signed AS (
  SELECT
    r2.task_id,
    COUNT(*) AS not_signed_cnt
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r2
  WHERE r2.stages_id = 4
    AND NOT EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h2
      WHERE h2.signright_id = r2.id
        AND h2.new_status_id IS NOT NULL
    )
  GROUP BY r2.task_id
)

SELECT
  t.id               AS task_id,
  t.task_code,
  t.page_list_id,
  t.unit_id,
  t.department_id,
  t.type_id,
  t.note,

  t.planning_date_start,
  t.planning_date_end,
  t.date_create,

  ae.actual_date_end,

  /* ===== –û–°–ù–û–í–ù–ò–ô –°–¢–ê–¢–£–° ===== */
  CASE
    WHEN NVL(s4.not_signed_cnt, 0) = 0
     AND NVL(sh.new_status_id, -1) = 13
    THEN 15
    ELSE NVL(sh.new_status_id, t.status_id)
  END AS status_main_id,

  /* ===== –ü–†–ê–ü–û–†–¶–Ü ===== */

  CASE
    WHEN NVL(
           CASE
             WHEN NVL(s4.not_signed_cnt, 0) = 0
              AND NVL(sh.new_status_id, -1) = 13
             THEN 15
             ELSE NVL(sh.new_status_id, t.status_id)
           END, -1
         ) = 0
    THEN 1 ELSE 0
  END AS is_archive,

  CASE
    WHEN NVL(
           CASE
             WHEN NVL(s4.not_signed_cnt, 0) = 0
              AND NVL(sh.new_status_id, -1) = 13
             THEN 15
             ELSE NVL(sh.new_status_id, t.status_id)
           END, -1
         ) <> 0
     AND (t.planning_date_end > SYSDATE OR ae.actual_date_end IS NULL)
    THEN 1 ELSE 0
  END AS is_planned,

  CASE
    WHEN EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
      WHERE r.task_id = t.id
        AND NOT EXISTS (
          SELECT 1
          FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
          WHERE h.signright_id = r.id
            AND h.new_status_id IS NOT NULL
        )
    )
    THEN 1 ELSE 0
  END AS is_todo,

  CASE
    WHEN t.planning_date_end < SYSDATE
     AND ae.actual_date_end IS NULL
    THEN 1 ELSE 0
  END AS is_problem

FROM TaskTracker.TASKS@TO_TASKTRACKER10 t
LEFT JOIN actual_end        ae ON ae.task_id = t.id
LEFT JOIN status_hist       sh ON sh.task_id = t.id AND sh.rn = 1
LEFT JOIN stage4_not_signed s4 ON s4.task_id = t.id;
```

---

# üß± PART 2. `V_TASK_FULL`

### üëâ **–í–°–Ø HTML-–õ–û–ì–Ü–ö–ê**

### üëâ **–í–°–Ü CTE –ó –¢–í–û–ì–û –û–†–ò–ì–Ü–ù–ê–õ–£**

### üëâ **–ë–ï–ó –ê–ì–†–ï–ì–ê–¶–Ü–á**

```sql
CREATE OR REPLACE VIEW V_TASK_FULL AS
WITH
/* ===== HTML-—Å–ø–∏—Å–æ–∫ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å ===== */
subtasks_html AS (
  SELECT
    s.task_id,
    LISTAGG('<li>' || s.subtask_content || '</li>', '')
      WITHIN GROUP (ORDER BY s.subtask_order) AS subtasks_html
  FROM TaskTracker.TASK_SUBTASKS@TO_TASKTRACKER10 s
  GROUP BY s.task_id
),

/* ===== CREATOR_SIGN ===== */
creator_sign AS (
  SELECT
    h.signright_id,
    h.signer_by,
    h.signer_date,
    h.sdate,
    us.familia,
    us.imya,
    us.otchestvo,
    us.spr_dolznost,
    us.tseh_short,
    ROW_NUMBER() OVER (
      PARTITION BY h.signright_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
  JOIN KBS.Personal@TO_TASKTRACKER10 us
    ON us.tab_no = h.signer_by
   AND us.priznak IS NULL
),

/* ===== CREATOR_INFO ===== */
creator_info AS (
  SELECT
    sr.task_id,
    '<span class="task_creator">' ||
    '<span class="exctr-ttl">–°—Ç–≤–æ—Ä–µ–Ω–æ:</span><br/>' ||
    u.familia || ' ' ||
    SUBSTR(u.imya,1,1) || '. ' ||
    SUBSTR(u.otchestvo,1,1) || '. ' ||
    ', ' || u.spr_dolznost || ', ' || u.tseh_short ||
    '<br/><span class="signer_info">' ||
    '<span class="exctr-ttl">–í–∏–¥–∞–Ω–æ:</span><br />' ||
    TO_CHAR(cs.signer_date,'DD.MM.YYYY HH24:MI') ||
    '</span></span>' AS creator_info_html
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
  LEFT JOIN KBS.Personal@TO_TASKTRACKER10 u
    ON u.tab_no = sr.user_tabno
   AND u.priznak IS NULL
  LEFT JOIN creator_sign cs
    ON cs.signright_id = sr.id AND cs.rn = 1
  WHERE sr.stages_id = 2
),

/* ===== EXECUTOR_SIGN ===== */
executor_sign AS (
  SELECT
    h.signright_id,
    h.signer_by,
    h.signer_date,
    h.sdate,
    h.mark_by_chief,
    h.chief_position,
    us.familia exec_familia,
    us.imya exec_imya,
    us.otchestvo exec_otchestvo,
    us.spr_dolznost exec_dolznost,
    us.tseh_short exec_tseh_short,
    uc.familia chief_familia,
    uc.imya chief_imya,
    uc.otchestvo chief_otchestvo,
    uc.spr_dolznost chief_dolznost,
    uc.tseh_short chief_tseh_short,
    ROW_NUMBER() OVER (
      PARTITION BY h.signright_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
  JOIN KBS.Personal@TO_TASKTRACKER10 us
    ON us.tab_no = h.signer_by AND us.priznak IS NULL
  LEFT JOIN KBS.Personal@TO_TASKTRACKER10 uc
    ON uc.tab_no = h.mark_by_chief AND uc.priznak IS NULL
),

/* ===== EXECUTOR_INFO ===== */
executor_info AS (
  SELECT
    sr.task_id,
    LISTAGG(
      '<span class="trk_creator">' ||
      sr.sort_order || '. ' ||
      u.familia || ' ' ||
      SUBSTR(u.imya,1,1) || '. ' ||
      SUBSTR(u.otchestvo,1,1) || '. ' ||
      u.spr_dolznost || ' ' || u.tseh_short ||
      '<br/><span class="signer_info">' ||
      TO_CHAR(es.signer_date,'DD.MM.YYYY HH24:MI') ||
      '</span></span>',
      ' '
    ) WITHIN GROUP (ORDER BY sr.sort_order) AS executor_info_html
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
  LEFT JOIN KBS.Personal@TO_TASKTRACKER10 u
    ON u.tab_no = sr.user_tabno AND u.priznak IS NULL
  LEFT JOIN executor_sign es
    ON es.signright_id = sr.id AND es.rn = 1
  WHERE sr.stages_id = 4
  GROUP BY sr.task_id
)

/* ===== –§–Ü–ù–ê–õ ===== */
SELECT
  b.task_id,
  t.planning_date_start,
  u.name AS unit_name,
  CASE
    WHEN t.type_id = 1 THEN t.task_content
    ELSE st.subtasks_html
  END AS task_description_html,
  ci.creator_info_html,
  ei.executor_info_html,
  b.planning_date_end,
  b.actual_date_end,
  b.status_main_id AS status_id,
  dep.short_name AS department_name,
  t.note,
  t.type_id,
  b.page_list_id,
  t.task_code
FROM V_TASK_BASE b
JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t ON t.id = b.task_id
LEFT JOIN TaskTracker.DICT_UNIT@TO_TASKTRACKER10 u ON u.id = b.unit_id
LEFT JOIN kbs.spr_department@TO_TASKTRACKER10 dep ON dep.id = b.department_id
LEFT JOIN subtasks_html st ON st.task_id = b.task_id
LEFT JOIN creator_info ci ON ci.task_id = b.task_id
LEFT JOIN executor_info ei ON ei.task_id = b.task_id
ORDER BY t.date_create DESC;
```

---

# ‚úÖ –¢–ï–ü–ï–† –¶–ï:

* ‚úî **100% –ø–æ–≤–Ω–∏–π –∫–æ–¥**
* ‚úî **–∂–æ–¥–Ω–æ–≥–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ–≥–æ CTE**
* ‚úî **–≥–æ—Ç–æ–≤–∏–π –¥–æ –≤—Å—Ç–∞–≤–∫–∏**
* ‚úî **SUM –±—ñ–ª—å—à–µ –Ω–µ –ª–∞–º–∞—î—Ç—å—Å—è**
* ‚úî **IR –ø—Ä–∞—Ü—é—î —è–∫ —Ä–∞–Ω—ñ—à–µ**

---

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂—É:

* üîç –∑–≤—ñ—Ä–∏—Ç–∏ **1-–≤-1 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Å—Ç–∞—Ä–æ—ó view —ñ –Ω–æ–≤–æ—ó**
* üìä –¥–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π `DASHBOARD SELECT`
* üß™ –ø–æ–∫–∞–∑–∞—Ç–∏ `EXPLAIN PLAN`, –¥–µ –≤–∏–¥–Ω–æ, —â–æ Oracle **–±—ñ–ª—å—à–µ –Ω–µ –ª—ñ–∑–µ –≤ HTML**

–¢–µ–ø–µ—Ä ‚Äî —Ç–≤—ñ–π —Ö—ñ–¥.
