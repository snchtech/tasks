–î–æ–±—Ä–µ, —Ç—É—Ç –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ **–¥–≤—ñ —Ä—ñ–∑–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏**, –∞–ª–µ –≤–æ–Ω–∏ –¥—É–∂–µ —Ç—ñ—Å–Ω–æ –ø–µ—Ä–µ–ø–ª–µ–ª–∏—Å—è —á–µ—Ä–µ–∑ `l_count_cb`, `p_is_active_stage` —ñ –∑–º—ñ—à—É–≤–∞–Ω–Ω—è **–ª–æ–≥—ñ–∫–∏ —Å—Ç–∞—Ç—É—Å—É** –∑ **–ª–æ–≥—ñ–∫–æ—é –∫–Ω–æ–ø–æ–∫**. –Ø —Ä–æ–∑–∫–ª–∞–¥—É –≤—Å–µ –ø–æ –ø–æ–ª–∏—á–∫–∞—Ö —ñ –¥–∞–º **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø—Ä–∞–≤–∫–∏**, –∞ –Ω–µ –∑–∞–≥–∞–ª—å–Ω—ñ –ø–æ—Ä–∞–¥–∏.

---

## 1Ô∏è‚É£ –ß–æ–º—É ‚Äú–†–æ–∑–≥–ª—è–¥–∞—î‚Äù / ‚Äú–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏‚Äù –ø–æ–≤–æ–¥—è—Ç—å—Å—è —Ö–∞–æ—Ç–∏—á–Ω–æ

### üî¥ –ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞

–£ —Ç–µ–±–µ –∑–∞—Ä–∞–∑:

* **`l_count_cb` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É –¥–ª—è —Ç—Ä—å–æ—Ö —Ä—ñ–∑–Ω–∏—Ö –∑–∞–¥–∞—á**

  1. –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è *–ø–µ—Ä—à–æ—ó –∫–Ω–æ–ø–∫–∏* —É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ–º—É –µ—Ç–∞–ø—ñ
  2. –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è, –¥–µ –ø–∏—Å–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å **¬´–†–æ–∑–≥–ª—è–¥–∞—î¬ª**
  3. –æ–±–º–µ–∂–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ **¬´–í—ñ–¥ —ñ–º–µ–Ω—ñ¬ª**

–¶–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏.
–ß–µ—Ä–µ–∑ —Ü–µ:

* –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –µ—Ç–∞–ø –º–æ–∂–µ **–Ω–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ ‚Äú–†–æ–∑–≥–ª—è–¥–∞—î‚Äù**
* –Ω–∞—Å—Ç—É–ø–Ω–∏–π –µ—Ç–∞–ø (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π) **–æ—Ç—Ä–∏–º—É—î –∫–Ω–æ–ø–∫—É ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù**
* —Å—Ç–∞—Ç—É—Å —ñ –∫–Ω–æ–ø–∫–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å ¬´–ø–µ—Ä–µ—ó–∂–¥–∂–∞—Ç–∏¬ª –º—ñ–∂ –µ—Ç–∞–ø–∞–º–∏

---

### üß† –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –º–æ–¥–µ–ª—å (—è–∫–∞ –≤ —Ç–µ–±–µ –≤–∂–µ *–º–∞–π–∂–µ* —î)

–î–ª—è **–∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ SIGNATURERIGHTS** —Ç—Ä–µ–±–∞ —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏:

| –ü–æ–Ω—è—Ç—Ç—è               | –©–æ —Ü–µ                          |
| --------------------- | ------------------------------ |
| `p_is_active_stage`   | –ß–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –ï–¢–ê–ü               |
| `l_parallel`          | –¢–∏–ø –µ—Ç–∞–ø—É                      |
| `l_is_my_signature`   | –¶–µ –º—ñ–π –ø—ñ–¥–ø–∏—Å                  |
| `l_is_first_in_stage` | –ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –µ—Ç–∞–ø—ñ |
| `l_can_sign_byname`   | –ß–∏ –º–æ–∂–Ω–∞ ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù           |

‚ùó **`l_count_cb` –Ω–µ –º–∞—î –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∏ –≤–∑–∞–≥–∞–ª—ñ**

---

## 1.1 –Ø–∫ –º–∞—î –≤–∏–∑–Ω–∞—á–∞—Ç–∏—Å—è —Å—Ç–∞—Ç—É—Å **"–†–æ–∑–≥–ª—è–¥–∞—î"**

### ‚úî –Ñ–î–ò–ù–ï –ø—Ä–∞–≤–∏–ª–æ

> **"–†–æ–∑–≥–ª—è–¥–∞—î" –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ —Ä—è–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –µ—Ç–∞–ø—É**

–ù–µ–∑–∞–ª–µ–∂–Ω–æ:

* –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π —á–∏ –Ω—ñ
* –º—ñ–π –ø—ñ–¥–ø–∏—Å —á–∏ –Ω—ñ

---

### üîß –ü—Ä–∞–≤–∫–∞ –ª–æ–≥—ñ–∫–∏ —Å—Ç–∞—Ç—É—Å—É

#### ‚ùå –ó–∞–±—É—Ç–∏

```plsql
l_count_cb
```

#### ‚úÖ –í–≤–µ—Å—Ç–∏

```plsql
l_is_first_active_row BOOLEAN;
```

–Ü –≤–∏—Å—Ç–∞–≤–ª—è—Ç–∏ **–û–î–ò–ù –†–ê–ó –Ω–∞ –µ—Ç–∞–ø**:

```plsql
IF p_is_active_stage AND NOT l_stage_has_current THEN
   l_is_first_active_row := TRUE;
   l_stage_has_current := TRUE;
ELSE
   l_is_first_active_row := FALSE;
END IF;
```

---

### üîß –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç—É—Å—É (—á—ñ—Ç–∫–æ)

```plsql
IF NOT p_is_active_stage THEN
   append(p_buf,
     '<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –µ—Ç–∞–ø—ñ–≤</span>'
   );

ELSIF l_is_first_active_row THEN
   append(p_buf,
     '<span class="wait-confirm-signature-text wait-confirm-signature-text-current">–†–æ–∑–≥–ª—è–¥–∞—î</span>'
   );

ELSE
   append(p_buf,
     '<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>'
   );
END IF;
```

üîπ **–¶–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–∏–±–µ—Ä–µ —Ç–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É ‚Ññ1**

---

## 2Ô∏è‚É£ –ß–æ–º—É ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –≤ –ù–ï–∞–∫—Ç–∏–≤–Ω–∏—Ö –µ—Ç–∞–ø–∞—Ö

### üî¥ –ü—Ä–∏—á–∏–Ω–∞

–ö–Ω–æ–ø–∫–∞ ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù:

* **–Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î `p_is_active_stage`**
* **–ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∞ –¥–æ `l_count_cb`**, —è–∫–∏–π –∑–ª–∞–º–∞–≤—Å—è —Ä–∞–Ω—ñ—à–µ

---

### ‚úÖ –ó–û–õ–û–¢–ï –ü–†–ê–í–ò–õ–û

> **"–í—ñ–¥ —ñ–º–µ–Ω—ñ" –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¢–Ü–õ–¨–ö–ò –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –µ—Ç–∞–ø—ñ**

---

### üîß –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞, –∞–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ —É–º–æ–≤–∞

```plsql
IF p_is_active_stage
AND l_can_byname
AND (
   l_parallel
   OR l_is_first_active_row
)
THEN
   append(p_buf,
     '<button type="button"
      class="byname-signature-button"
      data-signature-id="'||l_signature_id||'">–í—ñ–¥ —ñ–º–µ–Ω—ñ</button>'
   );
END IF;
```

‚úî –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π ‚Äî —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω
‚úî –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π ‚Äî –¥–ª—è –≤—Å—ñ—Ö
‚úî –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø ‚Äî –ù–Ü–ö–û–õ–ò

---

## 3Ô∏è‚É£ –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏: —Ä–æ–ª—å **MAIN_SIGNER**

–¢—É—Ç —Ç–∏ –º–∏—Å–ª–∏—à **–∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ** üëç
–†–æ–±–∏–º–æ —Ü–µ **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ CAN_SIGN_BY_OTHER_PERSONAL**, –∞ –Ω–µ –≤ UI.

---

### 3.1 –û—Ç—Ä–∏–º—É—î–º–æ —Ä–æ–ª—å

```plsql
FUNCTION has_main_signer_role
RETURN BOOLEAN IS
BEGIN
   RETURN apex_acl.has_user_role(
      p_application_id => :APP_ID,
      p_user_name      => :APP_USER,
      p_role_static_id => 'MAIN_SIGNER'
   );
END;
```

---

### 3.2 –ü–µ—Ä–µ–ø–∏—Å—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É

#### ‚ùå –ë—É–ª–æ

```plsql
AND v_sign_kat <> 1
AND p_cur_kategoria = 1
```

#### ‚úÖ –°—Ç–∞–ª–æ

```plsql
IF v_sign_dep = p_cur_department_id
AND (p_signature_uchastok IS NULL OR v_sign_uch = p_cur_uchastok)
AND (
      -- –ö–ª–∞—Å–∏—á–Ω–∞ –ª–æ–≥—ñ–∫–∞
      (v_sign_kat <> 1 AND p_cur_kategoria = 1)
   OR
      -- –ù–û–í–ê –ª–æ–≥—ñ–∫–∞
      (has_main_signer_role)
)
THEN
   RETURN TRUE;
END IF;
```

---

### üß† –©–æ —Ü–µ –¥–∞—î

| –°–∏—Ç—É–∞—Ü—ñ—è                                | –†–µ–∑—É–ª—å—Ç–∞—Ç |
| --------------------------------------- | --------- |
| –ö–µ—Ä—ñ–≤–Ω–∏–∫ (–û–¢—ñ–ó=1) ‚Üí –ø—ñ–¥–ª–µ–≥–ª–∏–π           | ‚úî         |
| –ö–µ—Ä—ñ–≤–Ω–∏–∫ ‚Üí –∫–µ—Ä—ñ–≤–Ω–∏–∫                     | ‚ùå         |
| **MAIN_SIGNER ‚Üí –±—É–¥—å-—Ö—Ç–æ –≤ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ** | ‚úî         |
| –Ü–Ω—à–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª                         | ‚ùå         |

---

## 4Ô∏è‚É£ –ü—ñ–¥—Å—É–º–æ–∫ (–∫–æ—Ä–æ—Ç–∫–æ)

### ‚ùå –©–æ –±—É–ª–æ –Ω–µ —Ç–∞–∫

* `l_count_cb` –∫–µ—Ä—É–≤–∞–≤ —É—Å—ñ–º
* —Å—Ç–∞—Ç—É—Å–∏ –∑–∞–ª–µ–∂–∞–ª–∏ –≤—ñ–¥ —Ä–æ–ª–µ–π
* –∫–Ω–æ–ø–∫–∞ ‚Äú–í—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è–ª–∞ –∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø

### ‚úÖ –©–æ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏

1. **–í–∏–Ω–µ—Å—Ç–∏ —Å—Ç–∞—Ç—É—Å–∏ –∑ –ª–æ–≥—ñ–∫–∏ –∫–Ω–æ–ø–æ–∫**
2. **"–†–æ–∑–≥–ª—è–¥–∞—î" = –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –µ—Ç–∞–ø—É**
3. **"–í—ñ–¥ —ñ–º–µ–Ω—ñ" = —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –µ—Ç–∞–ø**
4. **–†–æ–ª—å MAIN_SIGNER ‚Äî –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `CAN_SIGN_BY_OTHER_PERSONAL`**

---

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂—É:

* ‚úÇÔ∏è **–ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ —Ç–≤—ñ–π –∫–æ–¥ —Ü—ñ–ª–∫–æ–º (clean version)**
* üß™ **–¥–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é —Ç–µ—Å—Ç-–∫–µ–π—Å—ñ–≤**
* üß† **–∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω—É –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É –∫–∞—Ä—Ç–∫–∏ –≤—ñ–¥–º—ñ—Ç–æ–∫**

–°–∫–∞–∂–∏, –∫—É–¥–∏ —Ä—É—Ö–∞—î–º–æ—Å—è –¥–∞–ª—ñ üëå
