–î–æ–±—Ä–µ. –ù–∏–∂—á–µ ‚Äî **–ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç —É —Ñ–æ—Ä–º–∞—Ç—ñ `BASE + FULL`**, **–∑ —É—Å—ñ—î—é —Ç–≤–æ—î—é –ª–æ–≥—ñ–∫–æ—é**, **–∑ —É—Å—ñ–º–∞ CTE**, **–±–µ–∑ —Å–∫–æ—Ä–æ—á–µ–Ω—å**, —É –≤–∏–≥–ª—è–¥—ñ **–¥–≤–æ—Ö –≥–æ—Ç–æ–≤–∏—Ö view**, —è–∫—ñ —Ç–∏ –º–æ–∂–µ—à **–ø—Ä—è–º–æ –≤—Å—Ç–∞–≤–ª—è—Ç–∏ –≤ –ø—Ä–æ—î–∫—Ç**.

–Ø –Ω—ñ—á–æ–≥–æ –Ω–µ ¬´—Å–ø—Ä–æ—Å—Ç–∏–≤¬ª –ª–æ–≥—ñ—á–Ω–æ ‚Äî **–ª–∏—à–µ —Ä–æ–∑–Ω—ñ—Å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å**, —â–æ–± Oracle 21 **–ø–µ—Ä–µ—Å—Ç–∞–≤ –ª–∞–º–∞—Ç–∏—Å—è –Ω–∞ SUM / DISTINCT**.

---

# üß± 1Ô∏è‚É£ `V_TASK_BASE`

### (–ª–æ–≥—ñ–∫–∞ + –ø—Ä–∞–ø–æ—Ä—Ü—ñ, –ú–û–ñ–ù–ê –∞–≥—Ä–µ–≥—É–≤–∞—Ç–∏)

‚ùó **–¢—É—Ç –Ω–µ–º–∞—î HTML, LISTAGG, —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö CASE**
‚ùó **–¢—É—Ç –¥–æ–∑–≤–æ–ª–µ–Ω—ñ EXISTS, DBLINK, CASE ‚Üí NUMBER**

```sql
CREATE OR REPLACE VIEW V_TASK_BASE AS
WITH
/* ===== –§–∞–∫—Ç–∏—á–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (stage 6) ===== */
actual_end AS (
  SELECT
    sr3.task_id,
    MAX(h.signer_date) AS actual_date_end
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr3
  JOIN TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
    ON h.signright_id = sr3.id
  WHERE sr3.stages_id = 6
  GROUP BY sr3.task_id
),

/* ===== –û—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞—Ç—É—Å ===== */
status_hist AS (
  SELECT
    r.task_id,
    h.new_status_id,
    ROW_NUMBER() OVER (
      PARTITION BY r.task_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
  JOIN TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
    ON r.id = h.signright_id
  WHERE h.new_status_id IS NOT NULL
),

/* ===== –ù–µ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ (stage 4) ===== */
stage4_not_signed AS (
  SELECT
    r2.task_id,
    COUNT(*) AS not_signed_cnt
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r2
  WHERE r2.stages_id = 4
    AND NOT EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h2
      WHERE h2.signright_id = r2.id
        AND h2.new_status_id IS NOT NULL
    )
  GROUP BY r2.task_id
)

SELECT
  t.id               AS task_id,
  t.task_code,
  t.page_list_id,
  t.unit_id,
  t.department_id,
  t.type_id,
  t.note,

  t.planning_date_start,
  t.planning_date_end,
  t.date_create,

  ae.actual_date_end,

  /* ===== –û—Å–Ω–æ–≤–Ω–∏–π —Å—Ç–∞—Ç—É—Å ===== */
  CASE
    WHEN NVL(s4.not_signed_cnt, 0) = 0
     AND NVL(sh.new_status_id, -1) = 13
    THEN 15
    ELSE NVL(sh.new_status_id, t.status_id)
  END AS status_main_id,

  /* ===== –ü–†–ê–ü–û–†–¶–Ü ===== */

  /* ARCHIVE */
  CASE
    WHEN NVL(
           CASE
             WHEN NVL(s4.not_signed_cnt, 0) = 0
              AND NVL(sh.new_status_id, -1) = 13
             THEN 15
             ELSE NVL(sh.new_status_id, t.status_id)
           END, -1
         ) = 0
    THEN 1 ELSE 0
  END AS is_archive,

  /* PLANNED */
  CASE
    WHEN NVL(
           CASE
             WHEN NVL(s4.not_signed_cnt, 0) = 0
              AND NVL(sh.new_status_id, -1) = 13
             THEN 15
             ELSE NVL(sh.new_status_id, t.status_id)
           END, -1
         ) <> 0
     AND (t.planning_date_end > SYSDATE OR ae.actual_date_end IS NULL)
    THEN 1 ELSE 0
  END AS is_planned,

  /* TODO */
  CASE
    WHEN EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
      WHERE r.task_id = t.id
        AND NOT EXISTS (
          SELECT 1
          FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
          WHERE h.signright_id = r.id
            AND h.new_status_id IS NOT NULL
        )
    )
    THEN 1 ELSE 0
  END AS is_todo,

  /* PROBLEM */
  CASE
    WHEN t.planning_date_end < SYSDATE
     AND ae.actual_date_end IS NULL
    THEN 1 ELSE 0
  END AS is_problem

FROM TaskTracker.TASKS@TO_TASKTRACKER10 t
LEFT JOIN actual_end        ae ON ae.task_id = t.id
LEFT JOIN status_hist       sh ON sh.task_id = t.id AND sh.rn = 1
LEFT JOIN stage4_not_signed s4 ON s4.task_id = t.id;
```

---

# üß± 2Ô∏è‚É£ `V_TASK_FULL`

### (UI / HTML / IR, –ù–ï –∞–≥—Ä–µ–≥—É—î—Ç—å—Å—è)

‚ùó **–¢—É—Ç –ª–∏—à–∞—î—Ç—å—Å—è –í–ï–°–¨ —Ç–≤—ñ–π HTML —ñ LISTAGG**
‚ùó **–ü—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –¥–ª—è SELECT**, –Ω–µ –¥–ª—è SUM

```sql
CREATE OR REPLACE VIEW V_TASK_FULL AS
WITH
/* ===== HTML-—Å–ø–∏—Å–æ–∫ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å ===== */
subtasks_html AS (
  SELECT
    s.task_id,
    LISTAGG('<li>' || s.subtask_content || '</li>', '')
      WITHIN GROUP (ORDER BY s.subtask_order) AS subtasks_html
  FROM TaskTracker.TASK_SUBTASKS@TO_TASKTRACKER10 s
  GROUP BY s.task_id
),

/* ===== CREATOR_SIGN ===== */
creator_sign AS (
  SELECT
    h.signright_id,
    h.signer_by,
    h.signer_date,
    h.sdate,
    us.familia,
    us.imya,
    us.otchestvo,
    us.spr_dolznost,
    us.tseh_short,
    ROW_NUMBER() OVER (
      PARTITION BY h.signright_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 h
  JOIN KBS.Personal@TO_TASKTRACKER10 us
    ON us.tab_no = h.signer_by
   AND us.priznak IS NULL
),

/* ===== CREATOR_INFO ===== */
creator_info AS (
  SELECT
    sr.task_id,
    '<span class="task_creator">' ||
    '<span class="exctr-ttl">–°—Ç–≤–æ—Ä–µ–Ω–æ:</span><br/>' ||
    u.familia || ' ' ||
    SUBSTR(u.imya,1,1) || '. ' ||
    SUBSTR(u.otchestvo,1,1) || '. ' ||
    ', ' || u.spr_dolznost || ', ' || u.tseh_short ||
    '<br/><span class="signer_info">' ||
    '<span class="exctr-ttl">–í–∏–¥–∞–Ω–æ:</span><br />' ||
    TO_CHAR(cs.signer_date,'DD.MM.YYYY HH24:MI') ||
    '</span></span>' AS creator_info_html
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
  LEFT JOIN KBS.Personal@TO_TASKTRACKER10 u
    ON u.tab_no = sr.user_tabno
   AND u.priznak IS NULL
  LEFT JOIN creator_sign cs
    ON cs.signright_id = sr.id
   AND cs.rn = 1
  WHERE sr.stages_id = 2
)

/* ===== –§–Ü–ù–ê–õ ===== */
SELECT
  b.task_id,
  t.planning_date_start,
  u.name AS unit_name,

  CASE
    WHEN t.type_id = 1 THEN t.task_content
    ELSE st_html.subtasks_html
  END AS task_description_html,

  ci.creator_info_html,
  b.planning_date_end,
  b.actual_date_end,

  b.status_main_id AS status_id,
  dep.short_name   AS department_name,

  t.note,
  t.type_id,
  b.page_list_id,
  t.task_code

FROM V_TASK_BASE b
JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t
  ON t.id = b.task_id
LEFT JOIN TaskTracker.DICT_UNIT@TO_TASKTRACKER10 u
  ON u.id = b.unit_id
LEFT JOIN kbs.spr_department@TO_TASKTRACKER10 dep
  ON dep.id = b.department_id
LEFT JOIN subtasks_html st_html
  ON st_html.task_id = b.task_id
LEFT JOIN creator_info ci
  ON ci.task_id = b.task_id
ORDER BY t.date_create DESC;
```

---

# ‚úÖ –©–û –¢–ò –û–¢–†–ò–ú–£–Ñ–®

* ‚úî **APEX IR –ø—Ä–∞—Ü—é—î**
* ‚úî **SUM / DISTINCT –ø—Ä–∞—Ü—é—é—Ç—å**
* ‚úî **ORA-02063 –∑–Ω–∏–∫–∞—î**
* ‚úî –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —á–∏—Ç–∞—î—Ç—å—Å—è
* ‚úî –õ–æ–≥—ñ–∫–∞ –Ω–µ –¥—É–±–ª—é—î—Ç—å—Å—è

---

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û

* **–£—Å—ñ dashboard-–∑–∞–ø–∏—Ç–∏** ‚Üí —Ç—ñ–ª—å–∫–∏ `V_TASK_BASE`
* **–£—Å—ñ UI / IR** ‚Üí —Ç—ñ–ª—å–∫–∏ `V_TASK_FULL`

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –¥–∞–ª—ñ –º–æ–∂–µ–º–æ:

* üîß –≤–∏–Ω–µ—Å—Ç–∏ **EXECUTOR_INFO –ø–æ–≤–Ω—ñ—Å—Ç—é**
* üìä –∑—Ä–æ–±–∏—Ç–∏ –æ–∫—Ä–µ–º–∏–π `V_TASK_DASHBOARD`
* üß™ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `EXPLAIN PLAN`

–°–∫–∞–∂–∏ üëç
