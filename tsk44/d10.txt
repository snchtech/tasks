–°—É–ø–µ—Ä, —Ü–µ —è–∫—Ä–∞–∑ –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞—Ç–∏ üëç

–¢–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ **—Ä–æ–∑—à–∏—Ä–∏—Ç–∏ CTE `access_lvl3`** —â–µ –æ–¥–Ω—ñ—î—é –≥—ñ–ª–∫–æ—é `UNION ALL`, —è–∫–∞ –ø—ñ–¥—Ç—è–≥—É—î –≤—Å—ñ –∑–∞–¥–∞—á—ñ, –¥–µ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î –∞–≤—Ç–æ—Ä–æ–º (`TASKS.CREATOR_ID`).

–Ø –ø–æ–∫–∞–∂—É —Ç—ñ–ª—å–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç `access_lvl3` –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ç–æ–≥–æ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É, —è–∫–∏–π –º–∏ –≤–∂–µ –∑—ñ–±—Ä–∞–ª–∏.

---

### –û–Ω–æ–≤–ª–µ–Ω–∏–π `access_lvl3`

```sql
access_lvl3 AS (
  -- 3.1. –ü—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –ø–æ user_id —á–µ—Ä–µ–∑ ACL (task_access_control, level = 3)
  SELECT DISTINCT
    t.id AS task_id
  FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
  JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
    ON al.id = ac.access_level_id
  CROSS JOIN user_ctx uc
  JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t
    ON t.id = ac.task_id
  WHERE al.access_level = 3
    AND ac.user_id = uc.user_id

  UNION ALL

  -- 3.2. –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SIGNATURERIGHTS (user/position/dep/unit/uchastok)
  SELECT DISTINCT
    sr.task_id
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
  CROSS JOIN user_ctx uc
  WHERE
        sr.user_tabno   = uc.user_id
     OR (
          sr.position_id   = uc.position_id
      AND sr.department_id = uc.department_id
      AND (sr.unit_id    IS NULL OR sr.unit_id    = uc.unit_id)
      AND (sr.uchastok   IS NULL OR sr.uchastok   = uc.uchastok_id)
        )

  UNION ALL

  -- 3.3. –î–æ—Å—Ç—É–ø —è–∫ –ê–í–¢–û–† –∑–∞–≤–¥–∞–Ω–Ω—è (creator_id)
  SELECT DISTINCT
    t.id AS task_id
  FROM TaskTracker.TASKS@TO_TASKTRACKER10 t
  CROSS JOIN user_ctx uc
  WHERE t.creator_id = uc.user_id
),
```

> üîé –õ–æ–≥—ñ–∫–∞:
> *–¥–ª—è access level 3* —Ç–µ–ø–µ—Ä –≤–≤–∞–∂–∞—î–º–æ, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –∑–∞–¥–∞—á:
>
> * —è–∫—â–æ –π–æ–≥–æ —è–≤–Ω–æ –≤–∫–∞–∑–∞–Ω–æ –≤ `task_access_control` (al = 3),
> * –∞–±–æ –≤—ñ–Ω —Ñ—ñ–≥—É—Ä—É—î –≤ `SIGNATURERIGHTS`,
> * **–∞–±–æ** –≤—ñ–Ω —î `CREATOR_ID` —É `TASKS`.

–î–∞–ª—ñ –≤—Å–µ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —è–∫ –±—É–ª–æ:

```sql
task_access AS (
  SELECT DISTINCT task_id
  FROM (
    SELECT task_id FROM access_lvl1
    UNION ALL
    SELECT task_id FROM access_lvl2
    UNION ALL
    SELECT task_id FROM access_lvl3
  )
),
```

—ñ —Ä–µ—à—Ç–∞ CTE (`tasks_with_access`, `viewed_agg`, –≤–∫–ª–∞–¥–∫–∏ `planned_tab`/`todo_tab`/...) –ø—Ä–∞—Ü—é—î –±–µ–∑ –∑–º—ñ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –≤ `task_access` –∑‚Äô—è–≤–∏–ª–æ—Å—è –±—ñ–ª—å—à–µ `task_id` —Å–∞–º–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∞.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂–µ–º–æ –æ–∫—Ä–µ–º–æ –¥–æ–¥–∞—Ç–∏ –≤ —Å–∞–º –∑–≤—ñ—Ç –∫–æ–ª–æ–Ω–∫—É —Ç–∏–ø—É:

```sql
CASE WHEN t.creator_id = (SELECT user_id FROM user_ctx) THEN 1 ELSE 0 END AS is_author
```

—â–æ–±, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞—Ç–∏ ‚Äú—Å–≤–æ—ó‚Äù –∑–∞–¥–∞—á—ñ –∞–±–æ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–Ω–æ–ø–∫–∏ –≤ APEX.
