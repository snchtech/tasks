–ß—É–¥–æ–≤–æ ‚Äî —Ç–æ–¥—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ **Step 3: –ø–æ–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ `UNION ALL` –ø–æ —Ä–µ–∂–∏–º–∞—Ö (`:P1_TAB_MODE`)**, —â–æ–± –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä –Ω–∞—Ä–µ—à—Ç—ñ –ø–µ—Ä–µ—Å—Ç–∞–≤ ‚Äú–≤–∞—Ä–∏—Ç–∏ –±–æ—Ä—â —ñ–∑ —É—Å—å–æ–≥–æ –æ–¥—Ä–∞–∑—É‚Äù —ñ –ø–æ—á–∞–≤ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ **–º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –∫–æ–¥ –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏**.

–¶–ï –î–ê–Ñ –ù–ê–ô–ë–Ü–õ–¨–®–ò–ô –ü–†–ò–†–Ü–°–¢ –®–í–ò–î–ö–û–°–¢–Ü –ø—ñ—Å–ª—è Step 1‚Äì2, –±–æ Oracle:

* –ø–µ—Ä–µ—Å—Ç–∞—î –∑–º—É—à–µ–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤—Å—ñ OR-–≥—ñ–ª–∫–∏;
* –≤ –∫–æ–∂–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ –æ—Ç—Ä–∏–º—É—î **—Å–≤—ñ–π –ø–ª–∞–Ω**, –∞ –Ω–µ –æ–¥–∏–Ω ‚Äú–Ω–∞–π–≥—ñ—Ä—à–∏–π‚Äù –¥–ª—è –≤—Å—ñ—Ö;
* —Ä—ñ–∂–µ remote JOIN‚Äô–∏, —Ä–æ–±–∏—Ç—å push predicate, –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ—Ç—Ä—ñ–±–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏.

---

# üü© STEP 3 ‚Äî –ü–µ—Ä–µ–ø–∏—Å—É—î–º–æ –ª–æ–≥—ñ–∫—É –≤–∫–ª–∞–¥–æ–∫ (`PLANNED`, `TODO`, `SHIFT`, `PROBLEM`, `ARCHIVE`) –Ω–∞ `UNION ALL`

## üéØ –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

–ú–∏ –∑–∞–ª–∏—à–∞—î–º–æ:

* `user_ctx`
* `tasks_with_access` (–≤–∂–µ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∑ `is_overdue`, `is_incomplete`)
* `viewed_user` + `viewed_agg`

–¢–µ–ø–µ—Ä —Å—Ç–≤–æ—Ä–∏–º–æ **–±–∞–∑–æ–≤–∏–π SELECT**, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç—å –≤—Å—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑–∞–¥–∞—á—ñ:

```sql
base_tasks AS (
  SELECT
    t.task_id,
    t.planning_date_start,
    t.planning_date_end,
    t.actual_date_end,
    t.actual_date_end_info,
    t.unit_name,
    t.task_description_html,
    t.creator_info,
    t.executor_info,
    t.status_name,
    t.status_id,
    t.status_main_id,
    t.department_name,
    t.note,
    t.type_id,
    t.page_list_id,
    t.date_create,
    t.is_overdue,
    t.is_incomplete,
    COALESCE(v.viewed_html,
             '<span class="fa fa-circle text-muted" title="–ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> –ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ') AS viewed_by
  FROM tasks_with_access t
  LEFT JOIN viewed_agg v ON v.task_id = t.task_id
),
```

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –±—É–¥—É—î–º–æ **5 –æ–∫—Ä–µ–º–∏—Ö SELECT** ‚Äî –æ–¥–∏–Ω –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏.

---

# üüß 1) SELECT –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `PLANNED`

```sql
planned_tab AS (
  SELECT *,
    -- HTML-—ñ–∫–æ–Ω–∫–∏ –¥–ª—è PLANNED
    (
      CASE WHEN status_id = 10 THEN
        '<span class="t-Icon fa fa-tag" style="color:green;" title="–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è"></span>'
      ELSE '' END ||

      CASE WHEN status_id IN (12,13) THEN
        '<span class="t-Icon fa fa-wrench" style="color:blue;" title="–í —Ä–æ–±–æ—Ç—ñ"></span>'
      ELSE '' END ||

      CASE WHEN is_overdue = 1 THEN
        '<span class="t-Icon fa fa-clock-o" style="color:red;" title="–ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–µ"></span>'
      ELSE '' END ||

      CASE WHEN is_incomplete = 1 THEN
        '<span class="t-Icon fa fa-id-card-o" style="color:orange;" title="–ù–µ–¥–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–µ"></span>'
      ELSE '' END
    ) AS status_label,
    -- CSS-–∫–ª–∞—Å
    CASE
      WHEN status_id = 10 THEN 'new-rec'
      WHEN status_id IN (12,13) THEN 'action-rec'
      WHEN status_id = 14 THEN 'arch-rec'
      WHEN status_id = 15 THEN 'wait-rec'
    END AS row_css_class
  FROM base_tasks
  CROSS JOIN user_ctx uc
  WHERE
    :P1_TAB_MODE = 'PLANNED'
    AND status_main_id <> 0
    AND (
        (status_main_id <> 0 AND planning_date_end > SYSDATE)
     OR (status_main_id <> 0 AND actual_date_end IS NULL)
    )
),
```

---

# üüß 2) SELECT –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `TODO`

–£ TODO –≤–∫–ª–∞–¥—Ü—ñ –ø–æ–∫–∞–∑—É—î—à —Ç—ñ–ª—å–∫–∏ —Ç—ñ –∑–∞–¥–∞—á—ñ, –¥–µ:

* –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á = –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å –ø–æ—Ç–æ—á–Ω–æ–≥–æ –µ—Ç–∞–ø—É,
* –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —É SIGNATUREHISTORY –ø–æ —Ü—å–æ–º—É –µ—Ç–∞–ø—É,
* –≤—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –µ—Ç–∞–ø–∏ –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ.

–¢–≤–æ—è –ª–æ–≥—ñ–∫–∞ + –Ω–∞—à—ñ CTE:

```sql
todo_tab AS (
  SELECT *,
    NULL AS status_label,      -- TODO –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î —ñ–∫–æ–Ω–æ–∫ –Ω–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ
    'action-rec' AS row_css_class
  FROM base_tasks t
  JOIN user_ctx uc
  WHERE
    :P1_TAB_MODE = 'TODO'
    AND EXISTS (
        SELECT 1
        FROM tasktracker.signaturerights@to_tasktracker10 r
        WHERE r.task_id   = t.task_id
          AND r.user_tabno = uc.user_id
          AND NOT EXISTS (
              SELECT 1
              FROM tasktracker.signaturehistory@to_tasktracker10 h
              WHERE h.signright_id = r.id
                AND h.new_status_id IS NOT NULL
          )
          AND NOT EXISTS (
              SELECT 1
              FROM tasktracker.signaturerights@to_tasktracker10 r_prev
              WHERE r_prev.task_id = t.task_id
                AND r_prev.stages_id < r.stages_id
                AND NOT EXISTS (
                    SELECT 1
                    FROM tasktracker.signaturehistory@to_tasktracker10 h2
                    WHERE h2.signright_id = r_prev.id
                      AND h2.new_status_id IS NOT NULL
                )
          )
    )
),
```

---

# üüß 3) SELECT –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `SHIFT`

```sql
shift_tab AS (
  SELECT *,
    (
      CASE WHEN planning_date_start BETWEEN TO_DATE(:P0_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                      AND TO_DATE(:P0_SHIFT_END,'DD.MM.YYYY HH24:MI')
           THEN '<span class="t-Icon fa fa-play-circle" style="color:green;" title="–í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞ –∑–º—ñ–Ω—ñ"></span>'
      ELSE '' END ||

      CASE WHEN planning_date_end BETWEEN TO_DATE(:P0_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                    AND TO_DATE(:P0_SHIFT_END,'DD.MM.YYYY HH24:MI')
           THEN '<span class="t-Icon fa fa-stop-circle" style="color:red;" title="–ó–∞–∫—Ä–∏—Ç–∏ –Ω–∞ –∑–º—ñ–Ω—ñ"></span>'
      ELSE '' END ||

      CASE WHEN status_id = 10 THEN
        '<span class="t-Icon fa fa-tag" style="color:green;"></span>'
      ELSE '' END ||

      CASE WHEN status_id IN (12,13) THEN
        '<span class="t-Icon fa fa-wrench" style="color:blue;"></span>'
      ELSE '' END ||

      CASE WHEN is_overdue = 1 THEN
        '<span class="t-Icon fa fa-clock-o" style="color:darkred;"></span>'
      ELSE '' END ||

      CASE WHEN is_incomplete = 1 THEN
        '<span class="t-Icon fa fa-id-card-o" style="color:orange;"></span>'
      ELSE '' END
    ) AS status_label,
    'action-rec' AS row_css_class
  FROM base_tasks
  WHERE
    :P1_TAB_MODE = 'SHIFT'
    AND status_main_id <> 0
    AND (
         planning_date_start BETWEEN TO_DATE(:P0_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                AND TO_DATE(:P0_SHIFT_END,'DD.MM.YYYY HH24:MI')
      OR planning_date_end   BETWEEN TO_DATE(:P0_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                AND TO_DATE(:P0_SHIFT_END,'DD.MM.YYYY HH24:MI')
      OR EXISTS (
         SELECT 1 FROM tasktracker.signaturerights@... sr
         WHERE sr.task_id = task_id
           AND sr.shift_symbol_id = :PO_SHIFT_SYMBOL
        )
    )
),
```

---

# üüß 4) SELECT –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `PROBLEM`

–ü–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–º—ñ–Ω—é—î —Å—Ç–∞—Ä—É –ª–æ–≥—ñ–∫—É `EXISTS (...)`:

```sql
problem_tab AS (
  SELECT *,
    (
      CASE WHEN is_overdue = 1 THEN
        '<span class="t-Icon fa fa-clock-o" style="color:red;"></span>'
      ELSE '' END ||
      CASE WHEN is_incomplete = 1 THEN
        '<span class="t-Icon fa fa-id-card-o" style="color:orange;"></span>'
      ELSE '' END
    ) AS status_label,
    'wait-rec' AS row_css_class
  FROM base_tasks
  WHERE
    :P1_TAB_MODE = 'PROBLEM'
    AND status_main_id <> 0
    AND (is_overdue = 1 OR is_incomplete = 1)
),
```

---

# üüß 5) SELECT –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `ARCHIVE`

```sql
archive_tab AS (
  SELECT *,
    NULL AS status_label,
    'arch-rec' AS row_css_class
  FROM base_tasks
  WHERE
    :P1_TAB_MODE = 'ARCHIVE'
    AND status_main_id = 0
),
```

---

# üü© –§—ñ–Ω–∞–ª—å–Ω–∏–π SELECT —á–µ—Ä–µ–∑ UNION ALL

```sql
SELECT *
FROM (
    SELECT * FROM planned_tab
    UNION ALL
    SELECT * FROM todo_tab
    UNION ALL
    SELECT * FROM shift_tab
    UNION ALL
    SELECT * FROM problem_tab
    UNION ALL
    SELECT * FROM archive_tab
)
ORDER BY date_create DESC;
```

---

# üü¶ –©–æ –º–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø—ñ—Å–ª—è Step 1‚Äì3?

## ‚úî 1. **–û–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä –±–∞—á–∏—Ç—å 5 —Ä—ñ–∑–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**

–¶–µ –Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–∏–π –µ—Ñ–µ–∫—Ç:

* –¥–ª—è TODO –≤—ñ–Ω –Ω–µ —Ç–æ—Ä–∫–∞—î—Ç—å—Å—è SHIFT –ª–æ–≥—ñ–∫–∏,
* –¥–ª—è PLANNED –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î hundreds of EXISTS,
* –¥–ª—è PROBLEM –≤–∑–∞–≥–∞–ª—ñ –Ω–µ —á—ñ–ø–∞—î SIGNATURERIGHTS,
* –¥–ª—è ARCHIVE ‚Äî –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω.

## ‚úî 2. **–£—Å—ñ EXISTS –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω–æ—Å—Ç—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —É CTE**

## ‚úî 3. `VIEWED_BY` —Ä–∞—Ö—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —É CTE `viewed_agg`

## ‚úî 4. –ö–æ–¥ —Ç–µ–ø–µ—Ä —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–π —ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π

## ‚úî 5. APEX WITH-–∑–∞–ø–∏—Ç –≤—ñ–¥—á—É—Ç–Ω–æ –ø—Ä–∏—à–≤–∏–¥—à—É—î—Ç—å—Å—è:

### **–ó –¥–æ—Å–≤—ñ–¥—É ‚Äì √ó2‚Ä¶√ó6 —à–≤–∏–¥—à–µ** –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–¥–∞—á.

---

# ‚ùó –ì–æ—Ç–æ–≤—ñ –π—Ç–∏ –¥–∞–ª—ñ?

–ù–∞—Å—Ç—É–ø–Ω–∏–π (—ñ –æ—Å—Ç–∞–Ω–Ω—ñ–π) Step 4:

### üëâ –í–∏–Ω–µ—Å—Ç–∏ Access Control –ø–æ–≤–Ω—ñ—Å—Ç—é –≤ –æ–∫—Ä–µ–º–∏–π CTE

### üëâ –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –π–æ–≥–æ JOIN‚Äô–∏

### üëâ –ü–æ–∑–±–∞–≤–∏—Ç–∏ –ª–æ–≥—ñ—á–Ω–∏—Ö –¥—É–±–ª—é–≤–∞–Ω—å

–¶–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—é –≤—Å—å–æ–≥–æ –≥—ñ–≥–∞–Ω—Ç—Å—å–∫–æ–≥–æ –∑–∞–ø–∏—Ç—É.

–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ Step 4?
