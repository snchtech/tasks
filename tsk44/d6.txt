–û–∫–µ–π, —Ä—É—Ö–∞—î–º–æ—Å—å –¥–∞–ª—ñ ‚Äì —Ç–µ–ø–µ—Ä –ø—Ä–∏–±–µ—Ä–µ–º–æ –º–æ–Ω—Å—Ç—Ä–∞ `VIEWED_BY` –∑ –∫—É–ø–æ—é `SELECT ... FETCH FIRST ROW ONLY` —ñ –∑–∞–º—ñ–Ω–∏–º–æ –π–æ–≥–æ –Ω–∞ –æ–¥–∏–Ω –∞–∫—É—Ä–∞—Ç–Ω–∏–π CTE üí™

### –Ü–¥–µ—è Step 2

1. –†–æ–∑—à–∏—Ä—é—î–º–æ `user_ctx`, —â–æ–± —Ç–∞–º –±—É–ª–∏:

   * `substitution_mode` (0/1),
   * `has_shift_role` (–¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞–±–æ ‚Äú–Ω–æ–≤–æ–≥–æ‚Äù –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞).
2. –°—Ç–≤–æ—Ä—é—î–º–æ CTE `viewed_user`, —è–∫–∏–π:

   * –±–µ—Ä–µ **–≤—Å—ñ –ø–µ—Ä–µ–≥–ª—è–¥–∏** –¥–ª—è `user_ctx.user_id` –∑ `TASK_VIEWED`,
   * –ø—Ä–∏—î–¥–Ω—É—î `PERSONAL` (us ‚Äì —Ö—Ç–æ –ø–µ—Ä–µ–≥–ª—è–Ω—É–≤, us1 ‚Äì —è–∫—â–æ —î SUBSTITUTION_ID),
   * –≤—Ä–∞—Ö–æ–≤—É—î –∑–º—ñ–Ω—É, —è–∫—â–æ —î shift-role,
   * —Ñ–æ—Ä–º—É—î HTML-—Ä—è–¥–æ–∫ `viewed_html`.
3. –°—Ç–≤–æ—Ä—é—î–º–æ `viewed_agg`, —è–∫–∏–π:

   * –≤–∏–±–∏—Ä–∞—î **–ø–æ –æ–¥–Ω–æ–º—É** –ø–µ—Ä–µ–≥–ª—è–¥—É –Ω–∞ –∑–∞–¥–∞—á—É (`ROW_NUMBER() OVER (...)`).
4. –£ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É SELECT –ø—Ä–æ—Å—Ç–æ:

   * `COALESCE(v.viewed_html, '<span ...>–ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ</span>') AS VIEWED_BY`.

–ñ–æ–¥–Ω–∏—Ö –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö SELECT‚Äô—ñ–≤ —É SELECT-–±–ª–æ—Ü—ñ.

---

## 1. –û–Ω–æ–≤–ª–µ–Ω–∏–π `user_ctx`

–î–æ–¥–∞—î–º–æ `substitution_mode` —ñ `has_shift_role`:

```sql
WITH user_ctx AS (
  SELECT
    :PO_SUBSTITUTION_MODE AS substitution_mode,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID       ELSE :PO_CUR_USER_TABNO       END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID   ELSE :PO_CUR_USER_POSITION    END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID ELSE :PO_CUR_USER_DEPARTMENT  END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID       ELSE :PO_CUR_USER_UNIT        END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK      ELSE :PO_CUR_UCHASTOK         END AS uchastok_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_HAS_SHIFT_ROLE ELSE :PO_CUR_HAS_SHIFT_ROLE  END AS has_shift_role
  FROM dual
),
```

(—Ä–µ—à—Ç–∞ CTE –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫—Ä–æ–∫—É ‚Äì `tasks_with_access` –∑ `is_overdue`, `is_incomplete` ‚Äì –ª–∏—à–∞—é—Ç—å—Å—è —è–∫ –º–∏ –≤–∂–µ —Ä–æ–∑–ø–∏—Å–∞–ª–∏.)

---

## 2. –ù–æ–≤–∏–π CTE –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤: `viewed_user` + `viewed_agg`

### 2.1. `viewed_user`: —É—Å—ñ –ø–µ—Ä–µ–≥–ª—è–¥–∏ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

```sql
viewed_user AS (
  SELECT
    tv.task_id,
    tv.date_viewed,
    tv.substitution_id,
    uc.substitution_mode,
    uc.has_shift_role,

    -- —Ö—Ç–æ —Ñ–∞–∫—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≥–ª—è–Ω—É–≤ (tv.USER_ID)
    us.familia      AS viewer_fam,
    us.imya         AS viewer_name,
    us.otchestvo    AS viewer_pat,
    us.spr_dolznost AS viewer_dol,
    us.tseh_short   AS viewer_tseh,

    -- –∫–æ–≥–æ –∑–∞–º—ñ—â–∞–ª–∏ (tv.SUBSTITUTION_ID), —è–∫—â–æ —î
    us1.familia      AS sub_fam,
    us1.imya         AS sub_name,
    us1.otchestvo    AS sub_pat,
    us1.spr_dolznost AS sub_dol,
    us1.tseh_short   AS sub_tseh
  FROM TaskTracker.TASK_VIEWED@TO_TASKTRACKER10 tv
  CROSS JOIN user_ctx uc
  JOIN kbs.personal@TO_TASKTRACKER10 us
    ON us.tab_no = tv.user_id
   AND us.priznak IS NULL
  LEFT JOIN kbs.personal@TO_TASKTRACKER10 us1
    ON us1.tab_no = tv.substitution_id
   AND us1.priznak IS NULL
  WHERE tv.user_id = uc.user_id
    -- –ª–æ–≥—ñ–∫–∞ –∑–º—ñ–Ω–∏: —è–∫—â–æ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —î shift-role,
    -- —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ –≤—ñ–∫–Ω—É P0_SHIFT_*, —ñ–Ω–∞–∫—à–µ ‚Äì –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –ø–µ—Ä–µ–≥–ª—è–¥–∏
    AND (
      uc.has_shift_role = 'N'
      OR uc.has_shift_role IS NULL
      OR (
        tv.date_viewed BETWEEN TO_DATE(:P0_SHIFT_START, 'DD.MM.YYYY HH24:MI')
                          AND TO_DATE(:P0_SHIFT_END,   'DD.MM.YYYY HH24:MI')
      )
    )
),

-- 2.2. –ì–æ—Ç—É—î–º–æ HTML –ø–æ –∫–æ–∂–Ω–æ–º—É –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ –±–µ—Ä–µ–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ –∑–∞–¥–∞—á—ñ
viewed_agg AS (
  SELECT
    task_id,
    viewed_html
  FROM (
    SELECT
      v.task_id,
      v.date_viewed,
      -- –§–æ—Ä–º—É—î–º–æ HTML –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ä–µ–∂–∏–º—É —Ç–∞ SUBSTITUTION_ID
      CASE
        WHEN v.substitution_mode = 0 THEN
          -- –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
          '<span class="fa fa-check-circle text-success" title="–û–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> ' ||
          v.viewer_fam || ' ' ||
          SUBSTR(v.viewer_name, 1, 1) || '. ' ||
          SUBSTR(v.viewer_pat, 1, 1) || '. ' || ', ' ||
          v.viewer_dol || ', ' || v.viewer_tseh ||
          ' (' || TO_CHAR(v.date_viewed, 'DD.MM.YYYY HH24:MI') || ')'

        WHEN v.substitution_mode = 1 THEN
          -- –†–µ–∂–∏–º –ø—ñ–¥–º—ñ–Ω–∏
          CASE
            WHEN v.substitution_id IS NOT NULL THEN
              -- –ü–µ—Ä–µ–≥–ª—è–Ω—É–≤ —è–∫ "–≤.–æ." (—î SUBSTITUTION_ID)
              '<span class="fa fa-check-circle text-success" title="–û–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> ' ||
              v.viewer_fam || ' ' ||
              SUBSTR(v.viewer_name, 1, 1) || '. ' ||
              SUBSTR(v.viewer_pat, 1, 1) || '. ' || ', ' ||
              '–≤. –æ. ' || v.sub_dol || ', ' || v.sub_tseh ||
              ' (' || TO_CHAR(v.date_viewed, 'DD.MM.YYYY HH24:MI') || ')'
            ELSE
              -- –ü—ñ–¥–º—ñ–Ω–∞ –≤–≤—ñ–º–∫–Ω–µ–Ω–∞, –∞–ª–µ SUBSTITUTION_ID –Ω–µ–º–∞—î ‚Äì –≤–µ–¥–µ–º–æ —Å–µ–±–µ —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º
              '<span class="fa fa-check-circle text-success" title="–û–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> ' ||
              v.viewer_fam || ' ' ||
              SUBSTR(v.viewer_name, 1, 1) || '. ' ||
              SUBSTR(v.viewer_pat, 1, 1) || '. ' || ', ' ||
              v.viewer_dol || ', ' || v.viewer_tseh ||
              ' (' || TO_CHAR(v.date_viewed, 'DD.MM.YYYY HH24:MI') || ')'
          END
      END AS viewed_html,
      ROW_NUMBER() OVER (
        PARTITION BY v.task_id
        ORDER BY v.date_viewed DESC
      ) AS rn
    FROM viewed_user v
  )
  WHERE rn = 1
),
```

üëâ `viewed_agg` —Ç–µ–ø–µ—Ä –º–∞—î **–æ–¥–∏–Ω —Ä—è–¥–æ–∫ –Ω–∞ –∑–∞–¥–∞—á—É** –∑ —É–∂–µ –≥–æ—Ç–æ–≤–∏–º HTML.

---

## 3. –ü—ñ–¥‚Äô—î–¥–Ω—É—î–º–æ `viewed_agg` —É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É SELECT

–¢–µ–ø–µ—Ä —É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É –±–ª–æ—Ü—ñ (—Ç—ñ–ª—å–∫–∏ —à–º–∞—Ç–æ–∫; —Ä–µ—à—Ç–∞ –ø–æ–ª—ñ–≤ —ñ–∑ `t.*` –ª–∏—à–∞—î–º–æ —è–∫ —î):

```sql
SELECT
  t.task_id,
  TO_CHAR(t.planning_date_start, 'dd.mm.yyyy hh24:mi') AS planning_date_start,
  t.unit_name,
  t.task_description_html,
  t.creator_info,
  t.executor_info,
  TO_CHAR(t.planning_date_end, 'dd.mm.yyyy hh24:mi')   AS planning_date_end,
  t.actual_date_end_info,
  t.status_name,
  t.department_name,
  t.note,
  t.type_id,

  -- –û–ó–ù–ê–ô–û–ú–õ–ï–ù–ù–Ø (View)
  COALESCE(
    v.viewed_html,
    '<span class="fa fa-circle text-muted" title="–ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> –ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ'
  ) AS viewed_by,

  t.status_id,
  -- –¥–∞–ª—ñ STATUS_LABEL_PROBLEM / PLANNED / SHIFT, ROW_CSS_CLASS, TASK_CODE —è–∫ –º–∏ –≤–∂–µ –ø–µ—Ä–µ–ø–∏—Å–∞–ª–∏ –≤–∏—â–µ...
  ...
FROM tasks_with_access t
LEFT JOIN viewed_agg v
       ON v.task_id = t.task_id
ORDER BY t.date_create DESC;
```

–Ü —Ç—É—Ç –¥—É–∂–µ –≤–∞–∂–ª–∏–≤–∏–π –º–æ–º–µ–Ω—Ç:

* –º–∏ **–ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–±–∏—Ä–∞—î–º–æ** —Å—Ç–∞—Ä–∏–π –≤–µ–ª–∏—á–µ–∑–Ω–∏–π `CASE ... WHEN :PO_SUBSTITUTION_MODE ...` –∑ –∫—ñ–ª—å–∫–æ–º–∞ `SELECT ... FROM TASK_VIEWED` –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ;
* —É—Å—è –ª–æ–≥—ñ–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É `VIEWED_BY` —Ç–µ–ø–µ—Ä –≤ –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ (`viewed_user / viewed_agg`), –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ –≤—Å—å–æ–º—É –Ω–∞–±–æ—Ä—É –∑–∞–¥–∞—á.

---

## 4. –©–æ –º–∏ –≤–∂–µ –º–∞—î–º–æ –ø—ñ—Å–ª—è Step 1 + Step 2

1. **`is_overdue` —Ç–∞ `is_incomplete`** ‚Äì —Ä–∞—Ö—É—é—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ `tasks_with_access`, –∞ –¥–∞–ª—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤—Å—é–¥–∏ (—Ñ—ñ–ª—å—Ç—Ä–∏ + —ñ–∫–æ–Ω–∫–∏ –∑ –ø—Ä–æ–±–ª–µ–º–∞–º–∏/–ø–ª–∞–Ω–æ–º/–∑–º—ñ–Ω–æ—é).
2. **`VIEWED_BY`**:

   * –æ–¥–∏–Ω –ø—Ä–æ—Ö—ñ–¥ –ø–æ `TASK_VIEWED` + `PERSONAL`;
   * –ª–æ–≥—ñ–∫–∞ –∑–º—ñ–Ω–∏ —Ç–∞ —Å—É–±—Å—Ç–∏—Ç—É—Ü—ñ—ó –≤ –æ–¥–Ω–æ–º—É CTE;
   * –∂–æ–¥–Ω–∏—Ö –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö —Å—É–±–∑–∞–ø–∏—Ç—ñ–≤ —É SELECT.
3. –ü–ª–∞–Ω –∑–∞–ø–∏—Ç—É —Å—Ç–∞—î —Å—É—Ç—Ç—î–≤–æ –ø—Ä–æ—Å—Ç—ñ—à–∏–π, –º–µ–Ω—à–µ remote-–≤–∏–∫–ª–∏–∫—ñ–≤, –º–µ–Ω—à–µ –ø–æ–≤—Ç–æ—Ä—ñ–≤.

---

## 5. –ù–∞—Å—Ç—É–ø–Ω–∏–π –ª–æ–≥—ñ—á–Ω–∏–π –∫—Ä–æ–∫ (Step 3)

–Ø–∫—â–æ –≥–æ—Ç–æ–≤–∏–π –π—Ç–∏ –¥–∞–ª—ñ, –ø—Ä–æ–ø–æ–Ω—É—é –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º:

* **—Ä–æ–∑–≤–∞–ª–∏—Ç–∏ –≤–µ–ª–∏–∫–∏–π OR –ø–æ `:P1_TAB_MODE` –Ω–∞ `UNION ALL`**:

  * –æ–∫—Ä–µ–º–∏–π SELECT –¥–ª—è `PLANNED`,
  * –æ–∫—Ä–µ–º–∏–π –¥–ª—è `TODO`,
  * –æ–∫—Ä–µ–º–∏–π –¥–ª—è `SHIFT`,
  * –æ–∫—Ä–µ–º–∏–π –¥–ª—è `PROBLEM`,
  * –æ–∫—Ä–µ–º–∏–π –¥–ª—è `ARCHIVE`.

–¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä—É –±—É–¥—É–≤–∞—Ç–∏ **—Ä—ñ–∑–Ω—ñ –ø–ª–∞–Ω–∏** –ø—ñ–¥ —Ä—ñ–∑–Ω—ñ —Ä–µ–∂–∏–º–∏, –Ω–µ —Ç—è–≥–Ω—É—Ç–∏ –∑–∞–π–≤—ñ JOIN/EXISTS —Ç–∞–º, –¥–µ –≤–æ–Ω–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ.

–Ø–∫—â–æ –æ–∫, —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫—Ä–æ—Ü—ñ –ø–æ–∫–∞–∂—É –∫–∞—Ä–∫–∞—Å –∑ `UNION ALL` –¥–ª—è –≤—Å—ñ—Ö –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∂–µ –≥–æ—Ç–æ–≤–∏—Ö CTE (`user_ctx`, `tasks_with_access`, `viewed_agg`).
