–¢–∞–∫, —Ç–µ–ø–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∞ üëç
–¢–∏ –±–µ—Ä–µ—à **—Ç–æ–π —Å–∞–º–∏–π –≤–∞–∂–∫–∏–π –∑–∞–ø–∏—Ç**, –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–∏–¥–∞—î—à –∑–∞–π–≤—ñ `MODE` –π —Ä–∞—Ö—É—î—à `COUNT(*)` –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏ –æ–∫—Ä–µ–º–æ. –¢–æ–º—É:

* –æ—Å–Ω–æ–≤–Ω–∏–π —Ä–µ–ø–æ—Ä—Ç = 1 –≤–∞–∂–∫–∏–π SQL
* * 3‚Äì4 —Ä–∞–∑–∏ –º–∞–π–∂–µ —Ç–æ–π —Å–∞–º–∏–π SQL –Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
    = —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–µ–∞–ª—å–Ω–æ –≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è –≤–¥–≤—ñ—á—ñ –¥–æ–≤—à–µ.

–¢—É—Ç JavaScript —Ç–µ–±–µ –Ω–µ –≤—Ä—è—Ç—É—î, –±–æ JS —Ç—ñ–ª—å–∫–∏ **–ø–æ–∫–∞–∑—É—î**, –∞ –Ω–µ —Ä–∞—Ö—É—î. –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —Ç—Ä–µ–±–∞ **–Ω–∞ —Ä—ñ–≤–Ω—ñ SQL**: —â–æ–± **–æ–¥–Ω–∏–º –ø—Ä–æ—Ö–æ–¥–æ–º** –ø–æ –∑–∞–¥–∞—á–∞—Ö –æ—Ç—Ä–∏–º–∞—Ç–∏ **–≤—Å—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏**.

---

## –Ü–¥–µ—è: –æ–¥–∏–Ω –∑–∞–ø–∏—Ç, —è–∫–∏–π —Ä–∞—Ö—É—î –í–°–Ü –≤–∫–ª–∞–¥–∫–∏ –æ–¥—Ä–∞–∑—É

–ë–µ—Ä–µ–º–æ —Ç–≤—ñ–π CTE `user_ctx` + `tasks_with_access`, **–∞–ª–µ –±–µ–∑ –±–ª–æ–∫—É –∑ `:P1_TAB_MODE`**. –ù–∞ –Ω—å–æ–º—É –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–≥—Ä–µ–≥–∞—Ü—ñ—é:

```sql
WITH user_ctx AS (
  SELECT
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID       ELSE :PO_CUR_USER_TABNO      END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID   ELSE :PO_CUR_USER_POSITION   END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID ELSE :PO_CUR_USER_DEPARTMENT END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID       ELSE :PO_CUR_USER_UNIT       END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK      ELSE :PO_CUR_UCHASTOK        END AS uchastok_id
  FROM dual
),

tasks_with_access AS (
  SELECT
    t.TASK_ID,
    t.PLANNING_DATE_START,
    t.PLANNING_DATE_END,
    t.ACTUAL_DATE_END,
    t.PAGE_LIST_ID,
    t.STATUS_ID,
    s.STATUS_MAIN_ID,
    r.USER_TABNO   AS r_user_tabno,
    r.ID           AS r_id,
    r.STAGES_ID    AS r_stages_id
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s
    ON s.ID = t.STATUS_ID
  LEFT JOIN TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
    ON r.task_id = t.task_id
  WHERE
    /* —Ç—É—Ç —Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞ ACCESS CONTROL –∑ EXISTS –ø–æ task_access_control + signaturerights,
       –∞–ª–µ –ë–ï–ó –±–ª–æ–∫—É –∑ :P1_TAB_MODE ‚Äì —Ç—ñ–ª—å–∫–∏ "—Ö—Ç–æ –±–∞—á–∏—Ç—å —è–∫—ñ –∑–∞–¥–∞—á—ñ" */
    (
      EXISTS ( ... level 1 ... )
      OR EXISTS ( ... level 2 ... )
      OR EXISTS ( ... level 3 ... )
      OR EXISTS ( ... signaturerights ... )
      OR t.CREATOR_ID = uc.user_id
    )
)

/* === –æ–¥–∏–Ω —Ä—è–¥–æ–∫ –∑ —É—Å—ñ–º–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞–º–∏ === */
SELECT
  -- –ü–õ–ê–ù–û–í–Ü (PLANNED)
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (
              (status_main_id <> 0 AND planning_date_end > SYSDATE)
           OR (status_main_id <> 0 AND actual_date_end IS NULL)
           )
      THEN 1 ELSE 0
    END
  ) AS CNT_PLANNED,

  -- TODO
  SUM(
    CASE
      WHEN
        /* —É–º–æ–≤–∞ TODO –∑ —Ç–≤–æ–≥–æ WHERE */
        r_user_tabno = (SELECT user_id FROM user_ctx)
        AND NOT EXISTS (
          SELECT 1
          FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h
          WHERE h.signright_id = r_id
            AND h.new_status_id IS NOT NULL
        )
        AND NOT EXISTS (
          SELECT 1
          FROM tasktracker.signaturerights@TO_TASKTRACKER10 r_prev
          WHERE r_prev.task_id   = task_id
            AND r_prev.stages_id < r_stages_id
            AND NOT EXISTS (
              SELECT 1
              FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h2
              WHERE h2.signright_id = r_prev.id
                AND h2.new_status_id IS NOT NULL
            )
        )
      THEN 1 ELSE 0
    END
  ) AS CNT_TODO,

  -- SHIFT
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (
            (planning_date_start BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                    AND TO_DATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI'))
         OR (planning_date_end   BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                    AND TODATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI'))
         OR EXISTS (
              SELECT 1
              FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
              WHERE sr.task_id        = task_id
                AND sr.shift_symbol_id = :PO_SHIFT_SYMBOL
            )
          )
      THEN 1 ELSE 0
    END
  ) AS CNT_SHIFT,

  -- PROBLEM
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (
             (planning_date_end < SYSDATE AND actual_date_end IS NULL)
          OR EXISTS (
               SELECT 1
               FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 d
               WHERE d.page_list_id     = page_list_id
                 AND d.parent_stage_id IS NOT NULL
                 AND NOT EXISTS (
                       SELECT 1
                       FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r2
                       WHERE r2.task_id   = task_id
                         AND r2.stages_id = d.id
                     )
             )
           )
      THEN 1 ELSE 0
    END
  ) AS CNT_PROBLEM,

  -- ARCHIVE
  SUM(
    CASE
      WHEN status_main_id = 0
      THEN 1 ELSE 0
    END
  ) AS CNT_ARCHIVE

FROM tasks_with_access;
```

> –°—É—Ç—å:
> üîπ `tasks_with_access` —Ä–∞—Ö—É—î **—Ç—ñ–ª—å–∫–∏ –¥–æ—Å—Ç—É–ø** (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ `V_TASKS_FULL`).
> üîπ –§—ñ–Ω–∞–ª—å–Ω–∏–π SELECT —Ä–æ–±–∏—Ç—å **–ø‚Äô—è—Ç—å `SUM(CASE ...)`** ‚Äì –ø–æ –ª–æ–≥—ñ—Ü—ñ –≤–∫–ª–∞–¥–æ–∫.
> üîπ –û—Ç—Ä–∏–º—É—î—à **–æ–¥–∏–Ω —Ä—è–¥–æ–∫** –∑ –∫–æ–ª–æ–Ω–∫–∞–º–∏ `CNT_PLANNED`, `CNT_TODO`, `CNT_SHIFT`, `CNT_PROBLEM`, `CNT_ARCHIVE`.

–¢–µ–ø–µ—Ä —Ç–æ–±—ñ –Ω–µ —Ç—Ä–µ–±–∞ 4 –æ–∫—Ä–µ–º—ñ –∑–∞–ø–∏—Ç–∏ —Ç–∏–ø—É `... WHERE :P1_TAB_MODE = 'PLANNED'` / `= 'PROBLEM'` —ñ —Ç.–¥. ‚Äì —É—Å–µ —Ä–∞—Ö—É—î—Ç—å—Å—è –æ–¥–Ω–∏–º –ø—Ä–æ—Ö–æ–¥–æ–º.

---

## –Ø–∫ —Ü–µ –ø—ñ–¥‚Äô—î–¥–Ω–∞—Ç–∏ –≤ APEX

### –í–∞—Ä—ñ–∞–Ω—Ç 1. –û–∫—Ä–µ–º–∏–π ‚Äú—Å–ª—É–∂–±–æ–≤–∏–π‚Äù —Ä–µ–≥—ñ–æ–Ω + JS

1. –°—Ç–≤–æ—Ä—é—î—à –Ω–æ–≤–∏–π —Ä–µ–≥—ñ–æ–Ω —Ç–∏–ø—É **Classic Report / SQL Report** –∑ —Ü–∏–º –∑–∞–ø–∏—Ç–æ–º.

   * Static ID, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `R_TASK_COUNTERS`.
   * –í–∏—Ö—ñ–¥–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏: `CNT_PLANNED`, `CNT_TODO`, `CNT_SHIFT`, `CNT_PROBLEM`, `CNT_ARCHIVE`.
   * –ú–æ–∂–Ω–∞ —Å—Ö–æ–≤–∞—Ç–∏ –π–æ–≥–æ —à–∞–±–ª–æ–Ω–æ–º –∞–±–æ CSS (`display:none`).

2. JS (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É `Function and Global Variable Declaration` —Å—Ç–æ—Ä—ñ–Ω–∫–∏):

```js
document.addEventListener("DOMContentLoaded", function () {
  var $region = apex.jQuery("#R_TASK_COUNTERS");
  if ($region.length === 0) return;

  $region.on("apexafterrefresh", function () {
    var $row = $region.find("tbody tr").first();
    if ($row.length === 0) return;

    var planned  = $row.find("td[headers='CNT_PLANNED']").text();
    var todo     = $row.find("td[headers='CNT_TODO']").text();
    var shift    = $row.find("td[headers='CNT_SHIFT']").text();
    var problem  = $row.find("td[headers='CNT_PROBLEM']").text();
    var archive  = $row.find("td[headers='CNT_ARCHIVE']").text();

    apex.jQuery("#tab_planned .t-Tabs-badge").text(planned);
    apex.jQuery("#tab_todo .t-Tabs-badge").text(todo);
    apex.jQuery("#tab_shift .t-Tabs-badge").text(shift);
    apex.jQuery("#tab_problem .t-Tabs-badge").text(problem);
    apex.jQuery("#tab_archive .t-Tabs-badge").text(archive);
  });
});
```

> ID –≤–∫–ª–∞–¥–æ–∫ (`#tab_planned` —ñ —Ç.–¥.) ‚Äì –ø—ñ–¥—Å—Ç–∞–≤–∏—à —Å–≤–æ—ó (Static ID —Ç–∞–±—ñ–≤ –∞–±–æ –∫–Ω–æ–ø–æ–∫).

–¢–∞–∫ —Ç–∏ –º–∞—î—à:

* 1 –≤–∞–∂–∫–∏–π SQL –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª—É;
* 1 –ø–æ–º—ñ—Ä–Ω–æ –≤–∞–∂–∫–∏–π SQL –¥–ª—è –≤—Å—ñ—Ö –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤;
* JS ‚Äî –ª–∏—à–µ –∑–∞–±–∏—Ä–∞—î —á–∏—Å–ª–∞ —ñ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î –≤ –±–µ–π–¥–∂–∏–∫–∏.

---

### –í–∞—Ä—ñ–∞–Ω—Ç 2. –û–¥–∏–Ω PL/SQL –ø—Ä–æ—Ü–µ—Å —ñ 5 page item‚Äô—ñ–≤

–Ø–∫—â–æ –Ω–µ —Ö–æ—á–µ—à –≥—Ä–∞—Ç–∏—Å—è –∑ JS:

1. –°—Ç–≤–æ—Ä–∏ 5 item‚Äô—ñ–≤:
   `P1_CNT_PLANNED`, `P1_CNT_TODO`, `P1_CNT_SHIFT`, `P1_CNT_PROBLEM`, `P1_CNT_ARCHIVE`.

2. **Before Header Process**:

```plsql
DECLARE
  l_planned  NUMBER;
  l_todo     NUMBER;
  l_shift    NUMBER;
  l_problem  NUMBER;
  l_archive  NUMBER;
BEGIN
  WITH user_ctx AS ( ... ),
       tasks_with_access AS ( ... )
  SELECT
    /* —Ç–æ–π —Å–∞–º–∏–π SELECT –∑ SUM(CASE...) */
    ...
  INTO
    l_planned,
    l_todo,
    l_shift,
    l_problem,
    l_archive
  FROM tasks_with_access;

  :P1_CNT_PLANNED  := l_planned;
  :P1_CNT_TODO     := l_todo;
  :P1_CNT_SHIFT    := l_shift;
  :P1_CNT_PROBLEM  := l_problem;
  :P1_CNT_ARCHIVE  := l_archive;
END;
```

3. –£ —à–∞–±–ª–æ–Ω—ñ –≤–∫–ª–∞–¥–æ–∫ (Label) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à —Ü—ñ item‚Äô–∏, –Ω–∞–ø—Ä.:

```text
–ü–ª–∞–Ω–æ–≤—ñ (&P1_CNT_PLANNED.)
–ü—Ä–æ–±–ª–µ–º–Ω—ñ (&P1_CNT_PROBLEM.)
...
```

**–ü–ª—é—Å:** –±–µ–∑ JS, –≤—Å–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
**–ú—ñ–Ω—É—Å:** –ª–æ–≥—ñ–∫–∞ `WITH user_ctx + tasks_with_access` –¥—É–±–ª—é—î—Ç—å—Å—è –∑ –æ—Å–Ω–æ–≤–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º (–∞–ª–µ –≤–∂–µ –Ω–µ 4 —Ä–∞–∑–∏, –∞ –æ–¥–∏–Ω —Ä–∞–∑).

---

## –©–æ —Ü–µ —Ç–æ–±—ñ –¥–∞—Å—Ç—å –ø–æ —á–∞—Å—É

–ë—É–ª–æ:

* 1 √ó –≤–∞–∂–∫–∏–π –∑–∞–ø–∏—Ç (–∂—É—Ä–Ω–∞–ª)
* * 3‚Äì4 √ó –º–∞–π–∂–µ —Ç–∞–∫–∏–π —Å–∞–º–∏–π (–ª—ñ—á–∏–ª—å–Ω–∏–∫–∏)

‚Üí 4‚Äì5 –ø—Ä–æ—Ö–æ–¥—ñ–≤ –ø–æ —Ç—è–∂–∫–æ–º—É `V_TASKS_FULL`.

–°—Ç–∞–Ω–µ:

* 1 √ó –≤–∞–∂–∫–∏–π (–∂—É—Ä–Ω–∞–ª)
* * 1 √ó –ª–µ–≥—à–∏–π –∞–≥—Ä–µ–≥–∞—Ü—ñ–π–Ω–∏–π (—Ç—ñ–ª—å–∫–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏, –±–µ–∑ HTML/LISTAGG)

‚Üí 2 –ø—Ä–æ—Ö–æ–¥–∏ –∑–∞–º—ñ—Å—Ç—å 4‚Äì5. –ù–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ —Ü–µ –º–∞–π–∂–µ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –¥–∞—Å—Ç—å –ø–æ–º—ñ—Ç–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, —è –º–æ–∂—É –æ–∫—Ä–µ–º–æ:

* –≤–∑—è—Ç–∏ **–æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π MODE**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `PROBLEM`,
* —ñ –≤–∏–ø–∏—Å–∞—Ç–∏ —Ç–æ–±—ñ `CASE WHEN ... THEN 1` –∑ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏—á–∏—â–µ–Ω–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º –ø—ñ–¥ —Ç–≤—ñ–π –Ω–æ–≤–∏–π `V_TASKS_FULL_2`, —â–æ–± —Ç–∏ –ø–æ –Ω—å–æ–º—É –≤–∏—Ä—ñ–≤–Ω—è–≤ —Ä–µ—à—Ç—É.
