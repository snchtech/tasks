–°—É–ø–µ—Ä, —â–æ —Ç–∏ —Ü–µ –≤–∏–Ω—ñ—Å –≤ –æ–¥–∏–Ω –∑–∞–ø–∏—Ç ‚Äì —Ç—É—Ç —ñ —Å–ø—Ä–∞–≤–¥—ñ —î —â–æ ‚Äú–ø–æ—á–∏—Å—Ç–∏—Ç–∏‚Äù üòä
–ó–∞—Ä–∞–∑ –≥–æ–ª–æ–≤–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—ñ, –∞ –≤ **—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ**:

* –∫—É–ø–∞ **–∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤ —É SELECT**
* **–æ–¥–Ω—ñ –π —Ç—ñ —Å–∞–º—ñ —Ç–∞–±–ª–∏—Ü—ñ** (SIGNATURERIGHTS, SIGNATUREHISTORY, PERSONAL, DICT_STATUS) –ø—ñ–¥–∫–ª—é—á–∞—é—Ç—å—Å—è –ø–æ –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤
* —É—Å–µ —Ü–µ —â–µ –π –ø–æ **database link‚Äô–∞—Ö**, —Ç–æ–±—Ç–æ –∫–æ–∂–µ–Ω —Ç–∞–∫–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç = –∑–∞–π–≤–∏–π –º–µ—Ä–µ–∂–µ–≤–∏–π —Ä–∞—É–Ω–¥.

–ù–∏–∂—á–µ –ø–æ–∫–∞–∂—É, **—è–∫ —Ü–µ –∑–≥–æ—Ä–Ω—É—Ç–∏ –≤ CTE** (WITH) —Ç–∞ —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö JOIN‚Äô—ñ–≤. –ö–æ–¥ –±—É–¥–µ –Ω–µ 1:1 –∑ —Ç–≤–æ—ó–º HTML, –∞–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ ‚Äî —Ç–∏ –∑–º–æ–∂–µ—à –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–≤–æ—é —Ä–æ–∑–º—ñ—Ç–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—É –∑–∞–≥–æ—Ç–æ–≤–æ–∫.

---

## 1. –û—Å–Ω–æ–≤–Ω—ñ —ñ–¥–µ—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

1. **SUBTASKS** ‚Äì –æ–¥–∏–Ω `LISTAGG` –ø–æ `TASK_ID` ‚Üí –±—ñ–ª—å—à–µ –Ω–µ —Ä–æ–±–∏–º–æ –ø—ñ–¥–∑–∞–ø–∏—Ç —É CASE.
2. **CREATOR_INFO (STAGES_ID = 2)** ‚Äì –æ–∫—Ä–µ–º–∏–π CTE –ø–æ SIGNATURERIGHTS + SIGNATUREHISTORY + PERSONAL.
3. **EXECUTOR_INFO (STAGES_ID = 4)** ‚Äì –æ–∫—Ä–µ–º–∏–π CTE –∑ `LISTAGG` –ø–æ –≤–∏–∫–æ–Ω–∞–≤—Ü—è—Ö.
4. **–§–∞–∫—Ç–∏—á–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (STAGES_ID = 6)** ‚Äì –æ–¥–∏–Ω CTE `actual_end`.
5. **STATUS_ID + STATUS_NAME** ‚Äì –æ–¥–∏–Ω CTE `status_calc`, —è–∫–∏–π –æ–±—á–∏—Å–ª—é—î —ñ id, —ñ name, –∑–∞–º—ñ—Å—Ç—å –¥–≤–æ—Ö –≤–µ–ª–∏—á–µ–∑–Ω–∏—Ö CASE —É –æ—Å–Ω–æ–≤–Ω–æ–º—É SELECT.
6. **VIEWED_BY** ‚Äì –æ–¥–∏–Ω CTE `viewed_today` –∑ `ROW_NUMBER()`, –∑–∞–º—ñ—Å—Ç—å –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–æ–≥–æ –ø—ñ–¥–∑–∞–ø–∏—Ç—É.

---

## 2. –ü—Ä–∏–±–ª–∏–∑–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π –∑–∞–ø–∏—Ç (—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π)

> ‚ö†Ô∏è –£–í–ê–ì–ê:
>
> * –¢–∞–±–ª–∏—Ü—ñ –π –ª—ñ–Ω–∫–∏ —è –ª–∏—à–∏–≤ —Ç–∞–∫—ñ, —è–∫ —É —Ç–µ–±–µ (`@To_Tasktracker10`).
> * –í—Å—é –¥–µ—Ç–∞–ª—å–Ω—É HTML-–ª–æ–≥—ñ–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `CREATOR_INFO_HTML` —Ç–∞ `EXECUTOR_INFO_HTML` —è —Å–∏–ª—å–Ω–æ —Å–∫–æ—Ä–æ—Ç–∏–≤ —ñ –∑–∞–ª–∏—à–∏–≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ `/* ... */` ‚Äì —Å—é–¥–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–µ—Å–∏ —Å–≤–æ—ó CONCAT-–≤–∏—Ä–∞–∑–∏.
> * –õ–æ–≥—ñ–∫—É ‚Äú—Å–ø–µ—Ü-—Å—Ç–∞—Ç—É—Å—É 15, —è–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞—Ç—É—Å 13 —ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ –Ω–µ –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤–∞–Ω—ñ‚Äù —è –∑–∞–ª–∏—à–∏–≤, –∞–ª–µ —Å—Ç–∏—Å–Ω—É–≤.

```sql
WITH
-- 1. –û–ø–∏—Å –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å —É –≤–∏–≥–ª—è–¥—ñ <li>...</li>
subtasks_html AS (
  SELECT
    s.task_id,
    LISTAGG('<li>' || s.subtask_content || '</li>', '')
      WITHIN GROUP (ORDER BY s.subtask_order) AS subtasks_html
  FROM TaskTracker.TASK_SUBTASKS@To_Tasktracker10 s
  GROUP BY s.task_id
),

-- 2. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ "—Ö—Ç–æ –≤–∏–¥–∞–≤" (stages_id = 2) –ø–æ –∫–æ–∂–Ω–æ–º—É TASK_ID
creator_info AS (
  SELECT
    sr.task_id,
    /* –¢–£–¢ –ü–ï–†–ï–ù–û–°–ò–® –°–í–Ü–ô –í–ï–õ–ò–ö–ò–ô CONCAT –î–õ–Ø CREATOR_INFO */
    '<span class="task_creator"> ... </span>' AS creator_info_html
  FROM TaskTracker.SIGNATURERIGHTS@To_Tasktracker10 sr
  LEFT JOIN kbs.spr_dolznost@To_Tasktracker10 pos1
         ON pos1.kod = sr.position_id
  LEFT JOIN kbs.spr_dolznost_base@To_Tasktracker10 bb
         ON pos1.id_base = bb.id
  LEFT JOIN kbs.spr_department@To_Tasktracker10 dep
         ON dep.id = sr.department_id
  LEFT JOIN kbs.personal@To_Tasktracker10 u2
         ON u2.tab_no = sr.user_tabno
        AND u2.priznak IS NULL
  /* –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –ø—ñ–¥—Ç—è–≥—É–≤–∞—Ç–∏ SIGNATUREHISTORY ‚Äì —Ä–æ–±–∏—à —Ç—É—Ç —â–µ –æ–¥–∏–Ω LEFT JOIN */
  LEFT JOIN TaskTracker.SIGNATUREHISTORY@To_Tasktracker10 h
         ON h.signright_id = sr.id
  WHERE sr.stages_id = 2
    -- —è–∫—â–æ –Ω–∞ –∑–∞–¥–∞—á—É –º–æ–∂–µ –±—É—Ç–∏ –∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Å—ñ–≤ ‚Äì –±–µ—Ä–µ–º–æ –ø–µ—Ä—à–∏–π –∑–∞ —è–∫–∏–º–æ—Å—å –ø—Ä–∞–≤–∏–ª–æ–º
),

-- 3. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ–≤ (stages_id = 4) ‚Äì –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–æ –ø–æ TASK_ID
executor_info AS (
  SELECT
    sr2.task_id,
    LISTAGG(
      /* –¢–£–¢ –ü–ï–†–ï–ù–û–°–ò–® –°–í–Ü–ô CONCAT –î–õ–Ø –û–î–ù–û–ì–û –í–ò–ö–û–ù–ê–í–¶–Ø:
         '<span class="trk_creator">...' || ... || '</span>'
       */
      '<span class="trk_creator"> ... </span>',
      ' '
    ) WITHIN GROUP (ORDER BY sr2.id) AS executor_info_html
  FROM TaskTracker.SIGNATURERIGHTS@To_Tasktracker10 sr2
  LEFT JOIN kbs.spr_dolznost@To_Tasktracker10 pos2
         ON pos2.kod = sr2.position_id
  LEFT JOIN kbs.spr_department@To_Tasktracker10 dep
         ON dep.id = sr2.department_id
  LEFT JOIN kbs.personal@To_Tasktracker10 u3
         ON u3.tab_no = sr2.user_tabno
        AND u3.priznak IS NULL
  /* –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –≤–∏–≤–æ–¥–∏—Ç–∏ "–í–∏–∫–æ–Ω–∞–Ω–æ" –∑ SIGNATUREHISTORY ‚Äì —Ç–µ–∂ –ø—Ä–∏—î–¥–Ω—É—î—à —Ç—É—Ç h */
  LEFT JOIN TaskTracker.SIGNATUREHISTORY@To_Tasktracker10 h
         ON h.signright_id = sr2.id
  WHERE sr2.stages_id = 4
  GROUP BY sr2.task_id
),

-- 4. –§–∞–∫—Ç–∏—á–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (stages_id = 6)
actual_end AS (
  SELECT
    sr3.task_id,
    MAX(h.signer_date) AS actual_date_end
  FROM TaskTracker.SIGNATURERIGHTS@To_Tasktracker10 sr3
  JOIN TaskTracker.SIGNATUREHISTORY@To_Tasktracker10 h
    ON h.signright_id = sr3.id
  WHERE sr3.stages_id = 6
  GROUP BY sr3.task_id
),

-- 5. –Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤ –ø–æ –∫–æ–∂–Ω–æ–º—É TASK_ID (–æ—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞—Ç—É—Å)
status_hist AS (
  SELECT
    r.task_id,
    h.new_status_id,
    s.name AS new_status_name,
    ROW_NUMBER() OVER (
      PARTITION BY r.task_id
      ORDER BY h.sdate DESC, h.id DESC
    ) AS rn
  FROM TaskTracker.SIGNATUREHISTORY@To_Tasktracker10 h
  JOIN TaskTracker.SIGNATURERIGHTS@To_Tasktracker10 r
    ON r.id = h.signright_id
  LEFT JOIN TaskTracker.DICT_STATUS@To_Tasktracker10 s
    ON s.id = h.new_status_id
  WHERE h.new_status_id IS NOT NULL
),

-- 6. –ß–∏ –≤—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ 4-—ó —Å—Ç–∞–¥—ñ—ó –≤—ñ–¥–ø—Ä–∞—Ü—é–≤–∞–ª–∏ (–¥–ª—è —Å–ø–µ—Ü–∞ 15 / 13)
stage4_not_signed AS (
  SELECT
    r2.task_id,
    COUNT(*) AS not_signed_cnt
  FROM TaskTracker.SIGNATURERIGHTS@To_Tasktracker10 r2
  WHERE r2.stages_id = 4
    AND NOT EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATUREHISTORY@To_Tasktracker10 h2
      WHERE h2.signright_id = r2.id
        AND h2.new_status_id IS NOT NULL
    )
  GROUP BY r2.task_id
),

-- 7. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞—Ç—É—Å—É (id + name) –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ç–≤–æ—î—ó –ª–æ–≥—ñ–∫–∏ "13 -> 15"
status_calc AS (
  SELECT
    t.id AS task_id,
    CASE
      WHEN NVL(sn.not_signed_cnt, 0) = 0
           AND NVL(sh.new_status_id, -1) = 13
      THEN 15                -- —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ 13 -> 15
      ELSE NVL(sh.new_status_id, t.status_id)
    END AS status_id,
    CASE
      WHEN NVL(sn.not_signed_cnt, 0) = 0
           AND NVL(sh.new_status_id, -1) = 13
      THEN s15.name          -- –Ω–∞–∑–≤–∞ —Å—Ç–∞—Ç—É—Å—É 15
      ELSE NVL(sh.new_status_name, st.name)
    END AS status_name
  FROM TaskTracker.TASKS@To_Tasktracker10 t
  LEFT JOIN status_hist sh
    ON sh.task_id = t.id
   AND sh.rn = 1
  LEFT JOIN stage4_not_signed sn
    ON sn.task_id = t.id
  LEFT JOIN TaskTracker.DICT_STATUS@To_Tasktracker10 st
    ON st.id = t.status_id
  LEFT JOIN TaskTracker.DICT_STATUS@To_Tasktracker10 s15
    ON s15.id = 15
),

-- 8. –•—Ç–æ "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π" —Å—å–æ–≥–æ–¥–Ω—ñ
viewed_today AS (
  SELECT
    tv.task_id,
    (us.familia || ' ' || SUBSTR(us.imya, 1, 1) || '. ' ||
     SUBSTR(us.otchestvo, 1, 1) || '. ' ||
     ', ' || us.spr_dolznost || ', ' || us.tseh_short ||
     ' (' || TO_CHAR(tv.date_viewed, 'DD.MM.YYYY HH24:MI') || ')'
    ) AS viewed_by,
    ROW_NUMBER() OVER (
      PARTITION BY tv.task_id
      ORDER BY tv.date_viewed DESC
    ) AS rn
  FROM TaskTracker.TASK_VIEWED@To_Tasktracker10 tv
  JOIN KBS.personal@To_Tasktracker10 us
    ON us.tab_no = tv.user_id
   AND us.priznak IS NULL
  WHERE TRUNC(tv.date_viewed) = TRUNC(SYSDATE)
)

SELECT
  t.id AS task_id,
  t.planning_date_start,
  u.name AS unit_name,

  -- –ó–º—ñ—Å—Ç –∑–∞–≤–¥–∞–Ω–Ω—è (—Ç–µ–∫—Å—Ç –∞–±–æ —Å–ø–∏—Å–æ–∫ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å)
  CASE
    WHEN t.type_id = 1 THEN t.task_content
    ELSE st_html.subtasks_html
  END AS task_description_html,

  -- –•—Ç–æ –≤–∏–¥–∞–≤
  ci.creator_info_html AS creator_info,

  -- –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å(—ñ)
  ei.executor_info_html AS executor_info,

  -- –ü–ª–∞–Ω–æ–≤–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
  t.planning_date_end,

  -- –§–∞–∫—Ç–∏—á–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (—ñ–∑ CTE)
  ae.actual_date_end,
  
  -- –°—Ç–∞—Ç—É—Å (name / id –∑ –æ–¥–Ω–æ–≥–æ –º—ñ—Å—Ü—è)
  sc.status_name,
  sc.status_id,

  dep.short_name AS department_name,
  t.note,
  t.type_id,
  t.page_list_id,
  t.task_code,

  -- –û–∑–Ω–∞–π–æ–º–ª–µ–Ω–∏–π —Å—å–æ–≥–æ–¥–Ω—ñ
  vt.viewed_by

FROM TaskTracker.TASKS@To_Tasktracker10 t
LEFT JOIN TaskTracker.DICT_UNIT@To_Tasktracker10 u
       ON u.id = t.unit_id
LEFT JOIN kbs.spr_department@To_Tasktracker10 dep
       ON dep.id = t.department_id
LEFT JOIN subtasks_html st_html
       ON st_html.task_id = t.id
LEFT JOIN creator_info ci
       ON ci.task_id = t.id
LEFT JOIN executor_info ei
       ON ei.task_id = t.id
LEFT JOIN actual_end ae
       ON ae.task_id = t.id
LEFT JOIN status_calc sc
       ON sc.task_id = t.id
LEFT JOIN viewed_today vt
       ON vt.task_id = t.id
      AND vt.rn = 1
ORDER BY t.date_create DESC;
```

---

## 3. –©–æ —Ç–∏ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–≥—Ä–∞—î—à

1. **–ö–æ–∂–Ω–∞ –≤–µ–ª–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—è —á–µ—Ä–µ–∑ dblink –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —É CTE**, –∞ –Ω–µ –ø–æ 10 —Ä–∞–∑—ñ–≤ —É –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–∑–∞–ø–∏—Ç–∞—Ö.
2. **–õ–æ–≥—ñ–∫–∞ —Å—Ç–∞—Ç—É—Å—É** –≤ –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ (`status_calc`), —ñ —Ç–∏ —ó—ó –Ω–µ –¥—É–±–ª—é—î—à (—ñ –¥–ª—è `status_name`, —ñ –¥–ª—è `status_id`).
3. **HTML-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü—ñ—è** —Å—Ç–∞—î —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–æ—é ‚Äî —É—Å–µ –¥–ª—è CREATOR —ñ EXECUTOR –≤ –æ–∫—Ä–µ–º–∏—Ö –±–ª–æ–∫–∞—Ö, –∞ –Ω–µ –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ SELECT‚Äô–∞.
4. –õ–µ–≥—à–µ **–¥–µ–±–∞–∂–∏—Ç–∏**: –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –æ–∫—Ä–µ–º–æ `SELECT * FROM status_calc`, `SELECT * FROM executor_info` —ñ –¥–∏–≤–∏—Ç–∏—Å—è, —â–æ –Ω–µ —Ç–∞–∫.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂—É:

* –æ–∫—Ä–µ–º–æ –≤–∏–Ω–µ—Å—Ç–∏ **—Ç—ñ–ª—å–∫–∏ –ª–æ–≥—ñ–∫—É —Å—Ç–∞—Ç—É—Å—ñ–≤** —ñ –¥–æ–≤–µ—Å—Ç–∏ —ó—ó –¥–æ 100% –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Ç–≤–æ—î–º—É CASE;
* –∞–±–æ **—Ä–∞–∑–æ–º –ø—Ä–æ–π—Ç–∏—Å—è –ø–æ HTML-–±–ª–æ–∫–∞—Ö** (CREATOR/EXECUTOR) —ñ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —ó—Ö —É CTE —Ç–∞–∫, —â–æ–± —É—Å–µ –±—É–ª–æ 1:1 –∑ —Ç–≤–æ—ó–º —Ç–µ–∫—Å—Ç–æ–º.
