–ö–æ—Ä–æ—Ç–∫–æ: —Ç–∞–∫, —Ü–µ –≤—Å–µ —â–µ –º–æ–∂–Ω–∞ **–ø–æ–º—ñ—Ç–Ω–æ** –ø—Ä–∏—à–≤–∏–¥—à–∏—Ç–∏, –Ω–∞–≤—ñ—Ç—å –∑ —É–∂–µ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–º `V_TASKS_FULL`. –ó–∞—Ä–∞–∑ —Ç–≤—ñ–π APEX-–∑–∞–ø–∏—Ç –∑–Ω–æ–≤—É ‚Äú–≤–±–∏–≤–∞—î‚Äù –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—é –∫—É–ø–æ—é –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤, –¥—É–±–ª—å–æ–≤–∞–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é –π OR‚Äô–∞–º–∏ –ø–æ —Ä–µ–∂–∏–º–∞—Ö.

–Ø —Ä–æ–∑–¥—ñ–ª—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ 3 –±–ª–æ–∫–∏:
1Ô∏è‚É£ —â–æ —Å–∞–º–µ —Ç—É—Ç –≥–∞–ª—å–º—É—î
2Ô∏è‚É£ —è–∫—ñ –∑–º—ñ–Ω–∏ –¥–∞–¥—É—Ç—å –Ω–∞–π–±—ñ–ª—å—à–∏–π –µ—Ñ–µ–∫—Ç
3Ô∏è‚É£ –ø—Ä–∏–∫–ª–∞–¥–∏ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è (–Ω–µ –≤–µ—Å—å –º–æ–Ω—Å—Ç—Ä, –∞ –∫–ª—é—á–æ–≤—ñ –º—ñ—Å—Ü—è, —â–æ–± —Ç–∏ –º—ñ–≥ –¥–∞–ª—ñ –∑–∞ —Ç–∏–º –∂–µ —à–∞–±–ª–æ–Ω–æ–º).

---

## 1. –î–µ –æ—Å–Ω–æ–≤–Ω—ñ –≥–∞–ª—å–º–∞ –≤ —Ü—å–æ–º—É APEX-–∑–∞–ø–∏—Ç—ñ

### üî¥ 1) –í–µ–ª–∏–∫–∏–π –±–ª–æ–∫ `AND ( ... OR ... OR ... )` –ø–æ `:P1_TAB_MODE`

```sql
AND (
 (P1.TAB_MODE = 'PLANNED' AND (...))
 OR (:P1_TAB_MODE = 'TODO' AND (...))
 OR (:P1_TAB_MODE = 'SHIFT' AND (...))
 OR (:P1_TAB_MODE = 'PROBLEM' AND (...))
 OR (:P1_TAB_MODE = 'ARCHIVE' AND s.STATUS_MAIN_ID = 0)
)
```

–î–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä–∞ —Ü–µ –¥—É–∂–µ –ø–æ–≥–∞–Ω–æ:

* —É–º–æ–≤–∏ –ø–æ —Ä—ñ–∑–Ω–∏—Ö —Ä–µ–∂–∏–º–∞—Ö ‚Äú–Ω–∞–≤–∞–ª–µ–Ω—ñ‚Äù –æ–¥–Ω–∏–º OR;
* —á–∞—Å—Ç–∏–Ω–∞ –∑ –Ω–∏—Ö –º—ñ—Å—Ç–∏—Ç—å `EXISTS` –∑ dblink, date-between, —Ç–æ—â–æ;
* Oracle –Ω–µ –º–æ–∂–µ –¥–æ–±—Ä–µ ‚Äú–≤—ñ–¥—Å—ñ–∫—Ç–∏‚Äù –≥—ñ–ª–∫–∏ –¥–ª—è –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É, –æ—Å–æ–±–ª–∏–≤–æ –∑ –±—ñ–Ω–¥–∞–º–∏.

### üî¥ 2) –ó–∞–π–≤–∏–π `GROUP BY` –≤ `tasks_with_access`

–£ CTE `tasks_with_access` —Ç–∏ —Ä–æ–±–∏—à `GROUP BY` –ø–æ –≤—Å—ñ–º –∫–æ–ª–æ–Ω–∫–∞–º `t.*`, –∞–ª–µ **–Ω–µ–º–∞—î –∂–æ–¥–Ω–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó** (`SUM`, `COUNT` —Ç–æ—â–æ). –¶–µ:

* –∑–º—É—à—É—î Oracle —Ä–æ–±–∏—Ç–∏ –∑–∞–π–≤–∏–π SORT/GROUP BY;
* —Ñ–∞–∫—Ç–∏—á–Ω–æ –ø—Ä–∞—Ü—é—î —è–∫ `SELECT DISTINCT`, —Ç—ñ–ª—å–∫–∏ –¥–æ—Ä–æ–∂—á–µ.

### üî¥ 3) –ü–æ–≤—Ç–æ—Ä–Ω—ñ `EXISTS` –ø–æ —Ç–∏—Ö —Å–∞–º–∏—Ö —Ç–∞–±–ª–∏—Ü—è—Ö

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ª–æ–≥—ñ–∫–∞ ‚Äú–ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–µ / –Ω–µ–¥–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è‚Äù –≤ `PROBLEM` —ñ –ø–æ—Ç—ñ–º **—â–µ —Ä–∞–∑** –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤ `STATUS_LABEL_PROBLEM`, `STATUS_LABEL_PLANNED`, `STATUS_LABEL_SHIFT`:

```sql
EXISTS (
  SELECT 1
  FROM TaskTracker.DICT_APP_CONFIRM_LIST@... d
  WHERE d.PAGE_LIST_ID = t.PAGE_LIST_ID AND d.PARENT_STAGE_ID IS NOT NULL 
    AND NOT EXISTS (
      SELECT 1
      FROM TaskTracker.SIGNATURERIGHTS@... r
      WHERE r.TASK_ID = t.TASK_ID AND r.STAGES_ID = d.ID
    )
)
```

–¢–∞–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ ‚Üí –∫–æ–∂–µ–Ω —Ä–∞–∑ –Ω–æ–≤–∏–π –ø—Ä–æ—Ö—ñ–¥ –ø–æ dblink —Ç–∞–±–ª–∏—Ü—è—Ö.

### üî¥ 4) VIEWED_BY ‚Äì –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ –≤ SELECT

–£ SELECT‚Äô—ñ –∑–¥–æ—Ä–æ–≤–µ–Ω–Ω–∏–π `CASE ... WHEN :PO_SUBSTITUTION_MODE = ...` —ñ –≤ –∫–æ–∂–Ω—ñ–π –≥—ñ–ª—Ü—ñ:

```sql
SELECT ... 
FROM TASK_VIEWED@...
JOIN PERSONAL@...
WHERE tv.TASK_ID = t.TASK_ID
  AND tv.USER_ID = :PO_CUR_USER_TABNO
  [AND —É–º–æ–≤–∏ –ø–æ –∑–º—ñ–Ω—ñ]
FETCH FIRST ROW ONLY
```

–î–ª—è **–∫–æ–∂–Ω–æ–≥–æ** —Ä—è–¥–∫–∞ –∑–∞–¥–∞—á—ñ –æ–∫—Ä–µ–º–∏–π remote-–∑–∞–ø–∏—Ç —É `TASK_VIEWED` + `PERSONAL`.

---

## 2. –©–æ –¥–∞—Å—Ç—å –Ω–∞–π–±—ñ–ª—å—à–∏–π –ø—Ä–∏—Ä—ñ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ

### ‚úÖ 1) –†–æ–∑–±–∏—Ç–∏ —Ä–µ–∂–∏–º–∏ (`PLANNED`, `TODO`, `SHIFT`, `PROBLEM`, `ARCHIVE`) –Ω–∞ `UNION ALL`

–ó–∞–º—ñ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –≥—ñ–≥–∞–Ω—Ç—Å—å–∫–æ–≥–æ WHERE –∑ OR –ø–æ `:P1_TAB_MODE`, —Ä–æ–±–∏–º–æ:

```sql
SELECT ... 
FROM tasks_with_access t
JOIN ... 
WHERE :P1_TAB_MODE = 'PLANNED'
  AND s.status_main_id <> 0
  AND ((t.planning_date_end > SYSDATE AND t.actual_date_end IS NULL) ...)

UNION ALL

SELECT ...
FROM tasks_with_access t
JOIN ...
WHERE :P1_TAB_MODE = 'TODO'
  AND r.user_tabno = uc.user_id
  AND NOT EXISTS (... TODO-–ª–æ–≥—ñ–∫–∞ ...)

UNION ALL

SELECT ...
FROM tasks_with_access t
...
WHERE :P1_TAB_MODE = 'SHIFT'
  AND s.status_main_id <> 0
  AND (—É–º–æ–≤–∏ –ø–æ –∑–º—ñ–Ω—ñ)

-- —ñ —Ç.–¥. –¥–ª—è PROBLEM, ARCHIVE
```

–ï—Ñ–µ–∫—Ç:

* –¥–ª—è **–∫–æ–∂–Ω–æ—ó –≥—ñ–ª–∫–∏** ‚Äì —Å–≤—ñ–π –ø–ª–∞–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è;
* –≤ —Ä–µ–∂–∏–º—ñ `TODO` Oracle –Ω–µ —Ç—è–≥–Ω–µ –∑–∞–π–≤—ñ `EXISTS` –¥–ª—è `PROBLEM`;
* –¥–ª—è `ARCHIVE` –º–æ–∂–Ω–∞ –≤–∑–∞–≥–∞–ª—ñ –Ω–µ —á—ñ–ø–∞—Ç–∏ `DICT_APP_CONFIRM_LIST` —ñ `SIGNATURERIGHTS`.

–ù–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ —Ü–µ —á–∞—Å—Ç–æ –¥–∞—î **–¥—É–∂–µ –≤—ñ–¥—á—É—Ç–Ω–∏–π –±—É—Å—Ç**.

---

### ‚úÖ 2) –ü—Ä–∏–±—Ä–∞—Ç–∏ –∑–∞–π–≤–∏–π `GROUP BY` –≤ `tasks_with_access`

–£ CTE:

```sql
tasks_with_access AS (
  SELECT t.*
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN ...
  WHERE ...
  GROUP BY t.TASK_ID, ... t.DATE_CREATE
)
```

–Ø–∫—â–æ —É —Ç–µ–±–µ **–Ω–µ–º–∞—î** –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤ (COUNT/SUM/MIN/MAX...), —Ç–æ:

* –∞–±–æ –ø—Ä–∏–±–∏—Ä–∞—î—à `GROUP BY` –ø–æ–≤–Ω—ñ—Å—Ç—é;
* –∞–±–æ, —è–∫—â–æ –±–æ—ó—à—Å—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ —á–µ—Ä–µ–∑ JOIN‚Äô–∏, —Ä–æ–±–∏—à `SELECT DISTINCT t.*`.

```sql
tasks_with_access AS (
  SELECT DISTINCT t.*
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s ON s.ID = t.STATUS_ID
  LEFT JOIN tasktracker.signaturerights@to_tasktracker10 r ON r.task_id = t.task_id
  WHERE ... (–¥–æ—Å—Ç—É–ø + –±–∞–∑–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏)
)
```

`DISTINCT` –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –¥—É–±–ª—é—é—á–∏—Ö —Ä—è–¥–∫—ñ–≤ –¥–µ—à–µ–≤—à–∏–π —ñ –ø—Ä–æ—Å—Ç—ñ—à–∏–π –∑–∞ –≤–µ–ª–∏—á–µ–∑–Ω–∏–π `GROUP BY` –ø–æ –≤—Å—ñ–º –∫–æ–ª–æ–Ω–∫–∞–º.

---

### ‚úÖ 3) –í–∏–Ω–µ—Å—Ç–∏ ‚Äú–ø—Ä–æ–±–ª–µ–º–Ω—ñ—Å—Ç—å‚Äù –∑–∞–≤–¥–∞–Ω–Ω—è –≤ –æ–∫—Ä–µ–º–∏–π CTE/–∫–æ–ª–æ–Ω–∫–∏ –≤ `V_TASKS_FULL`

–¢–∏ **–∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤** –æ–±—á–∏—Å–ª—é—î—à:

* ‚Äú–ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–µ‚Äù ‚Üí `t.PLANNING_DATE_END < SYSDATE AND t.ACTUAL_DATE_END IS NULL`
* ‚Äú–Ω–µ–¥–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–µ‚Äù ‚Üí –æ—Ç–∞ –∑–¥–æ—Ä–æ–≤–µ–Ω–Ω–∞ `EXISTS (...)` –ø–æ `DICT_APP_CONFIRM_LIST` —ñ `SIGNATURERIGHTS`.

–ü—Ä–æ—Å—Ç—ñ—à–µ:

1. –î–æ–¥–∞–π —É `V_TASKS_FULL` (–∞–±–æ –Ω–æ–≤–∏–π CTE) –∫–æ–ª–æ–Ω–∫–∏:

```sql
is_overdue      NUMBER(1),
is_incomplete   NUMBER(1)
```

2. –¢–æ–¥—ñ –≤ APEX-–∑–∞–ø–∏—Ç—ñ:

```sql
-- —Ñ—ñ–ª—å—Ç—Ä –¥–ª—è PROBLEM
WHERE :P1_TAB_MODE = 'PROBLEM'
  AND s.status_main_id <> 0
  AND (t.is_overdue = 1 OR t.is_incomplete = 1)

-- –¥–ª—è —Å—Ç–∞—Ç—É—Å-—ñ–∫–æ–Ω–æ–∫
STATUS_LABEL_PROBLEM AS
CASE
  WHEN t.is_overdue = 1 AND t.is_incomplete = 1 THEN '<–¥–≤—ñ —ñ–∫–æ–Ω–∫–∏>'
  WHEN t.is_overdue = 1 THEN '<—ñ–∫–æ–Ω–∫–∞ overdue>'
  WHEN t.is_incomplete = 1 THEN '<—ñ–∫–æ–Ω–∫–∞ incomplete>'
END
```

–ñ–æ–¥–Ω–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö `EXISTS` —É SELECT‚Äô—ñ ‚Äì —É—Å–µ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω–æ —É view/CTE.

---

### ‚úÖ 4) –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ VIEWED_BY: –æ–¥–∏–Ω JOIN –∑–∞–º—ñ—Å—Ç—å –∫—É–ø–∏ SELECT‚Äô—ñ–≤

–ó–∞—Ä–∞–∑ —É SELECT:

* –≤–µ–ª–∏–∫–∞ `CASE WHEN :PO_SUBSTITUTION_MODE = 0/1 ...`
* —ñ –≤ –∫–æ–∂–Ω—ñ–π –≥—ñ–ª—Ü—ñ –ø–æ `SELECT ... FROM TASK_VIEWED ... WHERE tv.TASK_ID = t.TASK_ID AND tv.USER_ID = :...`.

–ü–∞—Ç–µ—Ä–Ω –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —Ç–∞–∫–∏–π:

1. –°—Ç–≤–æ—Ä—é—î—à CTE `user_ctx` (–≤–∂–µ —î).
2. –†–æ–±–∏—à CTE `viewed_ctx` ‚Äì –≤—Å—ñ –ø–µ—Ä–µ–≥–ª—è–¥–∏ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (cur –∞–±–æ new), –æ–¥—Ä–∞–∑—É –∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ —Ç–∞, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏, —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ –∑–º—ñ–Ω—ñ.

```sql
viewed_ctx AS (
  SELECT
    tv.task_id,
    tv.date_viewed,
    tv.substitution_id,
    us.familia  AS fam,
    us.imya     AS name,
    us.otchestvo AS pat,
    us.spr_dolznost AS dol,
    us.tseh_short AS tseh,
    us1.familia AS sub_fam,
    us1.imya    AS sub_name,
    us1.otchestvo AS sub_pat
  FROM TaskTracker.TASK_VIEWED@TO_TASKTRACKER10 tv
  CROSS JOIN user_ctx uc
  JOIN kbs.personal@TO_TASKTRACKER10 us
    ON us.tab_no = tv.user_id
   AND us.priznak IS NULL
  LEFT JOIN kbs.personal@TO_TASKTRACKER10 us1
    ON us1.tab_no = tv.substitution_id
   AND us1.priznak IS NULL
  WHERE tv.user_id = uc.user_id
    -- —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä –ø–æ –∑–º—ñ–Ω—ñ:
    AND (
      (uc_position_has_shift = 'N' OR uc_position_has_shift IS NULL)
      OR (
        TO_DATE(TO_CHAR(tv.date_viewed, 'DD.MM.YYYY HH24:MI'),'DD.MM.YYYY HH24:MI')
        BETWEEN TO_DATE(:P0_SHIFT_START,'DD.MM.YYYY HH24:MI')
            AND TO_DATE(:P0_SHIFT_END,'DD.MM.YYYY HH24:MI')
      )
    )
),
viewed_agg AS (
  SELECT
    task_id,
    /* —Ç—É—Ç —è–∫—â–æ —Ç—Ä–µ–±–∞ ‚Äì ROWNUM=1 —á–µ—Ä–µ–∑ ROW_NUMBER OVER (PARTITION BY task_id ...) */
    (—Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è HTML-—Å—Ç—Ä–æ–∫–∏ –∑ fam/name/dol/... –Ω–∞ –æ—Å–Ω–æ–≤—ñ substitution_id) AS viewed_html
  FROM (
    SELECT
      v.*,
      ROW_NUMBER() OVER (PARTITION BY v.task_id ORDER BY v.date_viewed DESC) rn
    FROM viewed_ctx v
  )
  WHERE rn = 1
)
```

3. –í –æ—Å–Ω–æ–≤–Ω–æ–º—É SELECT –ø—Ä–æ—Å—Ç–æ:

```sql
LEFT JOIN viewed_agg v ON v.task_id = t.task_id

...

COALESCE(v.viewed_html,
         '<span class="fa fa-circle text-muted" title="–ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ"></span> –ù–µ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ') AS VIEWED_BY
```

–Ü –≤—Å—è –ø–æ—Ç–≤–æ—Ä–∞ –∑ –ø–æ–¥–≤—ñ–π–Ω–∏–º–∏ SELECT‚Äô–∞–º–∏, `FETCH FIRST ROW ONLY` —ñ —É–º–æ–≤–∞–º–∏ –ø–æ SUBSTITUTION_MODE –π–¥–µ —É CTE, –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**.

---

## 3. –ü—Ä–∏–∫–ª–∞–¥ —Å–∫–æ—Ä–æ—á–µ–Ω–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É

–©–æ–± –Ω–µ –º–∞–ª—é–≤–∞—Ç–∏ —Ç–æ–±—ñ —â–µ –æ–¥–Ω–æ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞ –Ω–∞ 1000 —Ä—è–¥–∫—ñ–≤, –ø–æ–∫–∞–∂—É **–∫–∞—Ä–∫–∞—Å**, —É —è–∫–∏–π —Ç–∏ –∑–º–æ–∂–µ—à –≤—Å—Ç–∞–≤–ª—è—Ç–∏ —Å–≤–æ—é HTML-–ª–æ–≥—ñ–∫—É:

```sql
WITH user_ctx AS (
  SELECT
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID       ELSE :PO_CUR_USER_TABNO    END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID   ELSE :PO_CUR_USER_POSITION END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID ELSE :PO_CUR_USER_DEPARTMENT END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID       ELSE :PO_CUR_USER_UNIT     END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK      ELSE :PO_CUR_UCHASTOK      END AS uchastok_id
  FROM dual
),

tasks_with_access AS (
  SELECT DISTINCT
    t.*,
    s.status_main_id,
    r.user_tabno AS exec_user_tabno,
    r.stages_id  AS exec_stage_id
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10    s ON s.id = t.status_id
  LEFT JOIN TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r ON r.task_id = t.task_id
  WHERE
    -- —Ç—É—Ç —Ç—ñ–ª—å–∫–∏ –ª–æ–≥—ñ–∫–∞ access_control (EXISTS –∑ task_access_control),
    -- –±–µ–∑ —É–º–æ–≤ –ø–æ :P1_TAB_MODE, –±–µ–∑ TODO/SHIFT/PROBLEM
),

viewed_agg AS (
  -- —Ç—É—Ç –∞–≥—Ä–µ–≥—É—î—à "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–æ" –¥–ª—è user_ctx.user_id, —è–∫ –æ–ø–∏—Å–∞–Ω–æ –≤–∏—â–µ
),

-- –î–∞–ª—ñ ‚Äì UNION ALL –ø–æ —Ä–µ–∂–∏–º–∞—Ö
base_select AS (
  SELECT t.*, v.viewed_html
  FROM tasks_with_access t
  LEFT JOIN viewed_agg v ON v.task_id = t.task_id
)

SELECT ...
FROM (
  -- PLANNED
  SELECT *
  FROM base_select
  WHERE :P1_TAB_MODE = 'PLANNED'
    AND status_main_id <> 0
    AND (—É–º–æ–≤–∏ PLANNED)

  UNION ALL

  -- TODO
  SELECT *
  FROM base_select
  WHERE :P1_TAB_MODE = 'TODO'
    AND exec_user_tabno = (SELECT user_id FROM user_ctx)
    AND NOT EXISTS (... TODO-–ª–æ–≥—ñ–∫–∞ ...)

  UNION ALL

  -- SHIFT
  SELECT *
  FROM base_select
  WHERE :P1_TAB_MODE = 'SHIFT'
    AND status_main_id <> 0
    AND (—É–º–æ–≤–∏ –ø–æ –∑–º—ñ–Ω—ñ)

  UNION ALL

  -- PROBLEM
  SELECT *
  FROM base_select
  WHERE :P1_TAB_MODE = 'PROBLEM'
    AND status_main_id <> 0
    AND (t.is_overdue = 1 OR t.is_incomplete = 1)

  UNION ALL

  -- ARCHIVE
  SELECT *
  FROM base_select
  WHERE :P1_TAB_MODE = 'ARCHIVE'
    AND status_main_id = 0
)
ORDER BY date_create DESC;
```

---

## –ù–∞ —â–æ —è –±–∏ –ø–æ–¥–∏–≤–∏–≤—Å—è –≤ –ø–µ—Ä—à—É —á–µ—Ä–≥—É –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ

–Ø–∫—â–æ —Ö–æ—á–µ—à **–º—ñ–Ω—ñ–º—É–º –∑–º—ñ–Ω ‚Üí –º–∞–∫—Å–∏–º—É–º –µ—Ñ–µ–∫—Ç—É**, —Ç–æ –ø–æ—Ä—è–¥–æ–∫ —Ç–∞–∫–∏–π:

1. üü¢ –ü—Ä–∏–±—Ä–∞—Ç–∏/–ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ `GROUP BY` –∑ `tasks_with_access`.
2. üü¢ –í–∏–Ω–µ—Å—Ç–∏ –ª–æ–≥—ñ–∫—É `PROBLEM` (overdue/incomplete) –≤ `V_TASKS_FULL` —É –≤–∏–≥–ª—è–¥—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤.
3. üü¢ –ó—Ä–æ–±–∏—Ç–∏ `UNION ALL` –ø–æ `:P1_TAB_MODE` –∑–∞–º—ñ—Å—Ç—å –≤–µ–ª–∏–∫–æ–≥–æ OR.
4. üü¢ –í–∏–Ω–µ—Å—Ç–∏ VIEWED_BY –≤ CTE `viewed_agg`, —è–∫ —è –ø–æ–∫–∞–∑–∞–≤, —ñ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—î–¥–Ω—É–≤–∞—Ç–∏.

–¶—ñ 4 –∫—Ä–æ–∫–∏ –≤–∂–µ –¥—É–∂–µ –≤—ñ–¥—á—É—Ç–Ω–æ –∑–º–µ–Ω—à–∞—Ç—å —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ –∑–∞–¥–∞—á —ñ history –±–∞–≥–∞—Ç–æ –π —É—Å–µ —Ü–µ —Ö–æ–¥–∏—Ç—å –ø–æ dblink.

–Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–µ–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º **–≤–∑—è—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —à–º–∞—Ç–æ–∫** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, TODO –∞–±–æ PROBLEM) —ñ —è –ø–µ—Ä–µ–ø–∏—à—É –π–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç—ñ `UNION ALL` + CTE –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –ø—Ä–∞—Ü—é—é—á–∏–º SQL, —è–∫–∏–π —Ç–∏ –∑–º–æ–∂–µ—à –æ–¥—Ä–∞–∑—É –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –≤ APEX —ñ —Ç–µ—Å—Ç–æ–≤–æ –∑–∞–º—ñ—Ä—è—Ç–∏.
