–û–∫, –¥–∞–≤–∞–π —Ä–æ–±–∏—Ç–∏ —Ü–µ —Å–∏—Å—Ç–µ–º–Ω–æ –π –±–µ–∑ –ø–æ—Å–ø—ñ—Ö—É üòä
–Ü–¥–µ—è —Ç–∞–∫–∞: **–æ–¥–∏–Ω** –∑–∞–ø–∏—Ç —Ä–∞—Ö—É—î **—É—Å—ñ –≤–∫–ª–∞–¥–∫–∏** (`PLANNED / TODO / SHIFT / PROBLEM / ARCHIVE`), –∑–∞–º—ñ—Å—Ç—å 5 –æ–∫—Ä–µ–º–∏—Ö.

–Ø –ø–æ–∫–∞–∂—É:

1. –°–ø—ñ–ª—å–Ω–∏–π `WITH` (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ + –∑–∞–¥–∞—á—ñ –∑ –¥–æ—Å—Ç—É–ø–æ–º).
2. –ü–æ —á–µ—Ä–∑—ñ –ø—Ä–æ–ø–∏—à–µ–º–æ —É–º–æ–≤–∏ –¥–ª—è:

   * `PLANNED`
   * `PROBLEM`
   * `TODO`
   * `SHIFT`
   * `ARCHIVE`
3. –°–∫–ª–∞–¥–µ–º–æ –≤—Å–µ –≤ –æ–¥–∏–Ω —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π `SELECT` –∑ `SUM(CASE ...)`.

---

## 1Ô∏è‚É£ –°–ø—ñ–ª—å–Ω–∏–π –∫–∞—Ä–∫–∞—Å: `user_ctx` + `tasks_with_access_base`

–¢—É—Ç **–Ω–µ–º–∞—î** —â–µ `:P1_TAB_MODE`. –õ–∏—à–µ ‚Äú—è–∫—ñ –∑–∞–¥–∞—á—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∑–∞–≥–∞–ª—ñ –±–∞—á–∏—Ç—å‚Äù.

```sql
WITH user_ctx AS (
  SELECT
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID        ELSE :PO_CUR_USER_TABNO      END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID    ELSE :PO_CUR_USER_POSITION   END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID  ELSE :PO_CUR_USER_DEPARTMENT END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID        ELSE :PO_CUR_USER_UNIT       END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK       ELSE :PO_CUR_UCHASTOK        END AS uchastok_id
  FROM dual
),

tasks_with_access_base AS (
  SELECT DISTINCT
    t.task_id,
    t.planning_date_start,
    t.planning_date_end,
    t.actual_date_end,
    t.page_list_id,
    t.status_id,
    s.status_main_id
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s
    ON s.id = t.status_id
  WHERE
    (
      /* —Ç—É—Ç —Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞ ACCESS CONTROL, –∞–ª–µ –ë–ï–ó :P1_TAB_MODE */
      EXISTS ( 
        /* level 1 ‚Äì –∞–¥–∞–ø—Ç—É–π 1:1 –∑—ñ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–ø–∏—Ç—É, —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ EXISTS */
      )
      OR EXISTS (
        /* level 2 */
      )
      OR EXISTS (
        /* level 3 */
      )
      OR EXISTS (
        /* –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SIGNATURERIGHTS */
        SELECT 1
        FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
        CROSS JOIN user_ctx uc2
        WHERE sr.task_id = t.task_id
          AND (
               sr.user_tabno = uc2.user_id
            OR (
                 sr.position_id   = uc2.position_id
             AND sr.department_id = uc2.department_id
             AND (sr.unit_id   IS NULL OR sr.unit_id   = uc2.unit_id)
             AND (sr.uchastok  IS NULL OR sr.uchastok  = uc2.uchastok_id)
               )
          )
      )
      OR EXISTS (
        /* –∞–≤—Ç–æ—Ä –∑–∞–¥–∞—á—ñ */
        SELECT 1
        FROM user_ctx uc3
        WHERE t.creator_id = uc3.user_id
      )
    )
)
```

üîπ –ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –º–∏ –º–∞—î–º–æ **–≤—Å—ñ –∑–∞–¥–∞—á—ñ, –¥–æ —è–∫–∏—Ö —î –¥–æ—Å—Ç—É–ø**, —ñ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –Ω–∞–±—ñ—Ä –ø–æ–ª—ñ–≤ –¥–ª—è —É–º–æ–≤ –≤–∫–ª–∞–¥–æ–∫.

---

## 2Ô∏è‚É£ PLANNED ‚Äì —É–º–æ–≤–∞ –≤ `CASE`

–¢–≤–æ—è —Å—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `PLANNED` –±—É–ª–∞:

```sql
:P1_TAB_MODE = 'PLANNED' AND
(
  (s.STATUS_MAIN_ID <> 0 AND t.PLANNING_DATE_END > SYSDATE)
  OR (s.STATUS_MAIN_ID <> 0 AND t.ACTUAL_DATE_END IS NULL)
)
```

–î–ª—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Ä–æ–±–∏–º–æ:

```sql
SUM(
  CASE
    WHEN status_main_id <> 0
     AND (planning_date_end > SYSDATE OR actual_date_end IS NULL)
    THEN 1 ELSE 0
  END
) AS cnt_planned
```

---

## 3Ô∏è‚É£ PROBLEM ‚Äì —É–º–æ–≤–∞

–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞:

```sql
:P1_TAB_MODE = 'PROBLEM'
AND s.STATUS_MAIN_ID <> 0
AND (
  (t.PLANNING_DATE_END < SYSDATE AND t.ACTUAL_DATE_END IS NULL) 
  OR EXISTS (
        SELECT 1
        FROM TaskTracker.DICT_APP_CONFIRM_LIST d
        WHERE d.PAGE_LIST_ID = t.PAGE_LIST_ID
          AND d.PARENT_STAGE_ID IS NOT NULL 
          AND NOT EXISTS (
                SELECT 1
                FROM TaskTracker.SIGNATURERIGHTS r
                WHERE r.TASK_ID = t.TASK_ID
                  AND r.STAGES_ID = d.ID
          )
    )
)
```

–õ—ñ—á–∏–ª—å–Ω–∏–∫:

```sql
SUM(
  CASE
    WHEN status_main_id <> 0
     AND (
           (planning_date_end < SYSDATE AND actual_date_end IS NULL)
        OR EXISTS (
             SELECT 1
             FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 d
             WHERE d.page_list_id     = page_list_id
               AND d.parent_stage_id IS NOT NULL
               AND NOT EXISTS (
                     SELECT 1
                     FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r2
                     WHERE r2.task_id   = task_id
                       AND r2.stages_id = d.id
                   )
           )
        )
    THEN 1 ELSE 0
  END
) AS cnt_problem
```

---

## 4Ô∏è‚É£ TODO ‚Äì —É–º–æ–≤–∞

–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞ (—Å–ø—Ä–æ—â—É—é –¥–æ –∑–º—ñ—Å—Ç—É):

```sql
:P1_TAB_MODE = 'TODO'
AND r.user_tabno = uc.user_id
AND NOT EXISTS (
      SELECT 1 FROM signaturehistory h
      WHERE h.signright_id = r.id
        AND h.new_status_id IS NOT NULL
)
AND NOT EXISTS (
      SELECT 1
      FROM signaturerights r_prev
      WHERE r_prev.task_id   = r.task_id
        AND r_prev.stages_id < r.stages_id
        AND NOT EXISTS (
              SELECT 1
              FROM signaturehistory h2
              WHERE h2.signright_id = r_prev.id
                AND h2.new_status_id IS NOT NULL
        )
)
```

–£ `COUNT` –∫—Ä–∞—â–µ –∑—Ä–æ–±–∏—Ç–∏ —á–µ—Ä–µ–∑ `EXISTS`, –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä–∏—î–¥–Ω–∞–Ω–∏–π `r`. –ú–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `user_ctx` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ:

```sql
SUM(
  CASE
    WHEN EXISTS (
           SELECT 1
           FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
           CROSS JOIN user_ctx uc
           WHERE r.task_id   = task_id
             AND r.user_tabno = uc.user_id
             -- –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—É –ø—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ —Ü—å–æ–º—É signright
             AND NOT EXISTS (
                   SELECT 1
                   FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h
                   WHERE h.signright_id = r.id
                     AND h.new_status_id IS NOT NULL
                 )
             -- –≤—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Å—Ç–∞–¥—ñ—ó –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ
             AND NOT EXISTS (
                   SELECT 1
                   FROM tasktracker.signaturerights@TO_TASKTRACKER10 r_prev
                   WHERE r_prev.task_id   = r.task_id
                     AND r_prev.stages_id < r.stages_id
                     AND NOT EXISTS (
                           SELECT 1
                           FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h2
                           WHERE h2.signright_id = r_prev.id
                             AND h2.new_status_id IS NOT NULL
                         )
                 )
         )
    THEN 1 ELSE 0
  END
) AS cnt_todo
```

üîπ –¶–µ 1:1 —Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞, —Ç—ñ–ª—å–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ —è–∫ `EXISTS` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `CASE`.

---

## 5Ô∏è‚É£ SHIFT ‚Äì —É–º–æ–≤–∞

–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞:

```sql
:P1_TAB_MODE = 'SHIFT'
AND s.STATUS_MAIN_ID <> 0
AND (
     t.planning_date_start BETWEEN :PO_SHIFT_START AND :PO_SHIFT_END
  OR t.planning_date_end   BETWEEN :PO_SHIFT_START AND :PO_SHIFT_END
  OR EXISTS (
        SELECT 1
        FROM signaturerights sr
        WHERE sr.task_id        = t.task_id
          AND sr.shift_symbol_id = :PO_SHIFT_SYMBOL
     )
)
```

–õ—ñ—á–∏–ª—å–Ω–∏–∫:

```sql
SUM(
  CASE
    WHEN status_main_id <> 0
     AND (
           planning_date_start BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                  AND TO_DATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI')
        OR planning_date_end   BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                  AND TO_DATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI')
        OR EXISTS (
             SELECT 1
             FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
             WHERE sr.task_id        = task_id
               AND sr.shift_symbol_id = :PO_SHIFT_SYMBOL
           )
        )
    THEN 1 ELSE 0
  END
) AS cnt_shift
```

---

## 6Ô∏è‚É£ ARCHIVE ‚Äì —É–º–æ–≤–∞

–°—Ç–∞—Ä–∞ –ª–æ–≥—ñ–∫–∞:

```sql
:P1_TAB_MODE = 'ARCHIVE' AND s.STATUS_MAIN_ID = 0
```

–õ—ñ—á–∏–ª—å–Ω–∏–∫:

```sql
SUM(
  CASE
    WHEN status_main_id = 0
    THEN 1 ELSE 0
  END
) AS cnt_archive
```

---

## 7Ô∏è‚É£ –°–∫–ª–∞–¥–∞—î–º–æ –≤—Å–µ —Ä–∞–∑–æ–º: —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç –Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏

–û—Ç —Ç–µ–ø–µ—Ä –º–æ–∂–µ—à –∑—ñ–±—Ä–∞—Ç–∏ **–æ–¥–∏–Ω** SQL, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **1 —Ä—è–¥–æ–∫ –∑ 5 –∫–æ–ª–æ–Ω–∫–∞–º–∏**:

```sql
WITH user_ctx AS (
  SELECT
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID        ELSE :PO_CUR_USER_TABNO      END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID    ELSE :PO_CUR_USER_POSITION   END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID  ELSE :PO_CUR_USER_DEPARTMENT END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID        ELSE :PO_CUR_USER_UNIT       END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK       ELSE :PO_CUR_UCHASTOK        END AS uchastok_id
  FROM dual
),

tasks_with_access_base AS (
  SELECT DISTINCT
    t.task_id,
    t.planning_date_start,
    t.planning_date_end,
    t.actual_date_end,
    t.page_list_id,
    t.status_id,
    s.status_main_id
  FROM V_TASKS_FULL t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s
    ON s.id = t.status_id
  WHERE
    (
      /* —Ç—É—Ç –≤—Å—Ç–∞–≤–ª—è—î—à —Å–≤–æ—é –ª–æ–≥—ñ–∫—É ACCESS CONTROL –∑ EXISTS,
         –±–µ–∑ :P1_TAB_MODE, —Ç—ñ–ª—å–∫–∏ "—è–∫—ñ –∑–∞–¥–∞—á—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å" */
      1 = 1
    )
)

SELECT
  /* PLANNED */
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (planning_date_end > SYSDATE OR actual_date_end IS NULL)
      THEN 1 ELSE 0
    END
  ) AS cnt_planned,

  /* TODO */
  SUM(
    CASE
      WHEN EXISTS (
             SELECT 1
             FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
             CROSS JOIN user_ctx uc
             WHERE r.task_id    = task_id
               AND r.user_tabno = uc.user_id
               AND NOT EXISTS (
                     SELECT 1
                     FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h
                     WHERE h.signright_id = r.id
                       AND h.new_status_id IS NOT NULL
                   )
               AND NOT EXISTS (
                     SELECT 1
                     FROM tasktracker.signaturerights@TO_TASKTRACKER10 r_prev
                     WHERE r_prev.task_id   = r.task_id
                       AND r_prev.stages_id < r.stages_id
                       AND NOT EXISTS (
                             SELECT 1
                             FROM tasktracker.signaturehistory@TO_TASKTRACKER10 h2
                             WHERE h2.signright_id = r_prev.id
                               AND h2.new_status_id IS NOT NULL
                           )
                   )
           )
      THEN 1 ELSE 0
    END
  ) AS cnt_todo,

  /* SHIFT */
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (
             planning_date_start BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                    AND TO_DATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI')
          OR planning_date_end   BETWEEN TO_DATE(:PO_SHIFT_START,'DD.MM.YYYY HH24:MI')
                                    AND TO_DATE(:PO_SHIFT_END,  'DD.MM.YYYY HH24:MI')
          OR EXISTS (
               SELECT 1
               FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
               WHERE sr.task_id         = task_id
                 AND sr.shift_symbol_id = :PO_SHIFT_SYMBOL
             )
          )
      THEN 1 ELSE 0
    END
  ) AS cnt_shift,

  /* PROBLEM */
  SUM(
    CASE
      WHEN status_main_id <> 0
       AND (
             (planning_date_end < SYSDATE AND actual_date_end IS NULL)
          OR EXISTS (
               SELECT 1
               FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 d
               WHERE d.page_list_id     = page_list_id
                 AND d.parent_stage_id IS NOT NULL
                 AND NOT EXISTS (
                       SELECT 1
                       FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r2
                       WHERE r2.task_id   = task_id
                         AND r2.stages_id = d.id
                     )
             )
          )
      THEN 1 ELSE 0
    END
  ) AS cnt_problem,

  /* ARCHIVE */
  SUM(
    CASE
      WHEN status_main_id = 0
      THEN 1 ELSE 0
    END
  ) AS cnt_archive

FROM tasks_with_access_base;
```

---

–î–∞–ª—ñ —Ç–∏ –≤–∂–µ –≤–∏—Ä—ñ—à—É—î—à, —è–∫ —Ü–µ –∑–∞–±–∏—Ä–∞—Ç–∏ –≤ APEX:

* –∞–±–æ —è–∫ –æ–∫—Ä–µ–º–∏–π —Ä–µ–ø–æ—Ä—Ç –∑ 1 —Ä—è–¥–∫–æ–º —ñ 5 –∫–æ–ª–æ–Ω–∫–∞–º–∏ + JS –≤ –±–µ–π–¥–∂–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫,
* –∞–±–æ —á–µ—Ä–µ–∑ PL/SQL process ‚Üí 5 page item‚Äô—ñ–≤ (`P1_CNT_PLANNED` —ñ —Ç.–¥.), —è–∫—ñ –≤—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è –≤ –ø—ñ–¥–ø–∏—Å–∏ —Ç–∞–±—ñ–≤.

–Ø–∫—â–æ —Ö–æ—á–µ—à, –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂–µ–º–æ –≤–∑—è—Ç–∏ **–æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —á–∞—Å—Ç–∏–Ω—É** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç—ñ–ª—å–∫–∏ `TODO`) —ñ —Ç–∏ –Ω–∞ —Å–≤–æ—î–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—à, —â–æ COUNT –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ —Ç–∏–º, —â–æ –¥–∞—î —Ç–≤—ñ–π —Å—Ç–∞—Ä–∏–π –∑–∞–ø–∏—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `TODO`.
