–¢–∞–∫, —Ç–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–ª–æ–≤–∏–≤ –≥–æ–ª–æ–≤–Ω—É –ø—Ä–æ–±–ª–µ–º—É üëè

* `task_access_control` **–Ω–µ –º–∞—î `task_id`**, —Ç–æ–±—Ç–æ —Ü–µ *–ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø—É*, –∞ –Ω–µ –ø—Ä–∏–≤‚Äô—è–∑–∫–∞ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∑–∞–¥–∞—á.
* –£ –º–æ—î–º—É –≤–∞—Ä—ñ–∞–Ω—Ç—ñ `access_lvl1 / lvl2 / lvl3` —è —ó—Ö –Ω–µ–≤–¥–∞–ª–æ ‚Äú—Å–∫–ª–µ—ó–≤‚Äù –∑ `V_TASKS_FULL_2`, —É —Ç–µ–±–µ –∑–∞—Ä–∞–∑ —Ç–µ–∂ —É –∫–æ–∂–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ:

```sql
FROM V_TASKS_FULL_2 t
CROSS JOIN user_ctx uc
JOIN task_access_control ac ...
```

–¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ **view –∑ –∑–∞–¥–∞—á–∞–º–∏ —Å–∫–∞–Ω—É—î—Ç—å—Å—è 2‚Äì3 —Ä–∞–∑–∏** + –∫—Ä–æ—Å-–ø—Ä–æ–¥—É–∫—Ç –∑ ACL ‚Üí –º–∞—Å–∞ —Ä—è–¥–∫—ñ–≤, –ø–æ—Ç—ñ–º —Ü–µ —â–µ —Ä–∞–∑ –π–¥–µ —É `task_access`. –¢–æ–º—É:

> ‚úÖ View –æ–∫—Ä–µ–º–æ = 0.3 c
> ‚ùå View + –Ω–æ–≤–∏–π access control = –¥–æ–≤—à–µ, –Ω—ñ–∂ —Å—Ç–∞—Ä–∏–π –∫–æ–¥.

---

## 1. –ö–ª—é—á–æ–≤–∞ —ñ–¥–µ—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

–î–ª—è —Ç–∞–∫–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ ACL (–≥–ª–æ–±–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞, –±–µ–∑ `task_id`) **–Ω–µ –º–æ–∂–Ω–∞** –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ ‚Äú–ø—Ä–∏–∫—Ä—É—á—É–≤–∞—Ç–∏‚Äù `task_access_control` —á–µ—Ä–µ–∑ CTE, –¥–µ –≤–∂–µ —î `V_TASKS_FULL_2`.

–¢—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞–≤–ø–∞–∫–∏:

* **`V_TASKS_FULL_2` —á–∏—Ç–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –û–î–ò–ù —Ä–∞–∑** ‚Äî –≤ CTE `tasks_with_access`.
* –£—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É (`access_level`, `SIGNATURERIGHTS`, `CREATOR_ID`) —Ä–æ–±–∏–º–æ —á–µ—Ä–µ–∑ `EXISTS` —É `WHERE`, —è–∫ –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Ç–∏ –¥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü—å (`task_access_control`, `signaturerights`), **–±–µ–∑** –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö JOIN‚Äô—ñ–≤ –¥–æ view.

–¢–æ–±—Ç–æ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–ø–∏—Ç—É, –∞–ª–µ –∑:

1. –Ω–æ–≤–∏–º —à–≤–∏–¥–∫–∏–º view,
2. –≤–∏–Ω–µ—Å–µ–Ω–∏–º `user_ctx`,
3. –ø—Ä–∞–ø–æ—Ä—Ü—è–º–∏ `is_overdue` / `is_incomplete`,
4. —É—Å—ñ—î—é —ñ–Ω—à–æ—é –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—î—é (VIEWED_BY, UNION ALL –ø–æ –≤–∫–ª–∞–¥–∫–∞—Ö).

---

## 2. –Ø–∫ –º–∞—î –≤–∏–≥–ª—è–¥–∞—Ç–∏ `tasks_with_access` —É —Ç–≤–æ—ó–π —Å–∏—Ç—É–∞—Ü—ñ—ó

–ó–∞–º—ñ—Å—Ç—å `access_lvl1 / lvl2 / lvl3` –∑ `FROM V_TASKS_FULL_2` –≤ –∫–æ–∂–Ω–æ–º—É ‚Äî —Ä–æ–±–∏–º–æ –æ–¥–∏–Ω CTE:

```sql
tasks_with_access AS (
  SELECT DISTINCT
    t.*,
    s.status_main_id,
    -- –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–µ
    CASE
      WHEN t.planning_date_end < SYSDATE
       AND t.actual_date_end IS NULL
      THEN 1 ELSE 0
    END AS is_overdue,
    -- –Ω–µ–¥–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–µ
    CASE
      WHEN EXISTS (
        SELECT 1
        FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 d
        WHERE d.page_list_id    = t.page_list_id
          AND d.parent_stage_id IS NOT NULL
          AND NOT EXISTS (
            SELECT 1
            FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
            WHERE r.task_id   = t.task_id
              AND r.stages_id = d.id
          )
      )
      THEN 1 ELSE 0
    END AS is_incomplete
  FROM V_TASKS_FULL_2 t
  CROSS JOIN user_ctx uc
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s
    ON s.id = t.status_id
  WHERE
    (
      /* --- ACCESS LEVEL 1 ------------------------------------- */
      EXISTS (
        SELECT 1
        FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
        JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
          ON al.id = ac.access_level_id
        WHERE al.access_level = 1
          AND (
               ac.user_id     = uc.user_id
            OR ac.position_id = uc.position_id
          )
          -- –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–æ —é–Ω—ñ—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
          AND ( uc.unit_id IS NULL
                OR t.unit_id = uc.unit_id )
      )

      OR

      /* --- ACCESS LEVEL 2 ------------------------------------- */
      EXISTS (
        SELECT 1
        FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
        JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
          ON al.id = ac.access_level_id
        WHERE al.access_level = 2
          -- —Ñ—ñ–ª—å—Ç—Ä–∏ –∑ ACL
          AND (ac.position_id   IS NULL OR ac.position_id   = uc.position_id)
          AND (ac.department_id IS NULL OR ac.department_id = uc.department_id)
          AND (ac.unit_id       IS NULL OR ac.unit_id       = uc.unit_id)
          AND (ac.uchastok      IS NULL OR ac.uchastok      = uc.uchastok_id)
          AND (ac.user_id       IS NULL OR ac.user_id       = uc.user_id)
          -- –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ —Å–∞–º—ñ–π –∑–∞–¥–∞—á—ñ
          AND t.department_id = uc.department_id
          AND (uc.unit_id      IS NULL OR t.unit_id      = uc.unit_id)
          AND (uc.uchastok_id  IS NULL OR t.uchastok_id  = uc.uchastok_id)
      )

      OR

      /* --- ACCESS LEVEL 3 ------------------------------------- */
      EXISTS (
        SELECT 1
        FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
        JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
          ON al.id = ac.access_level_id
        WHERE al.access_level = 3
          AND ac.user_id = uc.user_id
      )

      OR

      /* --- –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SIGNATURERIGHTS ----------------------- */
      EXISTS (
        SELECT 1
        FROM tasktracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
        WHERE sr.task_id = t.task_id
          AND (
               sr.user_tabno = uc.user_id
            OR (
                 sr.position_id   = uc.position_id
             AND sr.department_id = uc.department_id
             AND (sr.unit_id   IS NULL OR sr.unit_id   = uc.unit_id)
             AND (sr.uchastok  IS NULL OR sr.uchastok  = uc.uchastok_id)
               )
          )
      )

      OR

      /* --- –∞–≤—Ç–æ—Ä –∑–∞–¥–∞—á—ñ ---------------------------------------- */
      t.creator_id = uc.user_id
    )
)
```

> üîπ –¢—É—Ç **`V_TASKS_FULL_2` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑** (–≤ `FROM`).
> üîπ –£—Å—ñ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ `task_access_control` / `SIGNATURERIGHTS` ‚Äî –ª–∏—à–µ –≤ `EXISTS`, –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö JOIN‚Äô—ñ–≤ –¥–æ view.
> üîπ –¶–µ –ø–æ–≤—Ç–æ—Ä—é—î —Ç–≤–æ—é —Å—Ç–∞—Ä—É —ñ–¥–µ–æ–ª–æ–≥—ñ—é –¥–æ—Å—Ç—É–ø—ñ–≤, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤–∂–µ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π view —ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ.

–î–∞–ª—ñ:

* `viewed_agg`,
* `base_tasks`,
* `planned_tab / todo_tab / shift_tab / problem_tab / archive_tab`,
* —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π `UNION ALL` ‚Äî –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —Ç–∞–∫–∏–º–∏, —è–∫ –º–∏ –≤–∂–µ –ø–æ–±—É–¥—É–≤–∞–ª–∏.

---

## 3. –ß–æ–º—É —Ç–∞–∫ –±—É–¥–µ —à–≤–∏–¥—à–µ, –Ω—ñ–∂ —Ç–µ–ø–µ—Ä—ñ—à–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç

1. `V_TASKS_FULL_2` ‚Äî –≤–∞–∂–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ (join‚Äô–∏, dblink‚Äô–∏) ‚Äî —á–∏—Ç–∞—î—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**.

2. –¢–∞–±–ª–∏—Ü—ñ –¥–æ—Å—Ç—É–ø—É (`task_access_control`, `task_access_level_type`, `SIGNATURERIGHTS`) –∑–∞–∑–≤–∏—á–∞–π –Ω–µ–≤–µ–ª–∏–∫—ñ, —ó—Ö –º–æ–∂–Ω–∞ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —á–µ—Ä–µ–∑ `EXISTS` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞. Oracle —Ç—É—Ç –≤–º—ñ—î –¥–æ–±—Ä–µ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ —î —ñ–Ω–¥–µ–∫—Å–∏:

   * `task_access_control(access_level_id, user_id, position_id, department_id, unit_id, uchastok)`
   * `signaturerights(task_id, user_tabno, position_id, department_id, unit_id, uchastok)`

3. –¢–≤–æ—î –ø–æ—Ç–æ—á–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –∑ `access_lvl1/2/3` + `FROM V_TASKS_FULL_2` –≤ –∫–æ–∂–Ω–æ–º—É:

   * —Ñ–∞–∫—Ç–∏—á–Ω–æ —Ä–æ–±–∏—Ç—å **–∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ö–æ–¥—ñ–≤** –ø–æ view,
   * –±—É–¥—É—î –≤–µ–ª–∏–∫—ñ –ø—Ä–æ–º—ñ–∂–Ω—ñ –º–Ω–æ–∂–∏–Ω–∏ (–∫—Ä–æ—Å–∏ ACL √ó tasks),
   * –∞ –ø–æ—Ç—ñ–º —â–µ —Ä–∞–∑ —ó—Ö –æ–±‚Äô—î–¥–Ω—É—î –≤ `task_access`.

---

## 4. –Ø–∫—â–æ —Ö–æ—á–µ—à —â–µ —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ñ—à–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è

–¢–µ, —â–æ —Ç–∏ —Ä–æ–±–∏—à –∑ ACL ‚Äî —Ü–µ –ø–æ —Å—É—Ç—ñ *—Å—Ç–∞—Ç–∏—á–Ω—ñ* –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–≤–æ–Ω–∏ —Ä—ñ–¥–∫–æ –º—ñ–Ω—è—é—Ç—å—Å—è). –ú–æ–∂–Ω–∞:

* –£ **Pre-Header process** –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ä–∞–∑ access level + –¥–æ–ø—É—Å—Ç–∏–º—ñ department / unit / uchastok,
* –ó–∞–ø–∏—Å–∞—Ç–∏ —ó—Ö —É page items (`P0_ACCESS_LEVEL`, `P0_ALLOWED_DEPTS`, `P0_ALLOWED_UNITS`),
* –Ü –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É SQL **–≤–∑–∞–≥–∞–ª—ñ –Ω–µ —Ö–æ–¥–∏—Ç–∏** –¥–æ `task_access_control`, –∞ –ø—Ä–æ—Å—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è —Ü–∏–º–∏ item‚Äô–∞–º–∏ –≤ `WHERE`.

–¶–µ –≤–∂–µ ‚Äú–∫–µ—à—É–≤–∞–Ω–Ω—è‚Äù –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –Ω–∞ —Ä—ñ–≤–Ω—ñ —Å–µ—Å—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Äî –¥–∞—î —â–µ –æ–¥–∏–Ω —Ä—ñ–≤–µ–Ω—å –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è. –ê–ª–µ —Ü–µ –æ–∫—Ä–µ–º–∏–π, –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫.

---

## –ü—ñ–¥—Å—É–º–æ–∫

* –¢–µ, —â–æ —Ç–∏ –ø–æ–º—ñ—Ç–∏–≤ –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å `task_id` —É `task_access_control` ‚Äî 100% –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
* –ß–µ—Ä–µ–∑ —Ü–µ CTE –∑ `FROM V_TASKS_FULL_2` –≤ `access_lvl1/2/3` –¥—ñ–π—Å–Ω–æ –ª–æ–≥—ñ—á–Ω–æ –π —Ç–µ—Ö–Ω—ñ—á–Ω–æ **–ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å** –∑–∞–ø–∏—Ç.
* –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–¥–∞—á –≤ –æ–¥–∏–Ω CTE (`tasks_with_access`), –∞ ACL/–ø—ñ–¥–ø–∏—Å–∏/–∞–≤—Ç–æ—Ä—Å—Ç–≤–æ ‚Äî —á–µ—Ä–µ–∑ `EXISTS` —É `WHERE`.
* –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–µ view + –æ–¥–∏–Ω –ø—Ä–æ—Ö—ñ–¥ + –º–µ–Ω—à–µ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ = —Ä–µ–∞–ª—å–Ω–∏–π –ø—Ä–æ—Ñ—ñ—Ç –≤—ñ–¥ —Ç–≤–æ—î—ó —Ä–æ–±–æ—Ç–∏ –∑ view.

–Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ —Å–≤—ñ–π —Ç–µ–ø–µ—Ä—ñ—à–Ω—ñ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç `tasks_with_access` —É —Ç–µ–∫—Å—Ç—ñ (–Ω–µ —Ñ–æ—Ç–æ), —ñ —è –ø—Ä—è–º–æ –Ω–∞ –Ω—å–æ–º—É –ø–æ–∫–∞–∂—É, —è–∫ –π–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –≤ –æ–¥–∏–Ω CTE –∑ `EXISTS` 1:1 –ø—ñ–¥ —Ç–≤–æ—é —Ç–æ—á–Ω—É –ª–æ–≥—ñ–∫—É.
