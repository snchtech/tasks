–û–∫–µ–π, —Ñ—ñ–Ω—ñ—à–Ω–∏–π –±–æ—Å ‚Äî **access control** üïπÔ∏è
–¢—É—Ç –∑—Ä–æ–±–∏–º–æ –Ω–∞–π–∫–æ—Ä–∏—Å–Ω—ñ—à–µ: –≤–∏–Ω–µ—Å–µ–º–æ –≤—Å—é –ª–æ–≥—ñ–∫—É `task_access_control + signaturerights` –≤ –æ–¥–∏–Ω-—î–¥–∏–Ω–∏–π CTE, –∞ –≤ `tasks_with_access` –∑–∞–ª–∏—à–∏–º–æ —Ç—ñ–ª—å–∫–∏ JOIN –ø–æ `task_id`.

–Ø –ø–æ–∫–∞–∂—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—É —É–º–æ–≤ —Ç–∏ –∑–º–æ–∂–µ—à –≤—Å—Ç–∞–≤–∏—Ç–∏ —Å–≤–æ—é —ñ—Å–Ω—É—é—á—É –ª–æ–≥—ñ–∫—É 1:1 (—Ç—ñ –∂ access_level 1/2/3), –ø—Ä–æ—Å—Ç–æ –∞–∫—É—Ä–∞—Ç–Ω—ñ—à–µ.

---

## 1. –©–æ –º–∏ —Ö–æ—á–µ–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏

–ó–∞–º—ñ—Å—Ç—å —Ç–∞–∫–æ–≥–æ –≤ `tasks_with_access`:

```sql
WHERE EXISTS (
  SELECT 1 FROM task_access_control ac
  JOIN task_access_level_type al ON ...
  WHERE (... –∫—É–ø–∞ OR, AND, EXISTS, ROWNUM=1 ...)
)
```

–º–∏ —Ä–æ–±–∏–º–æ:

```sql
task_access AS (           -- –æ–¥–∏–Ω CTE
  SELECT DISTINCT task_id
  FROM ( ... union all –ø–æ access_level ... )
),

tasks_with_access AS (
  SELECT DISTINCT
    t.*,
    s.status_main_id,
    ... is_overdue, is_incomplete ...
  FROM V_TASKS_FULL t
  JOIN task_access ta ON ta.task_id = t.task_id   -- –ø—Ä–æ—Å—Ç–æ JOIN
  ...
)
```

–¢–æ–±—Ç–æ:

* –≤—Å—é —Ç—è–∂–∫—É –ª–æ–≥—ñ–∫—É –≤–∏—Ä—ñ—à—É—î–º–æ **–æ–¥–∏–Ω —Ä–∞–∑** —É `task_access`;
* `tasks_with_access` –±—ñ–ª—å—à–µ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å EXISTS –∑ dblink-—Ç–∞–±–ª–∏—Ü—è–º–∏.

---

## 2. CTE `task_access`: –¥–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –∑–∞–¥–∞—á

–Ø –æ–¥—Ä–∞–∑—É –ø–∏—à—É –≤ —Ñ–æ—Ä–º–∞—Ç—ñ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑—å–∫–æ–º—É –¥–æ —Ç–æ–≥–æ, —â–æ —Ç–∏ –≤–∂–µ –º–∞–≤, –∞–ª–µ –±–µ–∑ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∏—Ö ‚Äú–¥—ñ—Ä‚Äù:

```sql
WITH user_ctx AS (
  SELECT
    :PO_SUBSTITUTION_MODE AS substitution_mode,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_USER_ID       ELSE :PO_CUR_USER_TABNO       END AS user_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_POSITION_ID   ELSE :PO_CUR_USER_POSITION    END AS position_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_DEPARTMENT_ID ELSE :PO_CUR_USER_DEPARTMENT  END AS department_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UNIT_ID       ELSE :PO_CUR_USER_UNIT        END AS unit_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_UCHASTOK      ELSE :PO_CUR_UCHASTOK         END AS uchastok_id,
    CASE WHEN :PO_SUBSTITUTION_MODE = 1 THEN :PO_NEW_HAS_SHIFT_ROLE ELSE :PO_CUR_HAS_SHIFT_ROLE  END AS has_shift_role
  FROM dual
),

/* === 1) ACCESS LEVEL 1 =====================================
   al.access_level = 1
   –¢–∏–ø–æ–≤–∞ –ª–æ–≥—ñ–∫–∞: –¥–æ—Å—Ç—É–ø –∞–±–æ –∑–∞ user_id, –∞–±–æ –∑–∞ position_id,
   –∑ –º–æ–∂–ª–∏–≤–∏–º –æ–±–º–µ–∂–µ–Ω–Ω—è–º –ø–æ unit.
=========================================================== */

access_lvl1 AS (
  SELECT DISTINCT
    t.id AS task_id
  FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
  JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
    ON al.id = ac.access_level_id
  CROSS JOIN user_ctx uc
  JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t
    ON t.id = ac.task_id
  WHERE al.access_level = 1
    AND (
         ac.user_id     = uc.user_id
      OR ac.position_id = uc.position_id
    )
    AND (
      uc.unit_id IS NULL
      OR (uc.unit_id IS NOT NULL AND t.unit_id = uc.unit_id)
    )
),

/* === 2) ACCESS LEVEL 2 =====================================
   al.access_level = 2
   –õ–æ–≥—ñ–∫–∞: (position/department/unit/uchastok) + (user_id –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
   + –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å t.department_id, t.unit_id, t.uchastok_id
=========================================================== */

access_lvl2 AS (
  SELECT DISTINCT
    t.id AS task_id
  FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
  JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
    ON al.id = ac.access_level_id
  CROSS JOIN user_ctx uc
  JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t
    ON t.id = ac.task_id
  WHERE al.access_level = 2
    -- —Ñ—ñ–ª—å—Ç—Ä–∏ –ø–æ —Ä—ñ–≤–Ω—é
    AND (ac.position_id   IS NULL OR ac.position_id   = uc.position_id)
    AND (ac.department_id IS NULL OR ac.department_id = uc.department_id)
    AND (ac.unit_id       IS NULL OR ac.unit_id       = uc.unit_id)
    AND (ac.uchastok      IS NULL OR ac.uchastok      = uc.uchastok_id)
    -- –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π user_id (—è–∫—â–æ –∑–∞–¥–∞–Ω–∏–π)
    AND (ac.user_id IS NULL OR ac.user_id = uc.user_id)
    -- –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ —Å–∞–º—ñ–π –∑–∞–¥–∞—á—ñ (department/unit/uchastok)
    AND t.department_id = uc.department_id
    AND (
      uc.unit_id IS NULL OR (uc.unit_id IS NOT NULL AND t.unit_id = uc.unit_id)
    )
    AND (
      uc.uchastok_id IS NULL OR (uc.uchastok_id IS NOT NULL AND t.uchastok_id = uc.uchastok_id)
    )
),

/* === 3) ACCESS LEVEL 3 =====================================
   al.access_level = 3
   –õ–æ–≥—ñ–∫–∞: –∞–±–æ –ø—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –ø–æ user_id,
           –∞–±–æ —á–µ—Ä–µ–∑ –ø—ñ–¥–ø–∏—Å–∏ (SIGNATURERIGHTS)
=========================================================== */

access_lvl3 AS (
  -- 3.1. –ü—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø, —è–∫—â–æ al=3 —ñ ac.user_id = uc.user_id
  SELECT DISTINCT
    t.id AS task_id
  FROM TaskTracker.task_access_control@TO_TASKTRACKER10 ac
  JOIN TaskTracker.task_access_level_type@TO_TASKTRACKER10 al
    ON al.id = ac.access_level_id
  CROSS JOIN user_ctx uc
  JOIN TaskTracker.TASKS@TO_TASKTRACKER10 t
    ON t.id = ac.task_id
  WHERE al.access_level = 3
    AND ac.user_id = uc.user_id

  UNION ALL

  -- 3.2. –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SIGNATURERIGHTS (user/position/dep/unit/uchastok)
  SELECT DISTINCT
    sr.task_id
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
  CROSS JOIN user_ctx uc
  WHERE
        sr.user_tabno   = uc.user_id
     OR (
          sr.position_id   = uc.position_id
      AND sr.department_id = uc.department_id
      AND (sr.unit_id    IS NULL OR sr.unit_id    = uc.unit_id)
      AND (sr.uchastok   IS NULL OR sr.uchastok   = uc.uchastok_id)
        )
),

/* === 4) –û–±'—î–¥–Ω—É—î–º–æ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ –¥–æ—Å—Ç—É–ø—É ===================== */

task_access AS (
  SELECT DISTINCT task_id
  FROM (
    SELECT task_id FROM access_lvl1
    UNION ALL
    SELECT task_id FROM access_lvl2
    UNION ALL
    SELECT task_id FROM access_lvl3
  )
),
```

> üîÅ –í—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–∂–Ω–æ—ó —Å–µ–∫—Ü—ñ—ó —Ç–∏ –º–æ–∂–µ—à **—Ç–æ—á–Ω–æ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ —Å–≤–æ—é –ø–æ—Ç–æ—á–Ω—É –ª–æ–≥—ñ–∫—É** (—É–º–æ–≤–∏ –∑ —Ç–≤–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ `EXISTS`). –Ø –∑–∞–¥–∞–≤ —Ç–∏–ø–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∞–ª–µ —è–∫—â–æ –≤ —Ç–µ–±–µ —î –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω—é–∞–Ω—Å–∏ –¥–ª—è al=1/2/3 ‚Äì –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π —ó—Ö –≤ `WHERE`.

---

## 3. –û–Ω–æ–≤–ª—é—î–º–æ `tasks_with_access` –ø—ñ–¥ —Ü–µ–π CTE

–¢–µ–ø–µ—Ä `tasks_with_access` —Å–ø—Ä–æ—â—É—î—Ç—å—Å—è –¥–æ:

```sql
tasks_with_access AS (
  SELECT DISTINCT
    t.*,
    s.status_main_id,
    CASE
      WHEN t.planning_date_end < SYSDATE AND t.actual_date_end IS NULL THEN 1
      ELSE 0
    END AS is_overdue,
    CASE
      WHEN EXISTS (
        SELECT 1
        FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 d
        WHERE d.page_list_id    = t.page_list_id
          AND d.parent_stage_id IS NOT NULL
          AND NOT EXISTS (
            SELECT 1
            FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 r
            WHERE r.task_id   = t.task_id
              AND r.stages_id = d.id
          )
      ) THEN 1
      ELSE 0
    END AS is_incomplete
  FROM V_TASKS_FULL t
  JOIN task_access ta
    ON ta.task_id = t.task_id    -- ‚Üê –¥–æ—Å—Ç—É–ø –≤–∏–∑–Ω–∞—á–µ–Ω–æ –≤–∏—â–µ
  LEFT JOIN TaskTracker.DICT_STATUS@TO_TASKTRACKER10 s
    ON s.id = t.status_id
),
```

> `user_ctx` —Ç—É—Ç —É–∂–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–∞–ø—Ä—è–º—É ‚Äî –≤—ñ–Ω –±—É–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π —É CTE `access_lvlX`.
> –î–∞–ª—ñ –π–¥—É—Ç—å –≤–∂–µ –Ω–∞—à—ñ `viewed_user`, `viewed_agg`, `base_tasks`, `planned_tab`, `todo_tab`, ... —è–∫ –º–∏ –æ–ø–∏—Å–∞–ª–∏ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫—Ä–æ—Ü—ñ.

---

## 4. –©–æ —Ü–µ –¥–∞—î –ø–æ —Ñ–∞–∫—Ç—É

1. **Access Control –±—ñ–ª—å—à–µ –Ω–µ –∂–∏–≤–µ –≤ WHERE –∫–æ–∂–Ω–æ—ó –∑–∞–¥–∞—á—ñ**
   ‚Üí –û–¥–Ω–∞ —á—ñ—Ç–∫–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É (`task_access`), –æ–¥–∏–Ω –Ω–∞–±—ñ—Ä JOIN‚Äô—ñ–≤.

2. **–ù–µ–º–∞—î `ROWNUM = 1` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–¥–æ—Ä–æ–≤–µ–Ω–Ω–æ–≥–æ EXISTS**
   ‚Üí –û–ø—Ç–∏–º—ñ–∑–∞—Ç–æ—Ä –±–∞—á–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ñ –ø—Ä–µ–¥–∏–∫–∞—Ç–∏, –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏.

3. **–ö–æ–∂–µ–Ω access_level –º–∞—î —Å–≤–æ—é —á–∏—Å—Ç—É –≥—ñ–ª–∫—É**, –∑–∞–º—ñ—Å—Ç—å –æ–¥–Ω—ñ—î—ó –∫—É–ø–∏ OR:

   * –ø—Ä–æ—Å—Ç—ñ—à–µ —á–∏—Ç–∞—Ç–∏ –π –≤—ñ–¥–ª–∞–¥–∂—É–≤–∞—Ç–∏;
   * –ª–µ–≥—à–µ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤–∏–º–∏ —Ä—ñ–≤–Ω—è–º–∏, —è–∫—â–æ –¥–æ–≤–µ–¥–µ—Ç—å—Å—è.

4. –í –ø–æ—î–¥–Ω–∞–Ω–Ω—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º–∏ –∫—Ä–æ–∫–∞–º–∏ (–ø—Ä–∞–ø–æ—Ä—Ü—ñ `is_overdue / is_incomplete`, `viewed_agg`, `UNION ALL` –ø–æ –≤–∫–ª–∞–¥–∫–∞—Ö) —Ç–∏ –æ—Ç—Ä–∏–º—É—î—à:

   * –º—ñ–Ω—ñ–º—É–º –∫–æ—Ä–µ–ª—å–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ–≤;
   * –º—ñ–Ω—ñ–º—É–º –ø–æ–≤—Ç–æ—Ä—ñ–≤ —Ö–æ–¥—ñ–≤ –ø–æ dblink;
   * —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π, –º–æ–¥—É–ª—å–Ω–∏–π SQL, –¥–µ –∫–æ–∂–µ–Ω CTE —Ä–æ–±–∏—Ç—å —Å–≤–æ—é –º–∞–ª–µ–Ω—å–∫—É —á—ñ—Ç–∫—É —Å–ø—Ä–∞–≤—É.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –¥–∞–ª—ñ –º–æ–∂–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ —â–µ –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äú–ø—Ä–æ—Ñ–∞–π–ª—ñ–Ω–≥‚Äù-–∫—Ä–æ–∫:
—è –º–æ–∂—É –ø—ñ–¥–∫–∞–∑–∞—Ç–∏, **—è–∫—ñ —ñ–Ω–¥–µ–∫—Å–∏ –Ω–∞ TaskTracker-—Ç–∞–±–ª–∏—Ü—è—Ö** (–æ—Å–æ–±–ª–∏–≤–æ `TASK_ACCESS_CONTROL`, `SIGNATURERIGHTS`, `TASK_VIEWED`) –≤–∞—Ä—Ç–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏/–¥–æ–¥–∞—Ç–∏ –ø—ñ–¥ —Ü–µ–π –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç, —â–æ–± –¥–æ–±–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —á–∞—Å—É.
