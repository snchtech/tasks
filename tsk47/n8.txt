—Å—É–ø–µ—Ä-—ñ–¥–µ—è: –ø–æ–∫–ª–∞—Å—Ç–∏ `stage_mode` –ø—Ä—è–º–æ –≤ **–∫–æ–∂–µ–Ω** —Ä—è–¥–æ–∫ APEX-–∫–æ–ª–µ–∫—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É `c026`) —ñ –≤–∂–µ –≤ –ø–∞–∫–µ—Ç—ñ —á–∏—Ç–∞—Ç–∏ –π–æ–≥–æ –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó. –û—Å—å –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π, –∞–ª–µ –ø–æ–≤–Ω–∏–π —à–∞–±–ª–æ–Ω.

# 1) –ü—Ä–æ—Ü–µ—Å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ

(–≤–∏–∫–æ–Ω–∞–π —É `Before Header / After Header` –∞–±–æ —É —Å–≤–æ–º—É AJAX-–ø—Ä–æ—Ü–µ—Å—ñ, –¥–µ —Ç–∏ –±—É–¥—É—î—à `CONFIRM_CART_*`)

```plsql
declare
  -- –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ—ó –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
  procedure ensure_truncate(p_name in varchar2) is
  begin
    if apex_collection.collection_exists(p_name) then
      apex_collection.truncate_collection(p_name);
    else
      apex_collection.create_collection(p_name);
    end if;
  end;
begin
  /* 
    –¢—è–≥–Ω–µ–º–æ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ signaturerights + —ó—Ö –ø—ñ–¥–µ—Ç–∞–ø–∏ (child —É DICT_APP_CONFIRM_LIST)
    —Ç–∞ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –µ—Ç–∞–ø (parent), —â–æ–± –∑–Ω–∞—Ç–∏ stage_no (2/4/6) —ñ –∑—ñ–±—Ä–∞—Ç–∏ –∫–æ–ª–µ–∫—Ü—ñ—ó
    –≤–∏–¥—É CONFIRM_CART_<parent_id>_<child_id>
    
    –í–ê–ñ–õ–ò–í–û:
    - sr.stage_mode (0=–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ, 1=–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ) –∫–ª–∞–¥–µ–º–æ –≤ c026
    - —ñ–Ω—à—ñ –ø–æ–ª—è (–ø–æ–∑–∏—Ü—ñ—è, –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç, unit, —Ç–∞–±‚Ññ —Ç–æ—â–æ) ‚Äî —è–∫ —É —Ç–µ–±–µ –±—É–ª–æ.
  */
  for r in (
    select
      p.id                     as parent_stage_id,    -- –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –µ—Ç–∞–ø (2/4/6)
      p.stage                  as parent_stage_no,    -- 2 / 4 / 6
      c.id                     as child_substage_id,  -- –ø—ñ–¥–µ—Ç–∞–ø
      sr.id                    as signright_id,
      sr.task_id,
      sr.position_id,
      sr.department_id,
      sr.unit_id,
      sr.user_tabno,
      nvl(sr.stage_mode,1)     as stage_mode,         -- 0 –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ, 1 –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ (–¥–µ—Ñ–æ–ª—Ç 1)
      sr.subtask_id,
      sr.sort_order,
      sr.sr_task_mode          as task_mode
      -- TODO: –¥–æ–¥–∞–π —Ç–µ, —â–æ —Ç–∏ —â–µ –∫–ª–∞–¥–µ—à —É c001..c016 (—ñ–º–µ–Ω–æ–≤–∞–Ω—ñ ¬´–≤–∏–≤—ñ—Å–∫–∏¬ª, —Ç–µ–∫—Å—Ç–∏ —Ç–æ—â–æ)
    from TaskTracker.SIGNATURERIGHTS sr
    join TaskTracker.DICT_APP_CONFIRM_LIST c
      on c.id = sr.stages_id
     and c.parent_stage_id is not null
    join TaskTracker.DICT_APP_CONFIRM_LIST p
      on p.id = c.parent_stage_id
     and p.parent_stage_id is null
    where sr.task_id     = :P5_TASK_ID
      and p.page_list_id = :P5_PAGE_LIST_ID
    order by p.stage, c.stage, nvl(sr.sort_order, 999999), sr.id
  )
  loop
    -- —ñ–º'—è –∫–æ–ª–µ–∫—Ü—ñ—ó –ø—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –ø—ñ–¥–µ—Ç–∞–ø
    ensure_truncate('CONFIRM_CART_'||r.parent_stage_id||'_'||r.child_substage_id);

    /* 
      –¢—É—Ç —Ç–∏, —Å–∫–æ—Ä—ñ—à –∑–∞ –≤—Å–µ, –º–∞—î—à —â–µ –æ–¥–∏–Ω –∫—É—Ä—Å–æ—Ä –ø–æ ¬´—Ä—è–¥–∫–∞—Ö –≤ –ø—ñ–¥–µ—Ç–∞–ø—ñ¬ª.
      –Ø–∫—â–æ –≤ —Ç–µ–±–µ 1-–∫-1 (–∫–æ–∂–µ–Ω sr —ñ —î —Ä—è–¥–æ–∫) ‚Äî –¥–æ–¥–∞—î–º–æ –ø—Ä—è–º–æ r.
      –Ø–∫—â–æ —Å–ø–æ—á–∞—Ç–∫—É —Ä–æ–±–∏—à –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è/–æ–±‚Äô—î–¥–Ω–∞–Ω–Ω—è ‚Äî —Ç–æ–¥—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —â–µ –æ–¥–∏–Ω —Ü–∏–∫–ª FOR ... LOOP.
    */
    apex_collection.add_member(
      p_collection_name => 'CONFIRM_CART_'||r.parent_stage_id||'_'||r.child_substage_id,
      -- c001..c003: ¬´–≤–∏–≤—ñ—Å–∫–∏¬ª (position/department/unit) ‚Äì —è–∫ —É —Ç–µ–±–µ –±—É–ª–æ:
      p_c001 => null,                 -- list_position (—Ç–µ–∫—Å—Ç)
      p_c002 => null,                 -- list_department (—Ç–µ–∫—Å—Ç)
      p_c003 => null,                 -- list_unit (—Ç–µ–∫—Å—Ç)
      -- c006 –ø–æ—Ä—è–¥–æ–∫ (—è–∫—â–æ —î):
      p_c006 => to_char(nvl(r.sort_order, 999999)),
      -- c008 —Ç–∞–±–µ–ª—å–Ω–∏–π
      p_c008 => to_char(r.user_tabno),
      -- c009..c011 —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –¥–ª—è —Ä–æ–ª–µ–π:
      p_c009 => to_char(r.position_id),
      p_c010 => to_char(r.department_id),
      p_c011 => to_char(r.unit_id),
      -- c012 –ø—ñ–¥–ø–∏—Å–Ω–µ –ø—Ä–∞–≤–æ (SIGNATURERIGHTS.ID)
      p_c012 => to_char(r.signright_id),
      -- c014 —Ä–µ–∂–∏–º –∑–∞–¥–∞—á—ñ (0/1) —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à
      p_c014 => to_char(r.task_mode),
      -- c016 –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è
      p_c016 => to_char(r.subtask_id),
      -- c026 ‚Äî –¢–í–û–Ñ –ù–û–í–ï –ü–û–õ–ï: —Ä–µ–∂–∏–º –µ—Ç–∞–ø—É (0/1) –Ω–∞ —Ä—ñ–≤–Ω—ñ —Ü—å–æ–≥–æ —Ä—è–¥–∫–∞
      p_c026 => to_char(r.stage_mode)
      -- –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –¥–æ–¥–∞–π c015 = —Ç–µ–∫—Å—Ç –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è, —ñ–Ω—à—ñ —Å–ª—É–∂–±–æ–≤—ñ
    );
  end loop;
end;
```

> –Ø–∫—â–æ —Ç–∏ –≤–∂–µ –±—É–¥—É—î—à –∫–æ–ª–µ–∫—Ü—ñ—ó –≤ –∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ö–æ–¥—ñ–≤ (–ø–æ –∫–æ–∂–Ω–æ–º—É `parent_stage_id`,`child_substage_id`), –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π —É —Å–≤—ñ–π `ADD_MEMBER` –ø–∞—Ä–∞–º–µ—Ç—Ä `p_c026 => to_char(stage_mode)`.

---

# 2) –Ø–∫ —á–∏—Ç–∞—Ç–∏ `stage_mode` —É –ø–∞–∫–µ—Ç—ñ –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó (c026)

–£ —Ç–≤–æ—ó–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ñ `render_substage_rows(...)` –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑—à–∏—Ä—é—î–º–æ –∫—É—Ä—Å–æ—Ä:

```plsql
cursor c_list is
  select seq_id,
         c001 as list_position,
         c002 as list_department,
         c003 as list_unit,
         to_number(c009)  as list_position_id,
         to_number(c010)  as list_department_id,
         to_number(c011)  as list_unit_id,
         to_number(c012)  as signature_id,
         to_number(c008)  as list_tab_no,
         to_number(c014)  as task_mode,
         c015              as subtask_content_opt,
         to_number(c016)  as subtask_id,
         to_number(c026)  as stage_mode_row   -- üëà –¢–£–¢ –ß–ò–¢–ê–Ñ–ú–û –†–ï–ñ–ò–ú –ï–¢–ê–ü–£ –ó –ö–û–õ–ï–ö–¶–Ü–á
  from   apex_collections
  where  collection_name = 'CONFIRM_CART_'||p_stage_id||'_'||p_substage_id
  order  by to_number(c006);
```

–ê –¥–∞–ª—ñ, –Ω–∞ –ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—Ü–µ–¥—É—Ä–∏, –ø—Ä–æ—Å—Ç–æ –≤–∏–∑–Ω–∞—á–∞—î–º–æ —Ä–µ–∂–∏–º:

```plsql
-- —É—Å–µ—Ä–µ–¥–∏–Ω—ñ render_substage_rows(...)
l_count_cb  number   := 0;
l_parallel  boolean;  -- ‚Üê –±—É–¥–µ–º–æ –≤–∏—Å—Ç–∞–≤–ª—è—Ç–∏ –∑ –ø–µ—Ä—à–æ–≥–æ —Ä—è–¥–∫–∞ (–∞–±–æ –∑ –∫–æ–∂–Ω–æ–≥–æ ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

...

for r in c_list loop
  ...
  -- –≤–∏—Å—Ç–∞–≤–ª—è—î–º–æ —Ä–µ–∂–∏–º –Ω–∞ –æ—Å–Ω–æ–≤—ñ c026: 0 = –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ, 1 = –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ
  l_parallel := (nvl(r.stage_mode_row, 1) = 0);

  -- —ñ –¥–∞–ª—ñ —Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞ –ø–æ–∫–∞–∑—É –∫–Ω–æ–ø–æ–∫:
  -- if not p_is_active_stage then ...
  -- elsif l_parallel then ... (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ)
  -- else ... (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ)
  ...
end loop;
```

> –û—Å–∫—ñ–ª—å–∫–∏ `stage_mode` ‚Äî –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å —É—Å—å–æ–≥–æ **–µ—Ç–∞–ø—É**, —Ç–∏ –º–æ–∂–µ—à:
>
> * –∞–±–æ —á–∏—Ç–∞—Ç–∏ `c026` –∑ **–ø–µ—Ä—à–æ–≥–æ** —Ä—è–¥–∫–∞ (—ñ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ `l_parallel`),
> * –∞–±–æ –Ω–µ –ø–∞—Ä–∏—Ç–∏—Å—å —ñ –∫–æ–∂–µ–Ω —Ä–∞–∑ –ø—Ä–∏–∑–Ω–∞—á–∞—Ç–∏ `l_parallel` –∑ `r.stage_mode_row` (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–∞–∫–æ–≤–∏–π, —è–∫—â–æ –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó —É–∑–≥–æ–¥–∂–µ–Ω–æ).

---

# 3) –Ø–∫ —Ü–µ –∑–≤–æ–¥–∏—Ç—å—Å—è —Ä–∞–∑–æ–º

* –ù–∞ –µ—Ç–∞–ø—ñ **—Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π** —Ç–∏ –≤–∂–µ –∫–ª–∞—Å–∏—Ñ—ñ–∫—É—î—à –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ —ñ –∫–ª–∞–¥–µ—à `stage_mode` —É `c026`.
* –ù–∞ –µ—Ç–∞–ø—ñ **—Ä–µ–Ω–¥–µ—Ä—É** –∫–∞—Ä—Ç–∫–∏:

  * `render(...)` —è–∫ —ñ —Ä–∞–Ω—ñ—à–µ –æ–±—á–∏—Å–ª—é—î `p_is_active_stage` (–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –µ—Ç–∞–ø—É) —ñ –ø–µ—Ä–µ–¥–∞—î –π–æ–≥–æ –≤ `render_substage_rows(...)`;
  * `render_substage_rows(...)` –Ω–∞ –∫–æ–∂–Ω–æ–º—É —Ä—è–¥–∫—É –±–µ—Ä–µ `c026` ‚Üí `l_parallel`, —ñ –ø–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫—É –∞–±–æ —Å—Ç–∞—Ç—É—Å –∑–≥—ñ–¥–Ω–æ **—Ç–≤–æ–≥–æ** –∞–ª–≥–æ—Ä–∏—Ç–º—É (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ/–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ + –ø—Ä–∞–≤–∞ + –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –µ—Ç–∞–ø—É).

–¢–∞–∫ —Ç–∏:

* —É–Ω–∏–∫–∞—î—à –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –ë–î –≤ –ø–∞–∫–µ—Ç—ñ –¥–ª—è `stage_mode`;
* —Ç—Ä–∏–º–∞—î—à ¬´–¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏¬ª –ø—Ä–æ —Ä–µ–∂–∏–º **—É —Å–∞–º—ñ–π –∫–æ–ª–µ–∫—Ü—ñ—ó**, –∑ —è–∫–æ—ó –≤—Å–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è.
