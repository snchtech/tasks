Окей, коротко й по суті — що саме відбувається тепер на кожному етапі (2, 4, 6) із режимами «послідовно/паралельно».

# Як визначається «активний» етап

1. Система перевіряє, чи **всі попередні етапи завершені** (для 4 — завершений 2; для 6 — завершені 2 і 4).
2. Перевіряє, чи **в поточному етапі ще лишилися непідписані рядки** (SIGNATURERIGHTS без запису в SIGNATUREHISTORY).
   → Якщо обидві умови істинні — етап **активний** і саме для нього можна показувати кнопки.

# Як зчитується режим етапу

Для кожного етапу читається `stage_mode` (0 = паралельно, 1 = послідовно) з таблиці `SIGNATURERIGHTS`. Це значення візуально показується бейджем біля заголовка етапу («Паралельно» або «Послідовно»).

# Показ кнопок усередині етапу

Щоб згенерувати кнопку в рядку, виконуються дві перевірки:

* Етап **активний** (див. вище).
* Користувач **має право** на цей рядок (перевірка посади/підрозділу/unit/таб№/ролей).

Далі спрацьовують правила режиму:

## Режим «Паралельно» (stage_mode = 0)

* У **кожному** рядку етапу, де користувач має право і **ще немає підпису**, відразу показується кнопка.
* Можна підписувати **в будь-якому порядку** (2-й, потім 1-й, потім 3-й тощо).
* Кнопки **не з’являються** на інших етапах, поки поточний етап не стане **повністю завершеним** (усі рядки підписані).
* Як тільки всі рядки етапу підписані — етап стає **завершеним**, і активується **наступний** (за наявності).

## Режим «Послідовно» (stage_mode = 1)

* В етапі одночасно показується **лише одна** «перша доступна» кнопка (перша за порядком непідписана, де поточний користувач має право).
* На інших рядках показується статус «Очікує відмітки» або «Розглядає» (для першого непідписаного).
* Після підпису першого рядка — «розблоковується» кнопка для **наступного** рядка і т.д.
* Як і в паралельному, кнопки інших етапів не з’являться, доки **весь** поточний етап не підписано.

# Переходи між етапами

* Перехід до наступного етапу **завжди** відбувається лише коли **поточний етап завершено повністю** (усі SR мають підписи в SH).
* Це гарантує вашу вимогу: *«щоб всі записи були відмічені на кожному етапі для переходу на наступний»* — незалежно від того, паралельний чи послідовний режим.

# Особливі випадки та захисти

* Якщо в етапі **немає** записів `SIGNATURERIGHTS`, етап вважається **не завершеним** (кнопок не буде).
* Права визначаються з урахуванням **заміщення** та ролей (unit-ролі), тому кнопка з’являється лише там, де користувач реально має право підпису.
* Режим етапу береться **з БД під час рендеру** (без прив’язки до старих `:P*` флагів), тож сторінка завжди показує актуальну поведінку згідно з налаштуваннями маршруту.

# Простий приклад

* Етап 2 — **послідовно**: з 4 рядків показується **одна** кнопка (для першого допустимого рядка). Після підпису — наступна, і так далі, доки всі 4 не підписані.
* Етап 4 — **паралельно**: одразу показуються кнопки на **всіх** рядках без підпису, де користувач має право. Підписує в будь-якому порядку.
* Етап 6 — стане активним тільки коли **всі** рядки етапу 4 будуть підписані (незалежно від їхнього порядку в паралельному режимі).

Коротше: «паралельно» дає максимум свободи **всередині етапу**, але **переходи між етапами** завжди суворо після повного завершення попереднього.
