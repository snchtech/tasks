–î—É–∂–µ –¥–æ–±—Ä–µ üí™
–¢–∏ —Ö–æ—á–µ—à –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ **—É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó** `COMPANY_ID + UNIT_ID` —É —Ç–∞–±–ª–∏—Ü—ñ `EXTERNAL_PERSONAL` ‚Äî
—Ç–æ–±—Ç–æ, —â–æ–± –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å –Ω–µ –º–æ–∂–Ω–∞ –±—É–ª–æ –¥–æ–¥–∞—Ç–∏ –æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å (`COMPANY_ID`) —ñ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (`UNIT_ID`) –≤–¥—Ä—É–≥–µ.
–Ü —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–ø—Ä–æ–±—É—î —Ü–µ –∑—Ä–æ–±–∏—Ç–∏ ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ **–∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**, –∞ –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø–æ–º–∏–ª–∫—É Oracle.

---

## üîπ 1Ô∏è‚É£ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ–≥–æ —ñ–Ω–¥–µ–∫—Å—É –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –¥–∞—Ç–∏

–Ø–∫—â–æ —Ç–æ–±—ñ –≤–∞–∂–ª–∏–≤–æ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å **–Ω–∞ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É**,
—Ç–æ–±—Ç–æ —â–æ–± –æ–¥–Ω–∞ –π —Ç–∞ —Å–∞–º–∞ –ø–∞—Ä–∞ `COMPANY_ID + UNIT_ID` –Ω–µ –¥—É–±–ª—é–≤–∞–ª–∞—Å—å **–∑–∞ –¥–µ–Ω—å**,
—Ç—Ä–µ–±–∞ –≤—Ä–∞—Ö—É–≤–∞—Ç–∏ `TRUNC(DATE_CREATE)`.

---

### ‚úÖ –í–∞—Ä—ñ–∞–Ω—Ç 1. –Ø–∫—â–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞ (–±–µ–∑ –¥–∞—Ç–∏)

```sql
CREATE UNIQUE INDEX ext_pers_uq_company_unit
ON external_personal (company_id, unit_id);
```

---

### ‚úÖ –í–∞—Ä—ñ–∞–Ω—Ç 2. –Ø–∫—â–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å ‚Äî –ª–∏—à–µ –Ω–∞ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É

Oracle –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –Ω–∞–ø—Ä—è–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó (—è–∫ `TRUNC`) —É –∑–≤–∏—á–∞–π–Ω–æ–º—É —É–Ω—ñ–∫–∞–ª—å–Ω–æ–º—É —ñ–Ω–¥–µ–∫—Å—ñ,
—Ç–æ–º—É —Ä–æ–±–∏–º–æ **function-based index**:

```sql
CREATE UNIQUE INDEX ext_pers_uq_company_unit_date
ON external_personal (company_id, unit_id, TRUNC(date_create));
```

> üîπ –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –æ–¥–Ω–∞ —ñ —Ç–∞ —Å–∞–º–∞ –∫–æ–º–ø–∞–Ω—ñ—è (`COMPANY_ID`) —É —Ç–æ–º—É —Å–∞–º–æ–º—É –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ (`UNIT_ID`)
> –º–æ–∂–µ –º–∞—Ç–∏ –ª–∏—à–µ –æ–¥–∏–Ω –∑–∞–ø–∏—Å **–Ω–∞ –æ–¥–Ω—É –¥–∞—Ç—É**.

---

## üîπ 2Ô∏è‚É£ –î–æ–¥–∞–π –∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ PL/SQL —É –ø—Ä–æ—Ü–µ—Å—ñ –≤—Å—Ç–∞–≤–∫–∏ (APEX Process)

–£ —Å–≤–æ—î–º—É –ø—Ä–æ—Ü–µ—Å—ñ `INSERT` (—è–∫–∏–π –¥–æ–¥–∞—î –∑–∞–ø–∏—Å —É `EXTERNAL_PERSONAL`),
–¥–æ–¥–∞–π –ø–µ—Ä–µ–≤—ñ—Ä–∫—É **–ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ—é**:

```plsql
DECLARE
    v_exists NUMBER;
BEGIN
    -- –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∂–µ —î —Ç–∞–∫–∏–π –∑–∞–ø–∏—Å –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
    SELECT COUNT(*) INTO v_exists
    FROM external_personal
    WHERE company_id = :P_FORM_COMPANY_ID
      AND unit_id    = :P_FORM_UNIT_ID
      AND TRUNC(date_create) = TRUNC(SYSDATE)
      AND date_end IS NULL;

    IF v_exists > 0 THEN
        -- –Ø–∫—â–æ –∑–∞–ø–∏—Å –≤–∂–µ —î, –≤–∏–∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ
        raise_application_error(
            -20001, 
            '–¢–∞–∫–∏–π –∑–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î —É –∑–≤—ñ—Ç—ñ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –π–æ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.'
        );
    END IF;

    -- –Ø–∫—â–æ –≤—Å–µ –¥–æ–±—Ä–µ ‚Äî –≤–∏–∫–æ–Ω—É—î–º–æ –≤—Å—Ç–∞–≤–∫—É
    INSERT INTO external_personal (
        id, department_id, unit_id, work_type_id, work_type_text, 
        people_count, company_id, date_create, creator
    ) VALUES (
        external_personal_seq.NEXTVAL, 
        :P_DEPARTMENT_ID,
        :P_FORM_UNIT_ID,
        :P_WORK_TYPE_ID,
        :P_WORK_TYPE_TEXT,
        :P_PEOPLE_COUNT,
        :P_FORM_COMPANY_ID,
        SYSDATE,
        :APP_USER
    );
END;
```

---

## üîπ 3Ô∏è‚É£ –í–∞—Ä—ñ–∞–Ω—Ç —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–µ—Ä (–¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∑–∞—Ö–∏—Å—Ç)

–©–æ–± –Ω–∞–≤—ñ—Ç—å –±–µ–∑ APEX –ø—Ä–æ—Ü–µ—Å—É –≤ –ë–î –Ω–µ –ø–æ—Ç—Ä–∞–ø–∏–ª–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏, –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ç—Ä–∏–≥–µ—Ä:

```sql
CREATE OR REPLACE TRIGGER trg_ext_pers_check_unique
BEFORE INSERT OR UPDATE ON external_personal
FOR EACH ROW
DECLARE
    v_exists NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_exists
    FROM external_personal
    WHERE company_id = :NEW.company_id
      AND unit_id    = :NEW.unit_id
      AND TRUNC(date_create) = TRUNC(:NEW.date_create)
      AND date_end IS NULL
      AND id <> NVL(:NEW.id, -1);

    IF v_exists > 0 THEN
        raise_application_error(
            -20002,
            '–¢–∞–∫–∏–π –∑–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î —É –∑–≤—ñ—Ç—ñ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –π–æ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.'
        );
    END IF;
END;
/
```

‚úÖ –¶–µ–π —Ç—Ä–∏–≥–µ—Ä –ø—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ö—Ç–æ—Å—å –≤—Å—Ç–∞–≤–ª—è—î –¥–∞–Ω—ñ –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ SQL Developer –∞–±–æ API.

---

## üîπ 4Ô∏è‚É£ –£ APEX (–∫–æ—Ä–µ–∫—Ç–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É)

–Ø–∫—â–æ —É –ø—Ä–æ—Ü–µ—Å—ñ –≤—Å—Ç–∞–≤–∫–∏ –±—É–¥–µ `raise_application_error`,
Oracle APEX **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç—å** —Ü–µ —ñ –ø–æ–∫–∞–∂–µ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –∑–≤–∏—á–∞–π–Ω—É –ø–æ–º–∏–ª–∫—É —É —Ñ–æ—Ä–º—ñ.

–©–æ–± –≤–∏–≥–ª—è–¥–∞–ª–æ –≥–∞—Ä–Ω–æ, –º–æ–∂–µ—à –∑—Ä–æ–±–∏—Ç–∏:

* **Display Location** = *Inline with Field* (—â–æ–± –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑‚Äô—è–≤–ª—è–ª–æ—Å—å –ø—ñ–¥ –ø–æ–ª–µ–º)
* –∞–±–æ **On Error** = *Show Notification* (—è–∫ —á–µ—Ä–≤–æ–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É–≥–æ—Ä—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏).

---

## üîπ 5Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏

| –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è         | –î–∞—Ç–∞     | –†–µ–∑—É–ª—å—Ç–∞—Ç                                               |
| ------------------ | -------- | ------------------------------------------------------- |
| Company 1 + Unit 1 | –°—å–æ–≥–æ–¥–Ω—ñ | ‚úÖ –í—Å—Ç–∞–≤–∏—Ç—å—Å—è (–ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å)                             |
| Company 1 + Unit 1 | –°—å–æ–≥–æ–¥–Ω—ñ | ‚ùå –ü–æ–º–∏–ª–∫–∞: ‚Äú–¢–∞–∫–∏–π –∑–∞–ø–∏—Å –≤–∂–µ —ñ—Å–Ω—É—î —É –∑–≤—ñ—Ç—ñ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ‚Ä¶‚Äù |
| Company 1 + Unit 1 | –ó–∞–≤—Ç—Ä–∞   | ‚úÖ –í—Å—Ç–∞–≤–∏—Ç—å—Å—è (–Ω–æ–≤–∏–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å)                 |

---

‚úÖ **–†–µ–∑—é–º–µ:**

| –ú–µ—Ö–∞–Ω—ñ–∑–º                  | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è                                                             |
| ------------------------- | ----------------------------------------------------------------------- |
| `UNIQUE INDEX`            | –ì–∞—Ä–∞–Ω—Ç—É—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó `COMPANY_ID + UNIT_ID (+ DATE_CREATE)` |
| `BEFORE INSERT TRIGGER`   | –í–∏–≤–æ–¥–∏—Ç—å –∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É                             |
| `APEX Process Validation` | –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ—é —ñ –ø–æ–∫–∞–∑—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±–µ–∑ –ø–æ–º–∏–ª–∫–∏ ORA-00001   |

---

–•–æ—á–µ—à, —â–æ–± —è –ø–æ–∫–∞–∑–∞–≤, —è–∫ –¥–æ–¥–∞—Ç–∏ —É —Ñ–æ—Ä–º—É APEX **–≤–∞–ª—ñ–¥–∞—Ü—ñ—é** –∑–∞–º—ñ—Å—Ç—å —Ç—Ä–∏–≥–µ—Ä–∞ ‚Äî —Ç–æ–±—Ç–æ —â–æ–± –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–∫–∞–∑—É–≤–∞–ª–æ—Å—å –±–µ–∑ SQL error popup, –∞ —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π APEX notification?
