–î—É–∂–µ –≥–∞—Ä–Ω–æ üëå
–¢–∏ –æ–ø–∏—Å—É—î—à —ñ–¥–µ–∞–ª—å–Ω—É –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É –¥–ª—è **–ø—ñ–¥—Å—É–º–∫–æ–≤–æ–≥–æ –∑–≤—ñ—Ç—É –ø–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∞—Ö** ‚Äî –∫–æ–ª–∏:

* —É –∫–æ–∂–Ω–æ–º—É **–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ (unit_name)** –≤–∏–≤–æ–¥—è—Ç—å—Å—è –≤—Å—ñ –∫–æ–º–ø–∞–Ω—ñ—ó (–≤–∏–∫–æ–Ω–∞–≤—Ü—ñ);
* –ø—ñ–¥ –∫–æ–∂–Ω–∏–º –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–æ–º —ñ–¥–µ —Ä—è–¥–æ–∫ **‚Äú–í—Å—å–æ–≥–æ‚Äù**, —â–æ —Å—É–º—É—î –ø–µ—Ä—Å–æ–Ω–∞–ª –ª–∏—à–µ –ø–æ —Ü—å–æ–º—É –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É;
* –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –ø–æ –≤—Å—ñ–π —Ç–∞–±–ª–∏—Ü—ñ.

---

## üîπ –ü—Ä–∞–≤–∏–ª—å–Ω–µ SQL-—Ä—ñ—à–µ–Ω–Ω—è (—ñ–∑ –æ–∫—Ä–µ–º–∏–º–∏ –ø—ñ–¥—Å—É–º–∫–∞–º–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É)

```sql
WITH base_data AS (
    SELECT 
        u.name AS unit_name,
        c.name AS company_name,
        SUM(ep.people_count) AS total_people,
        0 AS is_total
    FROM external_personal ep
        JOIN company c       ON c.id = ep.company_id
        JOIN company_type ct ON ct.id = c.company_type_id
        JOIN units u         ON u.id = ep.unit_id
    WHERE 
        TRUNC(ep.date_create) = TRUNC(:P_REPORT_DATE)
        AND ep.department_id IN (
            SELECT TO_NUMBER(column_value)
            FROM TABLE(apex_string.split(:P_REPORT_DEPARTMENTS, ':'))
        )
        AND ep.date_end IS NULL
    GROUP BY u.name, c.name
),
unit_totals AS (
    SELECT 
        u.name AS unit_name,
        '–í—Å—å–æ–≥–æ' AS company_name,
        SUM(ep.people_count) AS total_people,
        1 AS is_total
    FROM external_personal ep
        JOIN units u ON u.id = ep.unit_id
    WHERE 
        TRUNC(ep.date_create) = TRUNC(:P_REPORT_DATE)
        AND ep.department_id IN (
            SELECT TO_NUMBER(column_value)
            FROM TABLE(apex_string.split(:P_REPORT_DEPARTMENTS, ':'))
        )
        AND ep.date_end IS NULL
    GROUP BY u.name
)
SELECT *
FROM (
    SELECT * FROM base_data
    UNION ALL
    SELECT * FROM unit_totals
)
ORDER BY unit_name, is_total, company_name;
```

---

## üîπ –©–æ —Ü–µ–π SQL —Ä–æ–±–∏—Ç—å

| –ß–∞—Å—Ç–∏–Ω–∞                                      | –û–ø–∏—Å                                                          |
| -------------------------------------------- | ------------------------------------------------------------- |
| `base_data`                                  | –∑–±–∏—Ä–∞—î –∑–≤–∏—á–∞–π–Ω—ñ —Ä—è–¥–∫–∏: –∫–æ–º–ø–∞–Ω—ñ—è ‚Äî –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å       |
| `unit_totals`                                | –¥–æ–¥–∞—î –æ–¥–∏–Ω —Ä—è–¥–æ–∫ `"–í—Å—å–æ–≥–æ"` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É            |
| `is_total`                                   | –ø–æ–∑–Ω–∞—á–∫–∞ (0 ‚Äì –∑–≤–∏—á–∞–π–Ω–∏–π, 1 ‚Äì –ø—ñ–¥—Å—É–º–æ–∫) –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–º |
| `ORDER BY unit_name, is_total, company_name` | –∑–∞–±–µ–∑–ø–µ—á—É—î –ø–æ—Ä—è–¥–æ–∫ ‚Äú—Å–ø–æ—á–∞—Ç–∫—É –∫–æ–º–ø–∞–Ω—ñ—ó ‚Üí –ø–æ—Ç—ñ–º –í—Å—å–æ–≥–æ‚Äù         |

---

## üîπ –ü—Ä–∏–∫–ª–∞–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É

```
UNIT_NAME: –í—ñ–¥–¥—ñ–ª 1
-------------------------------------
–ö–æ–º–ø–∞–Ω—ñ—è 1    | –í—ñ–¥–¥—ñ–ª 1 |  12
–ö–æ–º–ø–∞–Ω—ñ—è 2    | –í—ñ–¥–¥—ñ–ª 1 |  10
–ö–æ–º–ø–∞–Ω—ñ—è 3    | –í—ñ–¥–¥—ñ–ª 1 |   3
-------------------------------------
–í—Å—å–æ–≥–æ        | –í—ñ–¥–¥—ñ–ª 1 |  25 ‚úÖ

UNIT_NAME: –í—ñ–¥–¥—ñ–ª 2
-------------------------------------
–ö–æ–º–ø–∞–Ω—ñ—è 1    | –í—ñ–¥–¥—ñ–ª 2 |   6
–ö–æ–º–ø–∞–Ω—ñ—è 4    | –í—ñ–¥–¥—ñ–ª 2 |   9
-------------------------------------
–í—Å—å–æ–≥–æ        | –í—ñ–¥–¥—ñ–ª 2 |  15 ‚úÖ
```

---

## üîπ –Ø–∫ –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ —Ä—è–¥–æ–∫ ‚Äú–í—Å—å–æ–≥–æ‚Äù –≤ APEX

1. –£ Interactive Report –¥–æ–¥–∞–π **Highlight Rule**:

   * Condition: `IS_TOTAL = 1`
   * Style:

   ```css
   background-color: #d4edda !important;
   color: #155724 !important;
   font-weight: bold;
   border-top: 2px solid #b7e4c7;
   ```

---

## üîπ –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ (—è–∫—â–æ —Ö–æ—á–µ—à —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ—Å—Ç—å)

–ú–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç, —â–æ–± —É `base_data` –∑–∞–ª–∏—à–∏—Ç–∏ `company_type_name` ‚Äî —Ç–æ–¥—ñ —Ç–∏ –∑–º–æ–∂–µ—à –≥—Ä—É–ø—É–≤–∞—Ç–∏ –∫–æ–º–ø–∞–Ω—ñ—ó –≤ –º–µ–∂–∞—Ö –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É –∑–∞ —Ç–∏–ø–æ–º (–¥–µ—Ä–∂–∞–≤–Ω—ñ / –ø—Ä–∏–≤–∞—Ç–Ω—ñ).

–¢–æ–±—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π —É `base_data`:

```sql
ct.name AS company_type_name,
```

—ñ –≤ `GROUP BY` ‚Üí `u.name, ct.name, c.name`.

> –¶–µ –Ω–µ –≤–ø–ª–∏–Ω–µ –Ω–∞ –ø—ñ–¥—Å—É–º–∫–æ–≤–∏–π ‚Äú–í—Å—å–æ–≥–æ‚Äù, –∞–ª–µ –¥–∞—Å—Ç—å –∑–º–æ–≥—É –∫—Ä–∞—Å–∏–≤–æ –≥—Ä—É–ø—É–≤–∞—Ç–∏ —É –∑–≤—ñ—Ç—ñ.

---

‚úÖ **–ü—ñ–¥—Å—É–º–æ–∫:**

* –ö–æ–∂–µ–Ω –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª –º–∞—î –≤–ª–∞—Å–Ω–∏–π –±–ª–æ–∫ –∫–æ–º–ø–∞–Ω—ñ–π + –æ–∫—Ä–µ–º–∏–π –∑–µ–ª–µ–Ω–∏–π —Ä—è–¥–æ–∫ ‚Äú–í—Å—å–æ–≥–æ‚Äù.
* –ù–µ–º–∞—î –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ç–æ—Ç–∞–ª—É.
* –ü—Ä–∞—Ü—é—î –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ `P_REPORT_DATE` —ñ `P_REPORT_DEPARTMENTS`.
* –ü–æ–≤–Ω—ñ—Å—Ç—é —Å—É–º—ñ—Å–Ω–æ –∑ —Ç–≤–æ—î—é –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é APEX (Dynamic Refresh, Highlight).

---

–•–æ—á–µ—à, —â–æ–± —è –ø–æ–∫–∞–∑–∞–≤, —è–∫ –¥–æ–¥–∞—Ç–∏ **–∑–∞–≥–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–∫–æ–≤–∏–π —Ä—è–¥–æ–∫ ‚Äú–í—Å—å–æ–≥–æ –ø–æ –≤—Å—ñ—Ö –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∞—Ö‚Äù** (—Ç–æ–±—Ç–æ –æ–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫ —É —Å–∞–º–æ–º—É –Ω–∏–∑—É –∑–≤—ñ—Ç—É)?
