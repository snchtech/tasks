–°—É–ø–µ—Ä –∫–æ–ª–æ–Ω–∫–∞, –¥—É–∂–µ –∫–æ—Ä–∏—Å–Ω–∞ üëç
–î–∞–≤–∞–π –∑—Ä–æ–±–∏–º–æ —ó—ó –∞–∫—É—Ä–∞—Ç–Ω–æ –π —Ç–∞–∫, —â–æ–± –ø–æ—Ç—ñ–º –ª–µ–≥–∫–æ –±—É–ª–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É.

–¢–∏ —Ö–æ—á–µ—à:

> ¬´–ö-—Å—Ç—å –¥–Ω—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å¬ª ‚Äì **–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è**,
> –±–µ–∑ —Å—É–±–æ—Ç–∏ (6) —ñ –Ω–µ–¥—ñ–ª—ñ (7).

–Ø –∑–∞–ø—Ä–æ–ø–æ–Ω—É—é –≤–∞—Ä—ñ–∞–Ω—Ç —á–µ—Ä–µ–∑ –º–∞–ª–µ–Ω—å–∫—É —Ñ—É–Ω–∫—Ü—ñ—é –≤ –ë–î + —è–∫ —ó—ó –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≤ –æ—Å–Ω–æ–≤–Ω–∏–π –∑–≤—ñ—Ç.

---

## 1. –§—É–Ω–∫—Ü—ñ—è `WORKDAYS_BETWEEN` –≤ —Å—Ö–µ–º—ñ TaskTracker (–∞–±–æ –∑–∞–≥–∞–ª—å–Ω—ñ–π)

–õ–æ–≥—ñ–∫–∞:

* –†–∞—Ö—É—î **—Ä–æ–±–æ—á—ñ –¥–Ω—ñ –º—ñ–∂ –¥–≤–æ–º–∞ –¥–∞—Ç–∞–º–∏ –≤–∫–ª—é—á–Ω–æ**.
* –í–∏—Ö—ñ–¥–Ω—ñ ‚Äì –∫–æ–ª–∏ `TO_CHAR(date,'D') IN ('6','7')` (—è–∫ —Ç–∏ –π –Ω–∞–ø–∏—Å–∞–ª–∞).
* –Ø–∫—â–æ `p_end < p_start` ‚Äì –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 0.

```sql
CREATE OR REPLACE FUNCTION workdays_between (
    p_start IN DATE,
    p_end   IN DATE
) RETURN NUMBER DETERMINISTIC IS
    l_start DATE;
    l_end   DATE;
    l_cnt   NUMBER := 0;
BEGIN
    IF p_start IS NULL OR p_end IS NULL THEN
        RETURN NULL;
    END IF;

    l_start := TRUNC(p_start);
    l_end   := TRUNC(p_end);

    IF l_end < l_start THEN
        RETURN 0;
    END IF;

    WHILE l_start <= l_end LOOP
        -- 6 = —Å—É–±–æ—Ç–∞, 7 = –Ω–µ–¥—ñ–ª—è (—Ç–≤–æ—è —Å—Ö–µ–º–∞)
        IF TO_CHAR(l_start,'D') NOT IN ('6','7') THEN
            l_cnt := l_cnt + 1;
        END IF;

        l_start := l_start + 1;
    END LOOP;

    RETURN l_cnt;
END;
/
```

> –§—É–Ω–∫—Ü—ñ—è `DETERMINISTIC`, —â–æ–± Oracle –º—ñ–≥ —ó—ó –∫–µ—à—É–≤–∞—Ç–∏, —è–∫—â–æ —â–æ.

---

## 2. –Ø–∫ —Å–∞–º–µ —Ä–∞—Ö—É–≤–∞—Ç–∏ ¬´–∑–∞–ª–∏—à–∏–ª–æ—Å—å¬ª

–ü—Ä–æ–ø–æ–Ω—É—é —Ç–∞–∫—É –ª–æ–≥—ñ–∫—É:

* –í—ñ–¥–ª—ñ–∫ **–≤—ñ–¥ —Å—å–æ–≥–æ–¥–Ω—ñ** (SYSDATE), –∞–ª–µ:

  * —è–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–∞—Ä—Ç—É—î –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É ‚Äì —Ä–∞—Ö—É—î–º–æ –∑ `planning_date_start`;
  * —è–∫—â–æ –≤–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—ñ ‚Äì —Ä–∞—Ö—É—î–º–æ –∑ —Å—å–æ–≥–æ–¥–Ω—ñ.
* –ö—ñ–Ω–µ—Ü—å ‚Äì `planning_date_end`.
* –Ø–∫—â–æ –∫—ñ–Ω–µ—Ü—å —É–∂–µ –º–∏–Ω—É–≤ ‚Üí 0 –¥–Ω—ñ–≤.

–û—Ç–∂–µ, –¥–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É –¥–ª—è –≤—ñ–¥–ª—ñ–∫—É:

```sql
GREATEST(TRUNC(SYSDATE), TRUNC(t.PLANNING_DATE_START))
```

---

## 3. –î–æ–¥–∞—î–º–æ –∫–æ–ª–æ–Ω–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–∏–π SQL (–∂—É—Ä–Ω–∞–ª –∑–∞–≤–¥–∞–Ω—å)

–£ —Ç–≤–æ—î–º—É –æ—Å–Ω–æ–≤–Ω–æ–º—É SELECT (—Ç–∞–º, –¥–µ `SELECT t.TASK_ID, ...`) –¥–æ–¥–∞—î—à:

```sql
CASE
    WHEN t.PLANNING_DATE_END IS NULL THEN NULL
    ELSE workdays_between(
           GREATEST(TRUNC(SYSDATE), TRUNC(t.PLANNING_DATE_START)),
           TRUNC(t.PLANNING_DATE_END)
         )
END AS DAYS_LEFT
```

–ù–∞–ø—Ä–∏–∫–ª–∞–¥:

```sql
SELECT
    t.TASK_ID,
    TO_CHAR(t.PLANNING_DATE_START, 'dd.mm.yyyy hh24:mi') AS PLANNING_DATE_START,
    t.UNIT_NAME,
    t.TASK_DESCRIPTION_HTML,
    t.CREATOR_INFO,
    t.EXECUTOR_INFO,
    TO_CHAR(t.PLANNING_DATE_END, 'dd.mm.yyyy hh24:mi') AS PLANNING_DATE_END,
    ...

    CASE
        WHEN t.PLANNING_DATE_END IS NULL THEN NULL
        ELSE workdays_between(
               GREATEST(TRUNC(SYSDATE), TRUNC(t.PLANNING_DATE_START)),
               TRUNC(t.PLANNING_DATE_END)
             )
    END AS DAYS_LEFT,

    t.STATUS_NAME,
    t.DEPARTMENT_NAME,
    ...
FROM tasks_with_access t
ORDER BY t.DATE_CREATE DESC;
```

---

## 4. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ APEX

1. –£ –∑–≤—ñ—Ç—ñ (IR / Classic Report) –∑‚Äô—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ `DAYS_LEFT`.
2. –î–ª—è –Ω–µ—ó:

   * Header: **–ö-—Å—Ç—å –¥–Ω—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å**
   * Alignment: Right
   * –¢–∏–ø –∫–æ–ª–æ–Ω–∫–∏: Number (–±–µ–∑ Escape, –±–æ —Ç–∞–º —Ü–∏—Ñ—Ä–∞, –º–æ–∂–Ω–∞ –π –∑–∞–ª–∏—à–∏—Ç–∏ Escape = Yes).

---

## 5. –Ø–∫—â–æ —Ç–æ–±—ñ —Ç—Ä–µ–±–∞ **–ø–æ–≤–Ω–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å** (–∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤, –∞ –Ω–µ ¬´–∑–∞–ª–∏—à–∏–ª–æ—Å—å¬ª)

–ú–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ —â–µ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É:

```sql
CASE
    WHEN t.PLANNING_DATE_START IS NULL OR t.PLANNING_DATE_END IS NULL THEN NULL
    ELSE workdays_between(
           TRUNC(t.PLANNING_DATE_START),
           TRUNC(t.PLANNING_DATE_END)
         )
END AS TOTAL_WORK_DAYS
```

–¢–æ–¥—ñ –≤ –æ–¥–Ω–æ–º—É –∑–≤—ñ—Ç—ñ –±—É–¥–µ—à –±–∞—á–∏—Ç–∏ —ñ ¬´–≤—Å—å–æ–≥–æ —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤¬ª, —ñ ¬´—Å–∫—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—å¬ª.

---

–Ø–∫—â–æ —Å–∫–∞–∂–µ—à, —â–æ —Ö–æ—á–µ—à —Ä–∞—Ö—É–≤–∞—Ç–∏ —ñ–Ω–∞–∫—à–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **–∑–∞–≤–∂–¥–∏ –≤—ñ–¥ planning_date_start**, –∞ –Ω–µ –≤—ñ–¥ —Å—å–æ–≥–æ–¥–Ω—ñ) ‚Äì –ø—Ä–æ—Å—Ç–æ –ø—ñ–¥–ø—Ä–∞–≤–∏–º–æ 1 —Ä—è–¥–æ–∫ —É –≤–∏—Ä–∞–∑—ñ –∑ `GREATEST`.
