–ê–≥–∞, —Ç–µ–ø–µ—Ä –ø–∞–∑–ª —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è üëç
–¢–≤—ñ–π `UPDATE`:

```plsql
UPDATE USER_TAG
   SET date_end       = SYSTIMESTAMP,
       deactivation_by = :P5_UID
 WHERE id = :P5_ID;
```

**—Å–∞–º –ø–æ —Å–æ–±—ñ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π** ‚Äì –≤—ñ–Ω –Ω–µ —á—ñ–ø–∞—î –Ω—ñ `TAG_TYPE_ID`, –Ω—ñ `TAG_CODE`.
–ê–ª–µ –ø–æ–º–∏–ª–∫–∞, —è–∫—É —Ç–∏ –±–∞—á–∏—à, —á—ñ—Ç–∫–æ –∫–∞–∂–µ:

> ORA-00001: unique constraint ‚Ä¶ **UX_USER_TAG_ACTIVE_CODE**

–¢–æ–±—Ç–æ ‚Äú—Å—Ç—Ä—ñ–ª—è—î‚Äù —Å–∞–º–µ **—ñ–Ω–¥–µ–∫—Å –ø–æ –∫–æ–¥—É –º—ñ—Ç–∫–∏**, –∞ –Ω–µ —Ç–æ–π, —â–æ –ø–æ `USER_ID`.

---

## 1. –©–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è

–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å `UX_USER_TAG_ACTIVE_CODE` –∑–∞—Ä–∞–∑ –ø—Ä–∞—Ü—é—î —Ç–∞–∫, —â–æ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ `DATE_END` –≤—ñ–Ω –≤–≤–∞–∂–∞—î, –Ω—ñ–±–∏ —Ç–∏ —Å—Ç–≤–æ—Ä—é—î—à **–¥—Ä—É–≥–∏–π –∑–∞–ø–∏—Å –∑ —Ç–∏–º —Å–∞–º–∏–º `(TAG_TYPE_ID, TAG_CODE, ‚Ä¶)`**, —ñ –∫–∞–∂–µ: *‚Äú—Å—Ç–æ–ø, —Ç–∞–∫ –Ω–µ –º–æ–∂–Ω–∞‚Äù*.

–¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —ñ–Ω–¥–µ–∫—Å, —à–≤–∏–¥—à–µ –∑–∞ –≤—Å–µ, —Å—Ç–≤–æ—Ä–µ–Ω–∏–π **–Ω–µ –≤ —Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ, —è–∫ –º–∏ –∑–∞–¥—É–º—É–≤–∞–ª–∏**, –∞ —Ç–∏–ø—É:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_code ON user_tag (
  tag_type_id,
  tag_code,
  NVL(date_end, DATE '1900-01-01')
);
```

–∞–±–æ

```sql
CREATE UNIQUE INDEX ux_user_tag_active_code ON user_tag (
  tag_type_id,
  tag_code,
  CASE WHEN date_end IS NULL THEN 1 ELSE 1 END   -- –ø–æ —Ñ–∞–∫—Ç—É –∑–∞–≤–∂–¥–∏ 1
);
```

–∞–±–æ —â–æ—Å—å –±–ª–∏–∑—å–∫–µ –¥–æ —Ü—å–æ–≥–æ.
–£ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É:

* **—ñ –∞–∫—Ç–∏–≤–Ω—ñ, —ñ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ** –∑–∞–ø–∏—Å–∏ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ –∫–ª—é—á—ñ ‚Üí —ñ–Ω–¥–µ–∫—Å –≤–∏–º–∞–≥–∞—î, —â–æ–± **—É—Å—å–æ–≥–æ –æ–¥–∏–Ω —Ä—è–¥–æ–∫** –∑ —Ç–∞–∫–∏–º `(tag_type_id, tag_code)` —ñ—Å–Ω—É–≤–∞–≤ —É —Ç–∞–±–ª–∏—Ü—ñ;
* –∫–æ–ª–∏ —Ç–∏ –¥–µ–∞–∫—Ç–∏–≤—É—î—à —â–µ –æ–¥–Ω—É –º—ñ—Ç–∫—É –¥–ª—è —Ç–æ–≥–æ –∂ `(TAG_TYPE_ID, TAG_CODE)`, —ñ–Ω–¥–µ–∫—Å –∫–∞–∂–µ:
  *‚Äú–∞–ª–µ –∂ —Ç–∞–∫–∞ –º—ñ—Ç–∫–∞ –≤–∂–µ —î –≤ —ñ—Å—Ç–æ—Ä—ñ—ó, –¥—Ä—É–≥–∞ –º–µ–Ω—ñ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞‚Äù* ‚Üí ORA-00001.

–ê –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **—ñ–Ω—à—É –ª–æ–≥—ñ–∫—É**:

> **–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞** –∑ –ø–µ–≤–Ω–∏–º `(TAG_TYPE_ID, TAG_CODE)`
> **–º–æ–∂–µ –±—É—Ç–∏ –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö** –∑–∞–ø–∏—Å—ñ–≤ –∑ —Ç–∞–∫–∏–º –∂–µ –∫–æ–¥–æ–º.

---

## 2. –Ø–∫ –∑—Ä–æ–±–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å, —è–∫–∏–π —Ü–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î

–ù–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç ‚Äì –∑—Ä–æ–±–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å, —è–∫–∏–π **–±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏**.

### üëç –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç —ñ–Ω–¥–µ–∫—Å—É

```sql
DROP INDEX ux_user_tag_active_code;

CREATE UNIQUE INDEX ux_user_tag_active_code
  ON user_tag (
    CASE WHEN date_end IS NULL THEN tag_type_id END,
    CASE WHEN date_end IS NULL THEN tag_code   END
  );
```

–©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î:

* **–ê–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏** (`DATE_END IS NULL`) ‚Üí –∫–ª—é—á:
  `(TAG_TYPE_ID, TAG_CODE)`
* **–ù–µ–∞–∫—Ç–∏–≤–Ω—ñ** (`DATE_END IS NOT NULL`) ‚Üí
  `(NULL, NULL)` ‚Üí —Ç–∞–∫–∏—Ö —Ä—è–¥–∫—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ (Oracle –¥–æ–∑–≤–æ–ª—è—î –±–∞–≥–∞—Ç–æ NULL —É unique-—ñ–Ω–¥–µ–∫—Å—ñ).

–¢–µ–ø–µ—Ä:

* –¥—Ä—É–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –∑ —Ç–∏–º —Å–∞–º–∏–º `(TAG_TYPE_ID, TAG_CODE)` ‚Üí **ORA-00001** (—ñ —Ü–µ –¥–æ–±—Ä–µ ‚Äì –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∞—Ü—é—î);
* —Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∑ —Ü–∏–º –∫–æ–¥–æ–º ‚Üí **–¥–æ–∑–≤–æ–ª–µ–Ω–æ**;
* —Ç–≤—ñ–π `UPDATE ... SET DATE_END = SYSTIMESTAMP`:

  * –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å ‚Üí —Å—Ç–∞—î –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–º;
  * –∫–ª—é—á –∑ `(TAG_TYPE_ID, TAG_CODE)` ‚Üí —Å—Ç–∞—î `(NULL, NULL)`;
  * –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –Ω–µ–º–∞—î.

---

## 3. –ß–∏ —Ç—Ä–µ–±–∞ –º—ñ–Ω—è—Ç–∏ —Å–∞–º `UPDATE`?

–ù—ñ, —Ç–≤—ñ–π –∞–ø–¥–µ–π—Ç:

```plsql
UPDATE USER_TAG
   SET date_end       = SYSTIMESTAMP,
       deactivation_by = :P5_UID
 WHERE id = :P5_ID;
```

‚Äî **—ñ–¥–µ–∞–ª—å–Ω–∏–π** –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó:

* —Ç–∏ –Ω–µ —á—ñ–ø–∞—î—à `TAG_CODE`, `TAG_TYPE_ID`, `USER_ID`;
* –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏—à `DATE_END` —ñ —Ñ—ñ–∫—Å—É—î—à `DEACTIVATION_BY`.

–ü—Ä–æ–±–ª–µ–º–∞ –±—É–ª–∞ –Ω–µ –≤ –∞–ø–¥–µ–π—Ç—ñ, –∞ –≤ —Ç–æ–º—É, **—è–∫ –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å `UX_USER_TAG_ACTIVE_CODE`**.

---

## 4. –©–æ —Ä–æ–±–∏—Ç–∏ –∑–∞—Ä–∞–∑ –ø–æ –∫—Ä–æ–∫–∞—Ö

1. –í –ë–î –¥—Ä–æ–ø–Ω—É—Ç–∏ —Å—Ç–∞—Ä–∏–π —ñ–Ω–¥–µ–∫—Å:

   ```sql
   DROP INDEX ux_user_tag_active_code;
   ```

2. –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π, –ª–∏—à–µ –ø–æ ‚Äú–∞–∫—Ç–∏–≤–Ω–∏—Ö‚Äù –º—ñ—Ç–∫–∞—Ö:

   ```sql
   CREATE UNIQUE INDEX ux_user_tag_active_code
     ON user_tag (
       CASE WHEN date_end IS NULL THEN tag_type_id END,
       CASE WHEN date_end IS NULL THEN tag_code   END
     );
   ```

3. –ó–Ω–æ–≤—É —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –º—ñ—Ç–∫—É —á–µ—Ä–µ–∑ —Ç–≤—ñ–π APEX-–∫–æ–¥.

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ:

* –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è **–Ω–µ –±—É–¥–µ** –¥–∞–≤–∞—Ç–∏ ORA-00001;
* —ñ–Ω–¥–µ–∫—Å —É—Å–µ —â–µ –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏–º–µ, —â–æ –¥–ª—è –ø–µ–≤–Ω–æ–≥–æ `(TAG_TYPE_ID, TAG_CODE)`
  –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ **–¥–≤–æ—Ö –∞–∫—Ç–∏–≤–Ω–∏—Ö** –∑–∞–ø–∏—Å—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –º–æ–∂–µ–º–æ —â–µ –¥–æ–¥–∞—Ç–∏:

* —Ç–∞–∫–∏–π —Å–∞–º–∏–π ‚Äú—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö‚Äù —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –ø–æ `(USER_ID, TAG_TYPE_ID)`, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –º–∞–≤ –¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø—É (‚Äú–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞‚Äù).
