–û—Ü–µ —è–∫—Ä–∞–∑ —Ç–æ–π –º–æ–º–µ–Ω—Ç, –¥–µ –ë–î –º–∞—î ‚Äú—Å—Ç—Ä–∞—Ö—É–≤–∞—Ç–∏‚Äù –±—É–¥—å-—è–∫—É –¥—É—Ä–Ω–∏—Ü—é –∑ –±–æ–∫—É —Ñ–æ—Ä–º–∏ üí™
–ó—Ä–æ–±–∏–º–æ **—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ APEX**, —ñ **–∂–æ—Ä—Å—Ç–∫—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –≤ –ë–î**.

–Ø –±—É–¥—É –¥–∞–ª—ñ –æ–ø–∏—Ä–∞—Ç–∏—Å—å –Ω–∞ —Ç—É –∂ —Ñ–æ—Ä–º—É –∑ item‚Äô–∞–º–∏:

* `P210_USER_ID`
* `P210_TAG_TYPE_ID`
* `P210_TAG_CODE_INPUT`  ‚Äì —Å–∏—Ä–∏–π –≤–≤—ñ–¥ (hex/decimal/Android —Ñ–æ—Ä–º–∞—Ç)
* `P210_TAG_CODE`        ‚Äì –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –¥–µ—Å—è—Ç–∫–æ–≤–∏–π –∫–æ–¥ (—Ç–µ, —â–æ –ø–∏—à–µ–º–æ –≤ –ë–î)

—ñ –Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—é:

```plsql
normalize_tag_code(p_raw IN VARCHAR2) RETURN VARCHAR2;
```

---

## 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ INSERT: —á–∏ –≤–∂–µ —î —Ç–∞–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –≤ –ë–î

### APEX Validation (PL/SQL function returning error text)

**–ù–∞–∑–≤–∞:** `VAL_TAG_GLOBAL_UNIQUE`
**–¢–∏–ø:** PL/SQL Function (returning error text)
**Button:** –ø—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏ –¥–æ –∫–Ω–æ–ø–∫–∏ ‚Äú–î–æ–¥–∞—Ç–∏ –∑–≤‚Äô—è–∑–æ–∫‚Äù

```plsql
DECLARE
  v_dec_code      VARCHAR2(128);
  v_cnt           NUMBER;
  v_exist_user_id user_tag.user_id%TYPE;
  v_exist_name    users.user_name%TYPE;
BEGIN
  -- 1. –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –∫–æ–¥ (—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –ø—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª—é—î–º–æ —Ñ–æ—Ä–º–∞—Ç)
  v_dec_code := normalize_tag_code(:P210_TAG_CODE_INPUT);

  -- –∑–∞–ø–∏—Å—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥ –≤ item, —â–æ–± –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≤ INSERT
  :P210_TAG_CODE := v_dec_code;

  -- 2. –ß–∏ –≤–∂–µ —ñ—Å–Ω—É—î —Ç–∞–∫–∞ –ê–ö–¢–ò–í–ù–ê –º—ñ—Ç–∫–∞ (–±—É–¥—å-—è–∫–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É)
  BEGIN
    SELECT ut.user_id, u.user_name
      INTO v_exist_user_id, v_exist_name
      FROM user_tag ut
      JOIN users u ON u.user_id = ut.user_id
     WHERE ut.tag_type_id = :P210_TAG_TYPE_ID
       AND ut.tag_code    = v_dec_code
       AND ut.date_end IS NULL
       FETCH FIRST 1 ROW ONLY;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      v_exist_user_id := NULL;
  END;

  IF v_exist_user_id IS NOT NULL THEN
    RETURN '–¢–∞–∫–∞ –º—ñ—Ç–∫–∞ –≤–∂–µ —î –≤ –±–∞–∑—ñ –π –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∞ –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ' ||
           v_exist_name ||
           '. –í–∏ –Ω–µ –∑–º–æ–∂–µ—Ç–µ –≤–∏–¥–∞—Ç–∏ —ó—ó —ñ–Ω—à–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É. ' ||
           '–°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—è —ñ–Ω—à–æ—é –º—ñ—Ç–∫–æ—é.';
  END IF;

  RETURN NULL; -- –≤—Å–µ –æ–∫, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–π–¥–µ–Ω–∞
END;
```

> –¶–µ –¥–∞—î —Ç–µ —Å–∞–º–µ ‚Äúwarning‚Äù-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∞–ª–µ —É –≤–∏–≥–ª—è–¥—ñ APEX error (—Ç–æ–±—Ç–æ –±–ª–æ–∫—É–≤–∞—Ç–∏–º–µ INSERT, —è–∫ —Ç–∏ —ñ —Ö–æ—á–µ—à).

---

## 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –≤–∂–µ —î –≤ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞

–¢—É—Ç –ª–æ–≥—ñ–∫–∞: **–æ–¥–∏–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ (–¥–ª—è —Ü—å–æ–≥–æ —Ç–∏–ø—É)**.
–Ø–∫—â–æ –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –Ω–µ –¥–∞—î–º–æ –¥–æ–¥–∞—Ç–∏ —â–µ –æ–¥–Ω—É.

–ú–æ–∂–µ–º–æ:

* –∞–±–æ –∑—Ä–æ–±–∏—Ç–∏ **–¥—Ä—É–≥—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—é**;
* –∞–±–æ –≤—Å–µ –≤ –æ–¥–Ω–æ–º—É –±–ª–æ—Ü—ñ.
  –Ø –ø–æ–∫–∞–∂—É **–æ–∫—Ä–µ–º—É** ‚Äì —Ç–∞–∫ –Ω–∞–æ—á–Ω—ñ—à–µ.

### APEX Validation: `VAL_USER_ALREADY_HAS_ACTIVE_TAG`

**–¢–∏–ø:** PL/SQL Function (returning error text)

```plsql
DECLARE
  v_existing_code user_tag.tag_code%TYPE;
BEGIN
  BEGIN
    SELECT ut.tag_code
      INTO v_existing_code
      FROM user_tag ut
     WHERE ut.user_id     = :P210_USER_ID
       AND ut.tag_type_id = :P210_TAG_TYPE_ID
       AND ut.date_end IS NULL
       FETCH FIRST 1 ROW ONLY;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      v_existing_code := NULL;
  END;

  IF v_existing_code IS NOT NULL THEN
    RETURN '–£ –¥–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –∑ –Ω–æ–º–µ—Ä–æ–º ' ||
           v_existing_code ||
           '. –©–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—É, –¥–µ–∞–∫—Ç–∏–≤—É–π—Ç–µ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –º—ñ—Ç–∫—É.';
  END IF;

  RETURN NULL;
END;
```

> –¶—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ø—Ä–∞—Ü—é—î **–ø—ñ—Å–ª—è** –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó (–∞–±–æ –¥–æ, –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –ø–æ—Ä—è–¥–∫—É, —è–∫–∏–π –∑–∞–¥–∞—Å–∏).
> –°—É—Ç—å: –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –º–æ–∂–µ –º–∞—Ç–∏ –¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø—É.

---

## 3. –ü—Ä–æ—Ü–µ—Å INSERT –ø—ñ—Å–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ–π

–¢–µ–ø–µ—Ä –ø—Ä–æ—Ü–µ—Å –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç–∞—î –¥—É–∂–µ –ø—Ä–æ—Å—Ç–∏–º ‚Äî –≤—ñ–Ω —É–∂–µ –ø—Ä–∞—Ü—é—î –∑ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º —ñ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–º –∫–æ–¥–æ–º:

```plsql
BEGIN
  INSERT INTO user_tag (user_id, tag_type_id, tag_code, created_at)
  VALUES (:P210_USER_ID,
          :P210_TAG_TYPE_ID,
          :P210_TAG_CODE,   -- –≤–∂–µ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–¥
          SYSTIMESTAMP);

  apex_application.g_print_success_message :=
    '–ó–≤‚Äô—è–∑–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Äì –º—ñ—Ç–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ.';
END;
```

---

## 4. –£–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î

–©–æ–± –ø—Ä–∞–≤–∏–ª–∞ **–∑–∞–ª—ñ–∑–Ω–æ —Ç—Ä–∏–º–∞–ª–∏—Å—è**, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ö—Ç–æ—Å—å –æ–±—ñ–π–¥–µ APEX —ñ –ª—ñ–∑—Ç–∏–º–µ –Ω–∞–ø—Ä—è–º—É –≤ –ë–î:

### 4.1. –û–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –∑ –ø–µ–≤–Ω–∏–º –∫–æ–¥–æ–º (–≥–ª–æ–±–∞–ª—å–Ω–æ)

**–ó–∞–¥–∞—á–∞:** –æ–¥–∏–Ω —Ñ—ñ–∑–∏—á–Ω–∏–π tag_code (–¥–ª—è –∑–∞–¥–∞–Ω–æ–≥–æ —Ç–∏–ø—É) –º–æ–∂–µ –±—É—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑.

–°—Ç–≤–æ—Ä–∏–º–æ **—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å**
(–ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä—è–¥–∫—ñ–≤, –¥–µ `date_end IS NULL`):

```plsql
CREATE UNIQUE INDEX ux_user_tag_active_code
  ON user_tag (
    tag_type_id,
    tag_code,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

* –¥–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ (`date_end IS NULL`) –≤–∏—Ä–∞–∑ –¥–∞—î `1` ‚Üí
  —ñ–Ω–¥–µ–∫—Å –∑–±–µ—Ä—ñ–≥–∞—î `(tag_type_id, tag_code, 1)` —ñ **–∑–∞–±–æ—Ä–æ–Ω—è—î –¥—É–±–ª—å**;
* –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö (`date_end NOT NULL`) –≤–∏—Ä–∞–∑ –¥–∞—î `NULL` ‚Üí
  Oracle –¥–æ–∑–≤–æ–ª—è—î –±–∞–≥–∞—Ç–æ —Ä—è–¥–∫—ñ–≤ —ñ–∑ NULL —É —É–Ω—ñ–∫–∞–ª—å–Ω–æ–º—É —ñ–Ω–¥–µ–∫—Å—ñ,
  —Ç–æ–º—É –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –º–æ–∂–µ –±—É—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∑ —Ç–∏–º —Å–∞–º–∏–º –∫–æ–¥–æ–º.

---

### 4.2. –û–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

–Ø–∫—â–æ —Ö–æ—á–µ—à –ø—Ä–∞–≤–∏–ª–æ:

> ‚Äú—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–æ–∂–µ –±—É—Ç–∏ –ª–∏—à–µ –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ (—Ü—å–æ–≥–æ —Ç–∏–ø—É)‚Äù

—Ç–æ–¥—ñ:

```plsql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

–¶–µ –æ–∑–Ω–∞—á–∞—î:

* **–¥–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö** –º—ñ—Ç–æ–∫ (date_end IS NULL)
  ‚Äì –º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω –∑–∞–ø–∏—Å `(user_id, tag_type_id)`;
* –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ ‚Äì –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–µ –¥—ñ—î.

> –Ø–∫—â–æ —Ç–∏ —Ö–æ—á–µ—à, —â–æ–± —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∑–∞–≥–∞–ª—ñ –±—É–ª–∞ **–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É**,
> —Ç–æ–¥—ñ –∑–∞–±–∏—Ä–∞—î–º–æ `tag_type_id` –∑ —ñ–Ω–¥–µ–∫—Å—É:

```plsql
CREATE UNIQUE INDEX ux_user_tag_active_user_any_type
  ON user_tag (
    user_id,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

---

## 5. –õ–æ–≥—ñ–∫–∞ –≤ —Å—É–∫—É–ø–Ω–æ—Å—Ç—ñ

1. –ê–¥–º—ñ–Ω –≤–≤–æ–¥–∏—Ç—å/–≤—Å—Ç–∞–≤–ª—è—î –∫–æ–¥ ‚Üí
   –≤–∞–ª—ñ–¥–∞—Ü—ñ—è:

   * –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è (HEX/Android ‚Üí DEC);
   * –∑–∞–ø–∏—Å –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ `P210_TAG_CODE`.

2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ **–≥–ª–æ–±–∞–ª—å–Ω–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –∞–∫—Ç–∏–≤–Ω–æ—ó –º—ñ—Ç–∫–∏**:

   * —è–∫—â–æ —Ç–∞–∫–∞ –º—ñ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –≤ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Üí APEX warning/error:

     > ‚Äú–¢–∞–∫–∞ –º—ñ—Ç–∫–∞ –≤–∂–µ —î –≤ –±–∞–∑—ñ‚Ä¶ –°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—è —ñ–Ω—à–æ—é –º—ñ—Ç–∫–æ—é.‚Äù

3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ **—É —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–º–∞—î —ñ–Ω—à–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—ó**:

   * —è–∫—â–æ —î ‚Üí

     > ‚Äú–£ –¥–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞‚Ä¶ –¥–µ–∞–∫—Ç–∏–≤—É–π—Ç–µ –ø–æ–ø–µ—Ä–µ–¥–Ω—é.‚Äù

4. –Ø–∫—â–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –ø—Ä–æ–π–¥–µ–Ω—ñ ‚Üí `INSERT` —É `USER_TAG`.

5. –£ –ë–î –¥–≤–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏:

   * –Ω–µ –¥–æ–∑–≤–æ–ª—è—Ç—å:

     * –æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π tag_code –±—É—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–º —É –¥–≤–æ—Ö —Ä—ñ–∑–Ω–∏—Ö –∑–∞–ø–∏—Å–∞—Ö;
     * –æ–¥–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –º–∞—Ç–∏ –¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏ (–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —è–∫–∏–π —ñ–Ω–¥–µ–∫—Å –æ–±–µ—Ä–µ—à).

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –¥–∞–ª—ñ –º–æ–∂—É:

* –∑–≤–µ—Å—Ç–∏ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (–≥–ª–æ–±–∞–ª—å–Ω—É + –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É) –≤ **–æ–¥–Ω—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—é**,
* –∞–±–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É–∂–µ –≥–æ—Ç–æ–≤–∏–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ —É–ø–æ–¥—ñ–±–Ω–µ–Ω–∏–º–∏ –¥–æ —Å—Ç–∏–ª—é —Ç–≤–æ–≥–æ APEX-–¥–æ–¥–∞—Ç–∫—É.
