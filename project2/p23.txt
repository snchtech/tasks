–û–∫–µ–π, —Ü–µ —è–∫—Ä–∞–∑ —Ç–∞ —Å–∏—Ç—É–∞—Ü—ñ—è, –¥–µ **–≤–∏ –≤—Å–µ –∑—Ä–æ–±–∏–ª–∏ ‚Äú–º–∞–π–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù, –∞–ª–µ –¥–µ—Å—å —É –¥—Ä—ñ–±–Ω–∏—Ü—ñ –∑–∞–∫—Ä–∞–ª–∞—Å—å –ø–∞—Å—Ç–∫–∞** üôÇ

–ó–∞ –∑–∞–¥—É–º–æ–º:

> `CREATE UNIQUE INDEX ux_user_tag_active_user ON user_tag ( user_id, tag_type_id, CASE WHEN date_end IS NULL THEN 1 END );`

–º–∞—î –¥–æ–∑–≤–æ–ª—è—Ç–∏:

* **–Ω–µ –±—ñ–ª—å—à–µ –æ–¥–Ω—ñ—î—ó –∞–∫—Ç–∏–≤–Ω–æ—ó –º—ñ—Ç–∫–∏** (`date_end IS NULL`) –¥–ª—è `(user_id, tag_type_id)`;
* **—Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö** (`date_end IS NOT NULL`), –±–æ –≤ —ñ–Ω–¥–µ–∫—Å—ñ –¥–ª—è –Ω–∏—Ö –≤–∏—Ä–∞–∑ –¥–∞—î `NULL`, –∞ Oracle –¥–æ–∑–≤–æ–ª—è—î –±–∞–≥–∞—Ç–æ `NULL` —É unique-—ñ–Ω–¥–µ–∫—Å—ñ.

–¢–æ–±—Ç–æ –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —â–µ –æ–¥–Ω—ñ—î—ó –º—ñ—Ç–∫–∏ (‚Äú—Å—Ç–∞–Ω–µ –¥–≤—ñ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ‚Äù) —É **–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ–º—É** —Ç–∞–∫–æ–º—É —ñ–Ω–¥–µ–∫—Å—ñ **–Ω–µ –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ ORA-00001**.

–¢–æ–π —Ñ–∞–∫—Ç, —â–æ –≤–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ:

> ORA-00001: unique constraint (‚Ä¶UX_USER_TAG_ACTIVE_USER‚Ä¶) violated

–æ–∑–Ω–∞—á–∞—î, —â–æ **–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ —ñ–Ω–¥–µ–∫—Å —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –Ω–µ —Ç–∞–∫**, —è–∫ —É –ø—Ä–∏–∫–ª–∞–¥—ñ. –ù–∞–π—á–∞—Å—Ç—ñ—à—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏:

* –≤ CASE —î `ELSE 0` –∞–±–æ `ELSE date_end`:

  ```sql
  CASE WHEN date_end IS NULL THEN 1 ELSE 0 END
  ```

  —Ç–æ–¥—ñ –≤—Å—ñ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ –º–∞—é—Ç—å 0 ‚Üí –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –º—ñ–∂ —Å–æ–±–æ—é;
* –∞–±–æ —ñ–Ω–¥–µ–∫—Å –≤–∑–∞–≥–∞–ª—ñ –±–µ–∑ CASE, —â–æ—Å—å —Ç–∏–ø—É:

  ```sql
  CREATE UNIQUE INDEX ux_user_tag_active_user
    ON user_tag(user_id, tag_type_id);
  ```

  –∞–±–æ `ON(user_id, tag_type_id, date_end)`.

–¢–æ–¥—ñ –ø—Ä–∏ –ø–æ—è–≤—ñ –¥—Ä—É–≥–æ—ó –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—ó –º—ñ—Ç–∫–∏ –¥–ª—è —Ç–æ–≥–æ –∂ `(user_id, tag_type_id)` –ë–î —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ –∫–∞–∂–µ: **—É –≤–∞—Å —É–∂–µ —î —Ç–∞–∫–∏–π –∫–ª—é—á**.

---

## 1. –ü–µ—Ä–µ–≤—ñ—Ä, —è–∫–∏–π —ñ–Ω–¥–µ–∫—Å –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π

–Ø–∫—â–æ –º–∞—î—à –¥–æ—Å—Ç—É–ø –¥–æ SQL*Plus / SQL Developer:

```sql
SELECT index_name, index_type, uniqueness
FROM   user_indexes
WHERE  index_name = 'UX_USER_TAG_ACTIVE_USER';
```

–©–æ–± –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è —Å–∞–º–µ –≤–∏—Ä–∞–∑:

```sql
SELECT column_position, column_expression
FROM   user_ind_expressions
WHERE  index_name = 'UX_USER_TAG_ACTIVE_USER'
ORDER  BY column_position;
```

–Ø–∫—â–æ —Ç–∞–º –ø–æ–±–∞—á–∏—à —â–æ—Å—å —Ç–∏–ø—É:

* `CASE WHEN DATE_END IS NULL THEN 1 ELSE 0 END`
* –∞–±–æ –≤–∑–∞–≥–∞–ª—ñ –Ω–µ–º–∞—î –≤–∏—Ä–∞–∑—É (–ª–∏—à–µ –∑–≤–∏—á–∞–π–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏),

—Ç–æ –º–∏ –∑–Ω–∞–π—à–ª–∏ –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–æ–±–ª–µ–º–∏.

---

## 2. –Ø–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏

### –ö—Ä–æ–∫ 1: –¥—Ä–æ–ø–Ω—É—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å

```sql
DROP INDEX ux_user_tag_active_user;
```

(–ø–µ—Ä–µ–≤—ñ—Ä, —â–æ –≤—ñ–Ω **–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —è–∫ CONSTRAINT**; —è–∫—â–æ —Ç–∞–∫ ‚Äì —Ç–æ–¥—ñ `ALTER TABLE ... DROP CONSTRAINT ...`)

### –ö—Ä–æ–∫ 2: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å

–©–æ–± –ø—Ä–∞—Ü—é–≤–∞–ª–æ —è–∫ –∑–∞–¥—É–º–∞–Ω–æ: *–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞, –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö*:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

–∞–±–æ, –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–æ:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 ELSE NULL END
  );
```

üîπ –õ–æ–≥—ñ–∫–∞:

* –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å ‚Üí `(user_id, tag_type_id, 1)` ‚Üí –º–æ–∂–µ –±—É—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω;
* –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π ‚Üí `(user_id, tag_type_id, NULL)` ‚Üí Oracle –¥–æ–∑–≤–æ–ª—è—î –±–∞–≥–∞—Ç–æ NULL ‚Üí –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –Ω–µ–º–∞—î.

---

## 3. –ß–æ–º—É –∑–∞—Ä–∞–∑ –≤–æ–Ω–æ ‚Äú–ø–∞–¥–∞—î‚Äù –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó

–°–∫–æ—Ä—ñ—à–µ –∑–∞ –≤—Å–µ, —Ä–µ–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 ELSE 0 END
  );
```

–î–ª—è —Ç–≤–æ–≥–æ –∫–µ–π—Å—É:

* –±—É–ª–∞ 1 –∞–∫—Ç–∏–≤–Ω–∞ (1) + 1 –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (0);
* —Ç–∏ –¥–µ–∞–∫—Ç–∏–≤—É—î—à —â–µ –æ–¥–Ω—É –∞–∫—Ç–∏–≤–Ω—É:

  * –ø–µ—Ä—à–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –≤–∂–µ –º–∞—î `(user_id, tag_type_id, 0)`,
  * –¥—Ä—É–≥–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ç–µ–∂ —Å—Ç–∞–Ω–µ `(user_id, tag_type_id, 0)`;
* —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –∫–∞–∂–µ: ‚Äú–¥–≤—ñ –æ–¥–Ω–∞–∫–æ–≤—ñ —Ç—Ä—ñ–π–∫–∏ –∑–Ω–∞—á–µ–Ω—å? –Ω—ñ-–Ω—ñ-–Ω—ñ‚Äù ‚Üí ORA-00001.

–ó **NULL –≤ ELSE** —Ç–∞–∫–æ–≥–æ –Ω–µ –±—É–¥–µ.

---

## 4. –ù–∞ –≤—Å—è–∫–∏–π –≤–∏–ø–∞–¥–æ–∫: –ø–µ—Ä–µ–≤—ñ—Ä —ñ –¥—Ä—É–≥–∏–π —ñ–Ω–¥–µ–∫—Å

–ú–∏ —Ä–∞–Ω—ñ—à–µ —â–µ –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–ª–∏ —ñ–Ω–¥–µ–∫—Å –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –∫–æ–¥—É:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_code
  ON user_tag (
    tag_type_id,
    tag_code,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

–¢–µ–∂ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∞–º –Ω–µ–º–∞—î `ELSE 0`, —ñ–Ω–∞–∫—à–µ –∑ ‚Äú—ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–º–∏‚Äù –∑–∞–ø–∏—Å–∞–º–∏ –±—É–¥—É—Ç—å —Ç–∞–∫—ñ –∂ –≥–ª—é–∫–∏.

---

### –ü—ñ–¥—Å—É–º–æ–∫

* –°–∞–º–∞ —ñ–¥–µ—è –∑ **functional unique index + CASE WHEN date_end IS NULL THEN 1** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞.
* ORA-00001 –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –æ–∑–Ω–∞—á–∞—î, —â–æ:

  * –∞–±–æ —É –≤–∏—Ä–∞–∑—ñ —î `ELSE 0` / `NVL(...,0)`;
  * –∞–±–æ —ñ–Ω–¥–µ–∫—Å –∑—Ä–æ–±–ª–µ–Ω–æ –Ω–∞ `(user_id, tag_type_id)` –±–µ–∑ CASE.
* –í–∏—Ä—ñ—à–µ–Ω–Ω—è:

  * –¥—Ä–æ–ø–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω–¥–µ–∫—Å;
  * —Å—Ç–≤–æ—Ä–∏—Ç–∏ –π–æ–≥–æ —Ç–∞–∫, —â–æ–± –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –≤–∏—Ä–∞–∑ –ø–æ–≤–µ—Ä—Ç–∞–≤ **NULL**, –∞ –Ω–µ 0.

–Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ —Å—é–¥–∏ —Ç–æ—á–Ω–∏–π DDL —ñ–Ω–¥–µ–∫—Å—É (—è–∫ —Ç–∏ –π–æ–≥–æ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–≤–æ—Ä–∏–≤), —è –ø—Ä—è–º–æ –ø–æ –Ω—å–æ–º—É –ø–æ–∫–∞–∂—É, —â–æ –≤ –Ω—å–æ–º—É –Ω–µ —Ç–∞–∫ —ñ —è–∫–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –±—É–¥–µ 100% –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –¥–ª—è —Ç–≤–æ—î—ó –ª–æ–≥—ñ–∫–∏ ‚Äú1 –∞–∫—Ç–∏–≤–Ω–∞, –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö‚Äù.
