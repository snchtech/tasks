–°—É–ø–µ—Ä, —â–æ —Ö–æ—á–µ—à —Ü–µ —Ä–æ–±–∏—Ç–∏ **–Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î** ‚Äì —Ç–æ–¥—ñ –∂–æ–¥–µ–Ω APEX-—Ä–æ–∑—Ä–æ–±–Ω–∏–∫ –Ω—ñ—á–æ–≥–æ –Ω–µ ‚Äú–∑–∞–±—É–¥–µ‚Äù üòé

–Ø –∑–∞–ø—Ä–æ–ø–æ–Ω—É—é **–º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç** + –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π **audit-–ª–æ–≥**.

---

## 1Ô∏è‚É£ –î–æ–¥–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏ –≤ `USER_TAG`

–¢–∏ –≤–∂–µ –º–∞—î—à:

```sql
USER_TAG (
  ID          NUMBER,
  USER_ID     NUMBER,
  TAG_TYPE_ID NUMBER,
  TAG_CODE    VARCHAR2(64),
  CREATED_AT  TIMESTAMP WITH TIME ZONE,
  DATE_END    DATE
)
```

–î–æ–¥–∞–º–æ, —Ö—Ç–æ —Å—Ç–≤–æ—Ä–∏–≤ —ñ —Ö—Ç–æ –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞–≤:

```sql
ALTER TABLE user_tag ADD (
  created_by      VARCHAR2(100),
  deactivated_by  VARCHAR2(100)
);
```

> `DATE_END` —É–∂–µ —î ‚Äî —Ü–µ —á–∞—Å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó, –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π –¥–∞–ª—ñ.

---

## 2Ô∏è‚É£ BEFORE INSERT/UPDATE —Ç—Ä–∏–≥–µ—Ä –Ω–∞ `USER_TAG`

–¢—Ä–∏–≥–µ—Ä —Å–∞–º:

* –ø—Ä–∏ **INSERT** –∑–∞–ø–æ–≤–Ω—é—î `CREATED_AT` —ñ `CREATED_BY`;
* –ø—Ä–∏ **UPDATE**, —è–∫—â–æ `DATE_END` –∑–º—ñ–Ω–∏–ª–æ—Å—å –∑ `NULL` ‚Üí NOT NULL, —Å—Ç–∞–≤–∏—Ç—å `DEACTIVATED_BY`.

### –ö–æ–¥ —Ç—Ä–∏–≥–µ—Ä–∞

```plsql
CREATE OR REPLACE TRIGGER trg_user_tag_audit
  BEFORE INSERT OR UPDATE ON user_tag
  FOR EACH ROW
DECLARE
  v_app_user VARCHAR2(100);
BEGIN
  -- –•—Ç–æ –∑–∞—Ä–∞–∑ –ø—Ä–∞—Ü—é—î: APEX APP_USER, –∞–±–æ –∑–≤–∏—á–∞–π–Ω–∏–π DB USER
  v_app_user := NVL(
                  SYS_CONTEXT('APEX$SESSION', 'APP_USER'),
                  SYS_CONTEXT('USERENV', 'SESSION_USER')
                );

  -- üîπ –ê–∫—Ç–∏–≤—É–≤–∞–Ω–Ω—è (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤‚Äô—è–∑–∫—É)
  IF INSERTING THEN
    IF :NEW.created_at IS NULL THEN
      :NEW.created_at := SYSTIMESTAMP;
    END IF;

    IF :NEW.created_by IS NULL THEN
      :NEW.created_by := v_app_user;
    END IF;
  END IF;

  -- üîπ –î–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è (–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è DATE_END)
  IF UPDATING THEN
    -- –ü–µ—Ä–µ—Ö—ñ–¥ –∑ "–∞–∫—Ç–∏–≤–Ω–æ—ó" –º—ñ—Ç–∫–∏ –≤ "–¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω—É"
    IF :OLD.date_end IS NULL 
       AND :NEW.date_end IS NOT NULL THEN
      :NEW.deactivated_by := v_app_user;
      -- –Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–Ω–∞ –π —Ç—É—Ç —Å—Ç–∞–≤–∏—Ç–∏ —á–∞—Å, –∞–ª–µ –≤ —Ç–µ–±–µ –≤–∂–µ —î DATE_END
      -- :NEW.date_end := NVL(:NEW.date_end, SYSDATE);
    END IF;
  END IF;
END;
/
```

–¢–µ–ø–µ—Ä:

* –•—Ç–æ –± –Ω–µ –≤—Å—Ç–∞–≤–ª—è–≤ –∑–∞–ø–∏—Å (APEX, PL/SQL, —ñ–Ω—à–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å) ‚Üí
  `CREATED_BY` –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π.
* –•—Ç–æ –± –Ω–µ –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞–≤ –º—ñ—Ç–∫—É (`UPDATE user_tag SET date_end = ...`) ‚Üí
  `DEACTIVATED_BY` –∑–∞—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.

---

## 3Ô∏è‚É£ –û–ø—Ü—ñ–π–Ω–æ: –æ–∫—Ä–µ–º–∞ —Ç–∞–±–ª–∏—Ü—è AUDIT-–ª–æ–≥—É

–Ø–∫—â–æ —Ö–æ—á–µ—à **—ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—ñ—Ö –∑–º—ñ–Ω**, –∞ –Ω–µ —Ç—ñ–ª—å–∫–∏ –ø–æ–ª—è ‚Äú—Ö—Ç–æ —Å—Ç–≤–æ—Ä–∏–≤/–¥–µ–∞–∫—Ç–∏–≤—É–≤–∞–≤‚Äù, –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:

```sql
CREATE TABLE user_tag_audit (
  audit_id       NUMBER GENERATED BY DEFAULT AS IDENTITY
                   CONSTRAINT pk_user_tag_audit PRIMARY KEY,
  tag_id         NUMBER        NOT NULL,
  action_type    VARCHAR2(20)  NOT NULL, -- 'CREATE' / 'DEACTIVATE'
  action_date    TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  action_user    VARCHAR2(100),
  old_date_end   DATE,
  new_date_end   DATE
);
```

–Ü —Ç—Ä–æ—Ö–∏ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ —Ç—Ä–∏–≥–µ—Ä:

```plsql
CREATE OR REPLACE TRIGGER trg_user_tag_audit
  BEFORE INSERT OR UPDATE ON user_tag
  FOR EACH ROW
DECLARE
  v_app_user VARCHAR2(100);
BEGIN
  v_app_user := NVL(
                  SYS_CONTEXT('APEX$SESSION', 'APP_USER'),
                  SYS_CONTEXT('USERENV', 'SESSION_USER')
                );

  IF INSERTING THEN
    IF :NEW.created_at IS NULL THEN
      :NEW.created_at := SYSTIMESTAMP;
    END IF;

    IF :NEW.created_by IS NULL THEN
      :NEW.created_by := v_app_user;
    END IF;

    INSERT INTO user_tag_audit (tag_id, action_type, action_user, old_date_end, new_date_end)
    VALUES (:NEW.id, 'CREATE', v_app_user, NULL, NULL);
  END IF;

  IF UPDATING THEN
    IF :OLD.date_end IS NULL AND :NEW.date_end IS NOT NULL THEN
      :NEW.deactivated_by := v_app_user;

      INSERT INTO user_tag_audit (tag_id, action_type, action_user, old_date_end, new_date_end)
      VALUES (:OLD.id, 'DEACTIVATE', v_app_user, :OLD.date_end, :NEW.date_end);
    END IF;
  END IF;
END;
/
```

---

## 4Ô∏è‚É£ –Ø–∫ —Ü–µ —Å—Ç–∏–∫—É—î—Ç—å—Å—è –∑ APEX-–¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—î—é

–¢–æ–π –∫–æ–¥, —â–æ –º–∏ –≤–∂–µ —Ä–æ–±–∏–ª–∏ –≤ APEX:

```plsql
UPDATE user_tag
   SET date_end = SYSTIMESTAMP
 WHERE id = :PXX_TAG_ID;
```

–º–æ–∂–Ω–∞ –ª–∏—à–∏—Ç–∏ **–±–µ–∑ –∑–º—ñ–Ω** ‚Äî —Ç—Ä–∏–≥–µ—Ä:

* —Å–∞–º –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å `DEACTIVATED_BY` = `APP_USER`,
* –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ –∑–∞–ø–∏—à–µ –∑–∞–ø–∏—Å –≤ `USER_TAG_AUDIT`.

---

–Ø–∫—â–æ —Ö–æ—á–µ—à, –¥–∞–ª—ñ –º–æ–∂–µ–º–æ:

* –∑—Ä–æ–±–∏—Ç–∏ –æ–∫—Ä–µ–º–∏–π **–∑–≤—ñ—Ç ‚Äú–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –º—ñ—Ç–æ–∫‚Äù** –ø–æ `USER_TAG_AUDIT`,
* –∞–±–æ –¥–æ–¥–∞—Ç–∏ –≤ –∫–∞—Ä—Ç–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±–ª–æ–∫ ‚Äú–Ø–∫—ñ –º—ñ—Ç–∫–∏ –≤—ñ–Ω –∫–æ–ª–∏ –∞–∫—Ç–∏–≤—É–≤–∞–≤/–¥–µ–∞–∫—Ç–∏–≤—É–≤–∞–≤ —ñ –∫–∏–º‚Äù.
