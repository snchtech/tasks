–¢—É—Ç —è–∫—Ä–∞–∑ –ø–ª—É—Ç–∞–Ω–∏–Ω–∞ –Ω–µ –≤ Oracle, –∞ –≤ —ñ–Ω—Ç—É—ó—Ü—ñ—ó üôÇ
–î—É–∂–µ –≤–∞–∂–ª–∏–≤–∏–π –º–æ–º–µ–Ω—Ç:

> **–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –≤ Oracle –¥–æ–ø—É—Å–∫–∞—î –±–∞–≥–∞—Ç–æ —Ä—è–¥–∫—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏, —è–∫—â–æ —Ö–æ—á–∞ –± –û–î–ù–ê –∫–æ–ª–æ–Ω–∫–∞ –≤ –∫–ª—é—á—ñ = NULL.**

–¢–æ–±—Ç–æ —Ç–≤—ñ–π —ñ–Ω–¥–µ–∫—Å:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

–ø—Ä–∞—Ü—é—î —Ç–∞–∫:

* **–ê–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å** (`date_end IS NULL`) ‚Üí –∫–ª—é—á –≤ —ñ–Ω–¥–µ–∫—Å—ñ:
  `(user_id, tag_type_id, 1)`
* **–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å** (`date_end IS NOT NULL`) ‚Üí –≤–∏—Ä–∞–∑ `CASE WHEN ... THEN 1 END`
  –ø–æ–≤–µ—Ä—Ç–∞—î `NULL`, —Ç–æ–±—Ç–æ –∫–ª—é—á:
  `(user_id, tag_type_id, NULL)`

### ‚¨á –©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î

* Oracle **—Å—Ç—Ä–æ–≥–æ –∑–∞–±–æ—Ä–æ–Ω—è—î** –¥–≤—ñ –æ–¥–Ω–∞–∫–æ–≤—ñ —Ç—Ä—ñ–π–∫–∏, –¥–µ –í–°–Ü –∑–Ω–∞—á–µ–Ω–Ω—è *–Ω–µ NULL*.

  * –¢–æ–±—Ç–æ **–Ω–µ –¥–æ–∑–≤–æ–ª—è—î** –¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏ –¥–ª—è `(user_id, tag_type_id)`
    ‚Üí —Ü–µ —è–∫—Ä–∞–∑ —Ç–µ, —â–æ –º–∏ —Ö–æ—Ç—ñ–ª–∏.
* –ê–ª–µ —è–∫—â–æ –≤ –∫–ª—é—á—ñ —î NULL (—É –Ω–∞—Å —Ü–µ —Ç—Ä–µ—Ç—ñ–π —Å—Ç–æ–≤–ø—á–∏–∫),
  Oracle **–ù–ï –∫–æ–Ω—Ç—Ä–æ–ª—é—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å** —Ç–∞–∫–∏—Ö —Ä—è–¥–∫—ñ–≤:

  * `(user_id, tag_type_id, NULL)` –º–æ–∂–µ –±—É—Ç–∏ **—Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ —Ä–∞–∑—ñ–≤**,
    –Ω–∞–≤—ñ—Ç—å –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ `user_id` —ñ `tag_type_id`.

üîπ –¢–æ–º—É —Ç–≤—ñ–π —ñ–Ω–¥–µ–∫—Å **–ù–ï –º–æ–∂–µ** –∑–∞–±–æ—Ä–æ–Ω—è—Ç–∏:

> ‚Äú–¥–≤–∞ –∑–∞–ø–∏—Å–∏ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ user_id, tag_type_id —ñ date_end IS NOT NULL‚Äù

–ë–æ –∫–æ–ª–∏ `date_end IS NOT NULL`, –≤–∏—Ä–∞–∑ ‚Üí `NULL` ‚Üí
**—É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è**.

---

## –ß–æ–º—É —Ç–æ–¥—ñ APEX –ø–æ–∫–∞–∑—É—î ORA-00001 —Å–∞–º–µ –Ω–∞ —Ü–µ–π —ñ–Ω–¥–µ–∫—Å?

–¶–µ –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ –æ–∑–Ω–∞—á–∞—î –æ–¥–Ω–µ –∑ –¥–≤–æ—Ö:

1. **–¢–∏ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –Ω–µ –¥–µ–∞–∫—Ç–∏–≤—É—î—à**, –∞ –¥–µ—Å—å —É –∫–æ–¥—ñ –Ω–∞–≤–ø–∞–∫–∏ —Å—Ç–∞–≤–∏—à `date_end = NULL`
   (–∞–±–æ —Ç—Ä–∏–≥–µ—Ä —Ü–µ —Ä–æ–±–∏—Ç—å) ‚Üí –¥—Ä—É–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ ‚Üí –∫–æ–Ω—Ñ–ª—ñ–∫—Ç.
   –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ:

   ```plsql
   UPDATE user_tag
      SET date_end = NULL
    WHERE id = :P_TAG_ID;
   ```

   –ø—Ä–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —ñ–Ω—à–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –¥–ª—è —Ç–æ–≥–æ –∂ `(user_id, tag_type_id)` ‚Äì —Ü–µ **–ª–µ–≥–∞–ª—å–Ω–æ –ª–æ–≤–∏—Ç—å ORA-00001**, —ñ –≤ APEX —Ç–∏ —Å–ø—Ä–∞–≤–¥—ñ –ø–æ–±–∞—á–∏—à —ñ–º‚Äô—è —Ü—å–æ–≥–æ —ñ–Ω–¥–µ–∫—Å–∞.

2. –ê–±–æ —É —Ç–µ–±–µ **–Ω–µ —Ç–æ–π UPDATE**, —è–∫–∏–π —Ç–∏ –¥—É–º–∞—î—à:

   * –¥–µ—Å—å –∑–º—ñ–Ω—é—î—Ç—å—Å—è `user_id` / `tag_type_id`;
   * –¥–µ—Å—å —î BEFORE UPDATE-—Ç—Ä–∏–≥–µ—Ä, —è–∫–∏–π ‚Äú—á–∏—Å—Ç–∏—Ç—å‚Äù `date_end`;
   * –∞–±–æ –≤ –∫–æ–¥—ñ –ø–µ—Ä–µ–¥ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—î—é –º—ñ—Ç–∫–∞ —Å–ø–æ—á–∞—Ç–∫—É ‚Äú–∑–Ω–æ–≤—É —Å—Ç–∞—î –∞–∫—Ç–∏–≤–Ω–æ—é‚Äù, —ñ –ª–∏—à–µ –ø–æ—Ç—ñ–º –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è.

–î–ª—è **–¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó**, —è–∫—â–æ –∫–æ–¥ —Ç–∞–∫–∏–π:

```plsql
UPDATE user_tag
   SET date_end = SYSTIMESTAMP
 WHERE id = :P_TAG_ID;
```

—ñ –±—ñ–ª—å—à–µ –Ω—ñ–¥–µ `user_id`, `tag_type_id` —ñ `date_end` –Ω–µ —á—ñ–ø–∞—é—Ç—å—Å—è ‚Äî
—Ü–µ–π UPDATE **–Ω–µ –º–æ–∂–µ** –ø–æ—Ä—É—à–∏—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –∑ `CASE WHEN date_end IS NULL THEN 1 END`.

---

## –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–µ–±–µ

### 1. –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –∞–∫—Ç–∏–≤–Ω–∏—Ö –Ω–µ–º–∞—î

–ó–∞–ø—É—Å—Ç–∏:

```sql
SELECT user_id, tag_type_id, COUNT(*)
FROM user_tag
WHERE date_end IS NULL
GROUP BY user_id, tag_type_id
HAVING COUNT(*) > 1;
```

–Ø–∫—â–æ —Ç—É—Ç —â–æ—Å—å —î ‚Äì –∑–Ω–∞—á–∏—Ç—å:

* –∞–±–æ —ñ–Ω–¥–µ–∫—Å –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π **–ø—ñ—Å–ª—è** —Ç–æ–≥–æ, —è–∫ –∑‚Äô—è–≤–∏–ª–∏—Å—è –¥—É–±–ª—ñ–∫–∞—Ç–∏;
* –∞–±–æ –≤—ñ–Ω –∫–æ–ª–∏—Å—å –±—É–≤ **disabled/invalid**;
* –∞–±–æ —î —ñ–Ω—à–∞ ‚Äú–¥—ñ—Ä–∫–∞‚Äù.

–£ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ–π —Å–∏—Ç—É–∞—Ü—ñ—ó —Ü–µ–π –∑–∞–ø–∏—Ç –º–∞—î –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏.

### 2. –ü–æ–¥–∏–≤–∏—Ç–∏—Å—è, —â–æ —Å–∞–º–µ —Ç–∏ —Ä–æ–±–∏—à –ø—Ä–∏ ‚Äú–¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó‚Äù

–ü–µ—Ä–µ–≤—ñ—Ä —É APEX:

* —É **Dynamic Action / Process**, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î ‚ÄúExecute Server-side Code‚Äù:

  * –Ø–∫–∏–π —Å–∞–º–µ `UPDATE` —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–∏–π?
  * –ß–∏ –Ω–µ —á—ñ–ø–∞—î –≤—ñ–Ω –≤–∏–ø–∞–¥–∫–æ–≤–æ `user_id`, `tag_type_id` –∞–±–æ `date_end = NULL`?

---

## –Ø–∫—â–æ —Ç–∏ –•–û–ß–ï–® –±–ª–æ–∫—É–≤–∞—Ç–∏ –Ω–∞–≤—ñ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ –¥—É–±–ª—ñ–∫–∞—Ç–∏

–¢–µ, —â–æ —Ç–∏ –≤—ñ–¥—á—É–≤–∞—î—à:

> ‚Äú—Ç–∞–∫–∏–π –∑–∞–ø–∏—Å –Ω–µ –¥–∞—î —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥–≤–∞ —ñ–Ω–¥–µ–∫—Å–∞ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ tag_code —Ç–∞ user_id —ñ date_end is not null‚Äù

‚Äî —Ü–µ –±—É–ª–æ –± **–ø—Ä–∞–≤–¥–æ—é –≤ PostgreSQL / SQL Server**, –∞–ª–µ –Ω–µ –≤ Oracle.

–Ø–∫—â–æ —Ç–∏ **—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ** —Ö–æ—á–µ—à, —â–æ–±:

> –Ω–∞–≤—ñ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ `(user_id, tag_type_id)` –Ω–µ –º–æ–≥–ª–∏ –¥—É–±–ª—é–≤–∞—Ç–∏—Å—è,

—Ç–æ–¥—ñ –∑–∞–º—ñ—Å—Ç—å `CASE WHEN ... THEN 1 END` —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫, —â–æ–± —Ç—Ä–µ—Ç—è –∫–æ–ª–æ–Ω–∫–∞ —Ç–µ–∂ **–Ω–µ –±—É–ª–∞ NULL**:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    user_id,
    tag_type_id,
    CASE WHEN date_end IS NULL THEN 1 ELSE 0 END
  );
```

‚ùó –ê–ª–µ –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É:

* –±—É–¥–µ **–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ**:

  * –¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ (–±–æ 1),
  * —ñ **–¥–≤—ñ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ** (–±–æ 0) ‚Üí –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —Ç–≤–æ—î ‚Äú–≤—ñ–¥—á—É—Ç—Ç—è‚Äù.

–ê —Ç–∏ —è–∫—Ä–∞–∑ —Ö–æ—Ç—ñ–ª–∞: *1 –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö* ‚Üí —Ç–æ–¥—ñ **ELSE –Ω–µ –º–æ–∂–Ω–∞ —Å—Ç–∞–≤–∏—Ç–∏**.

---

## –©–æ –± —è –∑—Ä–æ–±–∏–≤ –∑–∞—Ä–∞–∑ –Ω–∞ —Ç–≤–æ—î–º—É –º—ñ—Å—Ü—ñ

1. –ó–∞–ª–∏—à–∏–≤ —ñ–Ω–¥–µ–∫—Å **—É —Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ, —è–∫ —Ç–∏ –ø–æ–∫–∞–∑–∞–ª–∞**
   (`CASE WHEN DATE_END IS NULL THEN 1 END`) ‚Äì –≤—ñ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –¥–ª—è –ª–æ–≥—ñ–∫–∏ ‚Äú–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞, –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö‚Äù.
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤:

   * —á–∏ –Ω–µ —Ä–æ–±–∏—à –¥–µ—Å—å `date_end := NULL` –ø—Ä–∏ ‚Äú–¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó‚Äù;
   * —á–∏ –Ω–µ–º–∞—î –¥–≤–æ—Ö –∞–∫—Ç–∏–≤–Ω–∏—Ö –¥–ª—è –æ–¥–Ω–æ–≥–æ `(user_id, tag_type_id)`.
3. –Ø–∫—â–æ ORA-00001 –≤—Å–µ —â–µ –ª–æ–≤–∏—à:

   * –ø–æ–∫–∞–∂–∏ **—Ç–æ—á–Ω–∏–π UPDATE** –∑ APEX (Execute Server-side Code),
   * –º–∏ –ø–æ —Ä—è–¥–æ—á–∫—É —Ä–æ–∑–±–µ—Ä–µ–º–æ, —è–∫ –≤—ñ–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ —ñ–Ω–¥–µ–∫—Å—É.

–ú–æ–∂–µ–º–æ –Ω–∞–≤—ñ—Ç—å –∑–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ —Ü–µ –ª–æ–≥—ñ—á–Ω–æ ‚Äú–Ω–∞ –ø–∞–ø–µ—Ä—ñ‚Äù:
—è–∫—ñ —Ä—è–¥–∫–∏ –≤ —Ç–µ–±–µ —î –¥–æ, —è–∫–µ –∑–Ω–∞—á–µ–Ω–Ω—è `CASE` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ, —ñ —â–æ —Å—Ç–∞—î—Ç—å—Å—è –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ.
