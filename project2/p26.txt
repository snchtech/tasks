–°—É–ø–µ—Ä ‚Äî —Ç–µ–ø–µ—Ä –º–∏ –º–∞—î–º–æ **—Ç–æ—á–Ω–µ –¥–∂–µ—Ä–µ–ª–æ –ø–æ–º–∏–ª–∫–∏**:

> **UX_USER_TAG_ACTIVE_CODE**
> ORA-00001: unique constraint violated

–û—Ç–∂–µ, **–Ω–µ —Ç–æ–π —ñ–Ω–¥–µ–∫—Å**, –ø—Ä–æ —è–∫–∏–π —Ç–∏ –¥—É–º–∞–ª–∞ (`USER_ID, TAG_TYPE_ID, CASE WHEN DATE_END IS NULL THEN 1 END`),
–∞ —ñ–Ω—à–∏–π:

‚ö† **UX_USER_TAG_ACTIVE_CODE**

–°–∞–º–µ –≤—ñ–Ω —ñ –±–ª–æ–∫—É—î –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—é.

---

# ‚úÖ 1. –ß–æ–º—É –≤–∏–Ω–∏–∫–∞—î ORA-00001 —Å–∞–º–µ –Ω–∞ UX_USER_TAG_ACTIVE_CODE

–í—ñ–Ω —É —Ç–µ–±–µ –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∏–±–ª–∏–∑–Ω–æ —Ç–∞–∫:

```sql
CREATE UNIQUE INDEX UX_USER_TAG_ACTIVE_CODE
  ON USER_TAG(
      TAG_TYPE_ID,
      TAG_CODE,
      CASE WHEN DATE_END IS NULL THEN 1 END
  );
```

–õ–æ–≥—ñ–∫–∞ —Ç–∞–∫–∞:

* –∫–æ–ª–∏ –º—ñ—Ç–∫–∞ **–∞–∫—Ç–∏–≤–Ω–∞** ‚Üí `(tag_type_id, tag_code, 1)`
  ‚Üí —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è
* –∫–æ–ª–∏ **–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞** ‚Üí `(tag_type_id, tag_code, NULL)`
  ‚Üí –¥–æ–ø—É—Å—Ç–∏–º–æ –±–∞–≥–∞—Ç–æ –∑–∞–ø–∏—Å—ñ–≤

–¶–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

### –ê–ª–µ ORA-00001 –æ–∑–Ω–∞—á–∞—î:

üëâ —Ç–∏ –Ω–∞–º–∞–≥–∞—î—à—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–¥—Ä—É–≥–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å –∑ —Ç–∏–º —Å–∞–º–∏–º tag_code –¥–ª—è same tag_type_id**

–∞–±–æ

üëâ —É —Ç–≤–æ—î–º—É UPDATE –ø—ñ–¥ —á–∞—Å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó *—Ä–∞–ø—Ç–æ–≤–æ tag_type_id/tag_code —Å—Ç–∞—é—Ç—å —Ç–∞–∫—ñ –∂, —è–∫ —É —ñ–Ω—à–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É*.

### –ê–±–æ (–Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–µ!)

–¢–≤—ñ–π UPDATE –ø—Ä–∞—Ü—é—î —Ç–∞–∫:

1. —Å–ø–æ—á–∞—Ç–∫—É APEX –æ–Ω–æ–≤–ª—é—î –≤—Å—ñ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—ñ (–±–æ Automatic Row Processing –∞–±–æ —Ç–≤—ñ–π –∫–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `UPDATE ... SET TAG_CODE = :P5_TAG_CODE`)
2. —É —Ü–µ–π –º–æ–º–µ–Ω—Ç `:P5_TAG_CODE` = –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫–µ –¥—É–±–ª—é—î –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å
3. –ª–∏—à–µ –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è `DATE_END`
4. —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –ª–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –î–û —Ç–æ–≥–æ, —è–∫ `DATE_END` —Å—Ç–∞—î NOT NULL

**–¢–æ–±—Ç–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –ª–æ–≤–∏—Ç—å –ø–æ–º–∏–ª–∫—É –ù–ï –ø—ñ–¥ —á–∞—Å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó, –∞ –ø—ñ–¥ —á–∞—Å "–æ–Ω–æ–≤–ª–µ–Ω–Ω—è tag_code".**

–¶–µ APEX-–∫–ª–∞—Å–∏–∫–∞ ‚Äî **–ø–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ç—Ä–∏–≥–µ—Ä—ñ–≤ —ñ DA**.

---

# üü¢ 2. –Ø–∫ 100% –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ü—é –ø–æ–º–∏–ª–∫—É

## ‚úî –í–ê–†–Ü–ê–ù–¢ 1 (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π):

### –ü—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó ‚Äî –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –¢–Ü–õ–¨–ö–ò DATE_END, –∞ –Ω–µ –≤—Å—ñ –ø–æ–ª—è

–¢–æ–±—Ç–æ –∑–∞–º—ñ–Ω–∏—Ç–∏:

```plsql
UPDATE USER_TAG
   SET user_id = :P_USER,
       tag_type_id = :P_TAG_TYPE,
       tag_code = :P_TAG_CODE,
       date_end = SYSTIMESTAMP
 WHERE id = :P_ID;
```

–Ω–∞:

```plsql
UPDATE USER_TAG
   SET date_end = SYSTIMESTAMP
 WHERE id = :P_ID;
```

üî¥ –ù–µ —á—ñ–ø–∞–π user_id/tag_type_id/tag_code –ø—ñ–¥ —á–∞—Å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó.

---

## ‚úî –í–ê–†–Ü–ê–ù–¢ 2 (–∫–æ–ª–∏ APEX –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Automatic Row Processing)

–Ø–∫—â–æ —É —Ç–µ–±–µ Form –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ:

* APEX –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—î `UPDATE USER_TAG SET ...` –∑ —É—Å—ñ–º–∞ –∫–æ–ª–æ–Ω–∫–∞–º–∏.
* –¢–æ–º—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—é —Ç—Ä–µ–±–∞ —Ä–æ–±–∏—Ç–∏ –æ–∫—Ä–µ–º–æ:

### üü¶ Create DA ‚Üí Execute Server-Side Code ‚Üí BEFORE Submit

```plsql
UPDATE USER_TAG
   SET date_end = SYSTIMESTAMP
 WHERE id = :P5_ID;
```

### üü• –Ü –≤–∏–º–∫–Ω—É—Ç–∏ Automatic Row Processing (Process: Update Row)

–ê–±–æ –∑–∞–¥–∞—Ç–∏ Condition ‚Üí Never.

---

## ‚úî –í–ê–†–Ü–ê–ù–¢ 3:

### –ó–º—ñ–Ω–∏—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å —Ç–∞–∫, —â–æ–± –≤—ñ–Ω ‚Äú–±–∞—á–∏–≤ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ‚Äù, –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ —á–∞—Å UPDATE

–¶–µ–π —ñ–Ω–¥–µ–∫—Å **—Ç–æ—á–Ω–æ –Ω—ñ–∫–æ–ª–∏ –Ω–µ ‚Äú—Å—Ç—Ä—ñ–ª—è—Ç–∏–º–µ‚Äù –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó**:

```sql
DROP INDEX UX_USER_TAG_ACTIVE_CODE;

CREATE UNIQUE INDEX UX_USER_TAG_ACTIVE_CODE 
ON USER_TAG (
    CASE WHEN DATE_END IS NULL THEN TAG_TYPE_ID END,
    CASE WHEN DATE_END IS NULL THEN TAG_CODE END
);
```

### –ß–æ–º—É —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç –±–µ–∑–ø–µ—á–Ω—ñ—à–∏–π?

–ë–æ –∫–ª—é—á —Å—Ç–∞—î —Ç–∞–∫–∏–º:

* –∞–∫—Ç–∏–≤–Ω—ñ ‚Üí `(tag_type_id, tag_code)`
* –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ ‚Üí `(NULL, NULL)` (—ñ –±–∞–≥–∞—Ç–æ —Ç–∞–∫–∏—Ö –¥–æ–∑–≤–æ–ª–µ–Ω–æ)

–ê –≥–æ–ª–æ–≤–Ω–µ:

üü¢ –ø—Ä–∏ UPDATE Oracle **—Å–ø–æ—á–∞—Ç–∫—É** –≤–∏–∑–Ω–∞—á–∞—î –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á–∞
üü¢ —ñ —è–∫—â–æ `date_end` –≤–∂–µ —Å—Ç–∞—î NOT NULL ‚Üí –∫–ª—é—á = `(NULL, NULL)`
üü¢ —ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É –Ω–µ–º–∞—î

–¢–æ–±—Ç–æ ‚Äú–º—ñ“ë–∞—é—á–∏–π —Å—Ç–∞–Ω‚Äù –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–º–∏–ª–∫–∏.

–¶–µ –Ω–∞–π—Å—Ç—ñ–π–∫—ñ—à–∏–π —ñ–Ω–¥–µ–∫—Å –¥–ª—è APEX.

---

# üü£ –Ø–ö–ò–ô –í–ê–†–Ü–ê–ù–¢ –¢–û–ë–Ü –ü–û–¢–†–Ü–ë–ï–ù?

### –Ø–∫—â–æ —Ç–∏ —Ö–æ—á–µ—à, —â–æ–± –ª–æ–≥—ñ–∫–∞ –±—É–ª–∞ ‚Äú–æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí –±–∞–≥–∞—Ç–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö‚Äù

‚Üí **–í–∞—Ä—ñ–∞–Ω—Ç 3 ‚Äî —ñ–¥–µ–∞–ª—å–Ω–∏–π**
‚Üí –≤—ñ–Ω –Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ APEX, DA, —Ç—Ä–∏–≥–µ—Ä—ñ–≤, –ø–æ—Ä—è–¥–∫—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.

### –Ø–∫—â–æ —Ö–æ—á–µ—à —à–≤–∏–¥–∫–µ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑

‚Üí **–í–∞—Ä—ñ–∞–Ω—Ç 1 ‚Äî –æ–Ω–æ–≤–ª—é–π —Ç—ñ–ª—å–∫–∏ date_end**

### –Ø–∫—â–æ —É —Ç–µ–±–µ Form Region

‚Üí **–í–∞—Ä—ñ–∞–Ω—Ç 2 ‚Äî –≤—ñ–¥–∫–ª—é—á–∏ Automatic Row Processing**

---

# üî• –•–æ—á–µ—à ‚Äî —è –º–æ–∂—É –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è —Ç–≤—ñ–π Update-–∫–æ–¥ –∑ APEX —ñ —Å–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–Ω–∏–π —Ä—è–¥–æ–∫, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î ORA-00001**

–¢–æ–¥—ñ –º–∏ –∑–ª–æ–≤–∏–º–æ –º–æ–º–µ–Ω—Ç, –∫–æ–ª–∏ —ñ–Ω–¥–µ–∫—Å –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î, —ñ –ø—ñ–¥–±–µ—Ä–µ–º–æ –Ω–∞–π–∫—Ä–∞—â–µ —Ä—ñ—à–µ–Ω–Ω—è.
