–û–∫, —Ç–µ–ø–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∞ üòä
–¢–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–ª–∞, —â–æ:

* —Ç–∞–±–ª–∏—Ü—è —É —Ç–µ–±–µ –∑–∞—Ä–∞–∑ `USER_TAG` = `USER_NFC`,
* —ñ–Ω–¥–µ–∫—Å –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫ (–ø–æ —Å—É—Ç—ñ):

```sql
CREATE UNIQUE INDEX ux_user_tag_active_code
  ON user_tag (
    tab_no,         -- user_id
    nfc_id,         -- tag_code
    CASE WHEN date_end IS NULL THEN 1 END
  );
```

—ñ –ø—Ä–∏ `UPDATE user_tag SET date_end = SYSTIMESTAMP, deactivation_by = :P5_UID WHERE id = :P5_ID`
–≤—Å–µ –æ–¥–Ω–æ —Å–∏–ø–µ:

> ORA-00001: unique constraint UX_USER_TAG_ACTIVE_CODE violated

---

## 1. –©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ

–£–Ω–∏–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å `UX_USER_TAG_ACTIVE_CODE` –∑–∞—Ä–∞–∑ –≥–∞—Ä–∞–Ω—Ç—É—î:

* –¥–ª—è –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó `(TAB_NO, NFC_ID)` **–º–æ–∂–µ –±—É—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞** (`DATE_END IS NULL`);
* –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö (`DATE_END IS NOT NULL`) —Ç—Ä–µ—Ç—è –∫–æ–ª–æ–Ω–∫–∞ = `NULL`, —Ç–æ–º—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ –±–∞–≥–∞—Ç–æ.

–ü–æ–º–∏–ª–∫–∞ ORA-00001 –æ–∑–Ω–∞—á–∞—î, —â–æ –≤ –º–æ–º–µ–Ω—Ç `UPDATE` Oracle –±–∞—á–∏—Ç—å, –Ω—ñ–±–∏ —Ç–∏ —Å—Ç–≤–æ—Ä—é—î—à **–¥—Ä—É–≥–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å –∑ —Ç—ñ—î—é –∂ –ø–∞—Ä–æ—é `(TAB_NO, NFC_ID)`** –∞–±–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á–∞ —è–∫–æ—Å—å –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î –∑ —É–∂–µ —ñ—Å–Ω—É—é—á–∏–º.

–©–æ –º–æ–∂–µ –±—É—Ç–∏:

* –¥–µ—Å—å —É —Ç–∞–±–ª–∏—Ü—ñ –≤—Å–µ-—Ç–∞–∫–∏ —î **–¥–≤—ñ –∞–∫—Ç–∏–≤–Ω—ñ –º—ñ—Ç–∫–∏** –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º `(TAB_NO, NFC_ID)`;
* –∞–±–æ —ñ–Ω–¥–µ–∫—Å/—Ç–∞–±–ª–∏—Ü—è —Ç—Ä–æ—Ö–∏ –Ω–µ —Ç–∞–∫, —è–∫ –º–∏ –¥—É–º–∞—î–º–æ (–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π DDL –º—ñ–≥ –±—É—Ç–∏ —ñ–Ω—à–∏–π).

–©–æ–± –Ω–µ –∑–∞–≥–Ω–∞—Ç–∏ —Å–µ–±–µ –≤ –¥–µ–±–∞–≥ –Ω–∞ –≥–æ–¥–∏–Ω–∏, —Ç—É—Ç –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ —ñ –Ω–∞–π–±–µ–∑–ø–µ—á–Ω—ñ—à–µ —Ä—ñ—à–µ–Ω–Ω—è ‚Äî **–ø–µ—Ä–µ—Ä–æ–±–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å —Ç–∞–∫, —â–æ–± –≤—ñ–Ω –±–∞—á–∏–≤ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –∑–∞–ø–∏—Å–∏** —á–µ—Ä–µ–∑ `CASE` –ø—Ä—è–º–æ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∞—Ö, –∞ –Ω–µ –Ω–∞ –æ–∫—Ä–µ–º–æ–º—É ‚Äú–ø—Ä–∞–ø–æ—Ä—Ü—ñ‚Äù.

---

## 2. –ù–∞–¥—ñ–π–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω–∏—Ö –º—ñ—Ç–∫–∞—Ö

–ó—Ä–æ–±–∏ —Ç–∞–∫ (—ñ–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—é —è–∫ —É —Ç–µ–±–µ):

```sql
-- 1. –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞—Ä–∏–π —ñ–Ω–¥–µ–∫—Å
DROP INDEX ux_user_tag_active_code;

-- 2. –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π: —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –ª–∏—à–µ —Å–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–Ω–∏—Ö
CREATE UNIQUE INDEX ux_user_tag_active_code
  ON user_tag (
    CASE WHEN date_end IS NULL THEN tab_no END,
    CASE WHEN date_end IS NULL THEN nfc_id END
  );
```

üîç –õ–æ–≥—ñ–∫–∞:

* –Ø–∫—â–æ `DATE_END IS NULL` (–º—ñ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞) ‚Üí –∫–ª—é—á = `(TAB_NO, NFC_ID)`
  ‚áí **–Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –¥–≤–æ—Ö –∞–∫—Ç–∏–≤–Ω–∏—Ö** –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º `(TAB_NO, NFC_ID)`.
* –Ø–∫—â–æ `DATE_END IS NOT NULL` (–º—ñ—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞) ‚Üí –∫–ª—é—á = `(NULL, NULL)`
  ‚áí —Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∑ —Ç—ñ—î—é –∂ –º—ñ—Ç–∫–æ—é.

–î–ª—è —Ç–≤–æ–≥–æ `UPDATE`:

```plsql
UPDATE user_tag
   SET date_end        = SYSTIMESTAMP,
       deactivation_by = :P5_UID
 WHERE id = :P5_ID;
```

–±—É–¥–µ —Ç–∞–∫:

* –¥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞–ø–∏—Å ‚Üí —ñ–Ω–¥–µ–∫—Å–Ω–∏–π –∫–ª—é—á `(tab_no, nfc_id)`;
* –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π ‚Üí `(NULL, NULL)` ‚Üí **–Ω—ñ—è–∫–æ–≥–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É** –∑ —ñ–Ω—à–∏–º–∏.

---

## 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º —ñ–Ω–¥–µ–∫—Å–∞

–ü–µ—Ä–µ–¥ `CREATE UNIQUE` –∫—Ä–∞—â–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ **–Ω–µ–º–∞—î –¥–≤–æ—Ö –∞–∫—Ç–∏–≤–Ω–∏—Ö** –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º `(tab_no, nfc_id)`:

```sql
SELECT tab_no, nfc_id, COUNT(*) cnt
FROM user_tag
WHERE date_end IS NULL
GROUP BY tab_no, nfc_id
HAVING COUNT(*) > 1;
```

–Ø–∫—â–æ —Ü–µ–π –∑–∞–ø–∏—Ç —â–æ—Å—å –ø–æ–≤–µ—Ä–Ω–µ ‚Äî —Ç–∞–º —Ä–µ–∞–ª—å–Ω—ñ –¥—É–±–ª—ñ –∞–∫—Ç–∏–≤–Ω–∏—Ö.
–á—Ö —Ç—Ä–µ–±–∞ –∞–±–æ:

* –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ä—É–∫–∞–º–∏ (–æ–¥–Ω—É –∑ –º—ñ—Ç–æ–∫ –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏),
* –∞–±–æ —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ –¥–∞–Ω—ñ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å.

---

## 4. –ü—Ä–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è `deactivation_by`

–¢–≤—ñ–π –∞–ø–¥–µ–π—Ç:

```plsql
UPDATE user_tag
   SET date_end        = SYSTIMESTAMP,
       deactivation_by = :P5_UID
 WHERE id = :P5_ID;
```

‚Äî **—ñ–¥–µ–∞–ª—å–Ω–∏–π**, –≤—ñ–Ω –Ω–µ —á—ñ–ø–∞—î `TAB_NO`/`NFC_ID`, —Ç–æ–∂ –∑ –Ω–æ–≤–∏–º —ñ–Ω–¥–µ–∫—Å–æ–º —É—Å–µ –±—É–¥–µ –æ–∫.

–ì–æ–ª–æ–≤–Ω–µ: —â–æ–±–∏ –Ω—ñ–¥–µ –Ω–µ–º–∞—î —ñ–Ω—à–æ–≥–æ –∫–æ–¥—É, —è–∫–∏–π –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó:

* –≤—Å—Ç–∞–≤–ª—è—î –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫ –∑–∞–º—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è,
* –∞–±–æ –º—ñ–Ω—è—î `NFC_ID`/`TAB_NO`.

---

## 5. –Ø–∫—â–æ —Ö–æ—á–µ—à –¥–æ–¥–∞—Ç–∫–æ–≤–æ –æ–±–º–µ–∂–∏—Ç–∏ ‚Äú1 –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞‚Äù

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    CASE WHEN date_end IS NULL THEN tab_no END
  );
```

‚Üí –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –º—ñ—Ç–∫–∞ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–±—É–¥—å-—è–∫–∏–π –∫–æ–¥).
–ê–±–æ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–µ –π –ø–æ —Ç–∏–ø—É:

```sql
CREATE UNIQUE INDEX ux_user_tag_active_user
  ON user_tag (
    CASE WHEN date_end IS NULL THEN tab_no      END,
    CASE WHEN date_end IS NULL THEN tag_type_id END
  );
```

---

**–©–æ –± —è –∑—Ä–æ–±–∏–≤ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑:**

1. –ó–∞–ø—É—Å—Ç–∏–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏—Ö –º—ñ—Ç–æ–∫ (–∑–∞–ø–∏—Ç –≤–∏—â–µ).
2. –î—Ä–æ–ø–Ω—É–≤ `UX_USER_TAG_ACTIVE_CODE`.
3. –°—Ç–≤–æ—Ä–∏–≤ –Ω–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å –∑ `CASE WHEN date_end IS NULL THEN ... END` –Ω–∞ –∫–æ–ª–æ–Ω–∫–∞—Ö.
4. –©–µ —Ä–∞–∑ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞–≤ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—é —á–µ—Ä–µ–∑ APEX.

–Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–µ—à —Å–∫–∏–Ω—É—Ç–∏ —Å–≤—ñ–π –ø–æ–≤–Ω–∏–π DDL —Ç–∞–±–ª–∏—Ü—ñ `USER_TAG/USER_NFC` (CREATE TABLE + —ñ–Ω–¥–µ–∫—Å–∏), —ñ —è –ø—Ä–æ—Å—Ç–æ –Ω–∞ –Ω—å–æ–º—É –ø–µ—Ä–µ–ø–∏—à—É –≤—Å—é —Å—Ö–µ–º—É —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç–µ–π –ø—ñ–¥ —Ç–≤–æ—é –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É ‚Äú1 –∞–∫—Ç–∏–≤–Ω–∞ / –±–∞–≥–∞—Ç–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö‚Äù.
