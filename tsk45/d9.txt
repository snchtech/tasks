–¢–∞–∫, —á—É–¥–æ–≤–µ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è ‚Äî `has_role` —Ç–µ–∂ –º–∞—î –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –∑–∞–º—ñ—â–µ–Ω–Ω—è, —Ç–∞–∫ —Å–∞–º–æ —è–∫ –º–∏ —Ä–æ–±–∏–ª–∏ –¥–ª—è `user_id`.

–ó—Ä–æ–±–∏–º–æ —Ü–µ –≤ –¥–≤–∞ –∫—Ä–æ–∫–∏:

---

## 1. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è ¬´–∞–∫—Ç–∏–≤–Ω–æ–≥–æ¬ª –ª–æ–≥—ñ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —Ç–∏ –º–∞—î—à item `P0_NEW_USERNAME`, –∫—É–¥–∏ –ø—Ä–∏ –∑–∞–º—ñ—â–µ–Ω–Ω—ñ –∫–ª–∞–¥–µ—à –ª–æ–≥—ñ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤—ñ–¥ —ñ–º–µ–Ω—ñ —è–∫–æ–≥–æ –ø—Ä–∞—Ü—é—î–º–æ.

```sql
FUNCTION get_effective_username RETURN VARCHAR2 IS
    l_username  VARCHAR2(4000);
BEGIN
    IF NVL(:P0_SUBSTITUTION_MODE, 0) = 1 THEN
        -- —Ä–µ–∂–∏–º –∑–∞–º—ñ—â–µ–Ω–Ω—è: –±–µ—Ä–µ–º–æ –ª–æ–≥—ñ–Ω –∑–∞–º—ñ—â—É–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        l_username := :P0_NEW_USERNAME;
    ELSE
        -- –∑–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º: –ø–æ—Ç–æ—á–Ω–∏–π APP_USER
        l_username := v('APP_USER');
    END IF;

    RETURN l_username;
END get_effective_username;
```

–Ø–∫—â–æ –≤ —Ç–µ–±–µ –Ω–µ–º–∞—î `P0_NEW_USERNAME`, –∞ —î —Ç—ñ–ª—å–∫–∏ `P0_NEW_USER_ID`, –º–æ–∂–Ω–∞ —Ç—É—Ç –∂–µ –∑—Ä–æ–±–∏—Ç–∏ `SELECT login FROM USERS WHERE id = :P0_NEW_USER_ID;` ‚Äî –∞–ª–µ –Ω–∞–π–∑—Ä—É—á–Ω—ñ—à–µ –º–∞—Ç–∏ `P0_NEW_USERNAME`.

---

## 2. –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è `has_role` –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–º—ñ—â–µ–Ω–Ω—è

```sql
FUNCTION has_role(p_role_static_id IN VARCHAR2) RETURN BOOLEAN IS
    l_dummy     PLS_INTEGER;
    l_username  VARCHAR2(4000);
BEGIN
    -- –í–∏–∑–Ω–∞—á–∞—î–º–æ, –≤—ñ–¥ —á–∏–π–æ–≥–æ —ñ–º–µ–Ω—ñ –ø—Ä–∞—Ü—é—î–º–æ
    l_username := get_effective_username;

    IF l_username IS NULL THEN
        RETURN FALSE;
    END IF;

    SELECT 1
      INTO l_dummy
      FROM apex_appl_acl_user_roles r
     WHERE r.application_id = TO_NUMBER(v('APP_ID'))
       AND UPPER(r.user_name)      = UPPER(l_username)
       AND r.role_static_id        = p_role_static_id;

    RETURN TRUE;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN FALSE;
    WHEN OTHERS THEN
        RETURN FALSE;
END has_role;
```

üîπ –¢—É—Ç –≤–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏:

* `get_effective_username` —Å–∞–º –≤–∏—Ä—ñ—à—É—î:

  * —è–∫—â–æ `P0_SUBSTITUTION_MODE = 1` ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ `P0_NEW_USERNAME`,
  * —è–∫—â–æ `0` ‚Üí `v('APP_USER')`.
* –Ø –¥–æ–¥–∞–≤ `UPPER(...)` –¥–ª—è `user_name`, –±–æ –≤ ACL —á–∞—Å—Ç–æ –≤—Å–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ upper-case, –∞ –ª–æ–≥—ñ–Ω–∏ –º–æ–∂—É—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö —Ä–µ–≥—ñ—Å—Ç—Ä–∞—Ö.

---

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ:

* –£—Å—ñ –≤–∏–∫–ª–∏–∫–∏ `has_role('EDITOR')`, `has_role('CHIEF_EDITOR')` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏–º—É—Ç—å –∑–∞–º—ñ—â–µ–Ω–Ω—è.
* –õ–æ–≥—ñ–∫–∞ `can_edit_task`, `can_edit_template`, `can_create_task` –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç–∞–∫–æ—é, —è–∫ –º–∏ –≤–∂–µ –±—É–¥—É–≤–∞–ª–∏ ‚Äî –≤–æ–Ω–∏ –≤–∂–µ –ø—Ä–∞—Ü—é—é—Ç—å –∑ `get_effective_user_id` (–ø–æ `P0_SUBSTITUTION_MODE` / `P0_NEW_USER_ID`), –∞ `has_role` —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –ø–æ ¬´–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É¬ª –ª–æ–≥—ñ–Ω—É.
