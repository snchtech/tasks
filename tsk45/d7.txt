–°—É–ø–µ—Ä –∑–∞–¥–∞—á–∞, —Ü–µ —è–∫—Ä–∞–∑ —Ç–µ, –¥–µ APEX-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ–π–Ω—ñ —Å—Ö–µ–º–∏ –±—Ä–∏–ª—ñ–∞–Ω—Ç–æ–≤–æ –∑–∞—Ö–æ–¥—è—Ç—å üíé
–ó—Ä–æ–±–∏–º–æ **–æ–¥–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –≤ –ø–∞–∫–µ—Ç—ñ**, –∞ –¥–∞–ª—ñ —ó—ó –ø—Ä–æ—Å—Ç–æ –ø—ñ–¥–≤‚Äô—è–∂–µ—à –¥–æ –∫–Ω–æ–ø–æ–∫ / —Å—Ç–æ—Ä—ñ–Ω–æ–∫.

---

## 0. –õ–æ–≥—ñ–∫–∞, —è–∫—É –∑–∞–∫–æ–¥–æ–≤—É—î–º–æ

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á **–º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏** –∑–∞–≤–¥–∞–Ω–Ω—è / —à–∞–±–ª–æ–Ω, —è–∫—â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ö–æ—á–∞ –± –æ–¥–Ω–∞ –∑ —É–º–æ–≤:

1. **–ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä (EDITOR)**

   * –º–∞—î —Ä–æ–ª—å `EDITOR` **—ñ**
   * (—î –∞–≤—Ç–æ—Ä–æ–º –∑–∞–≤–¥–∞–Ω–Ω—è: `created_by = cur_user_id`
     **–∞–±–æ** —î –≤–∏–∫–æ–Ω–∞–≤—Ü–µ–º —É `SIGNATURERIGHTS` –¥–ª—è —Ü—å–æ–≥–æ `task_id` –∑ `stage = 2`).

2. **–ì–æ–ª–æ–≤–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä (CHIEF_EDITOR)**

   * –º–∞—î —Ä–æ–ª—å `CHIEF_EDITOR`
   * —ñ `TASKS.DEPARTMENT_ID = :P0_CUR_DEPARTMENT_ID`.

3. **–ó–∞–º—ñ—â–µ–Ω–Ω—è**

   * —è–∫—â–æ `:P0_SUBSTITUTION_MODE = 1` ‚Üí –±–µ—Ä–µ–º–æ `:P0_NEW_USER_ID`,
   * —è–∫—â–æ `:P0_SUBSTITUTION_MODE = 0` ‚Üí –±–µ—Ä–µ–º–æ `:P0_CUR_USER_ID`.

---

## 1. –ü–∞–∫–µ—Ç, —è–∫–∏–π –≤—Å–µ —Ü–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î

–ù–∞–∑–≤—É —É–º–æ–≤–Ω–æ `auth_task_pkg` (–º–æ–∂–µ—à –≤—Å—Ç–∞–≤–∏—Ç–∏ —É —Å–≤—ñ–π —ñ—Å–Ω—É—é—á–∏–π `auth_pkg`).

### 1.1. –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–æ–ª—ñ

–Ø–∫—â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à APEX Access Control (ACL), –º–æ–∂–Ω–∞ —Ç–∞–∫:

```sql
CREATE OR REPLACE PACKAGE auth_task_pkg AS
  FUNCTION has_role(p_role_static_id IN VARCHAR2) RETURN BOOLEAN;
  FUNCTION get_effective_user_id RETURN NUMBER;
  FUNCTION can_edit_task (p_task_id IN NUMBER) RETURN BOOLEAN;
  FUNCTION can_create_task RETURN BOOLEAN;
  FUNCTION can_edit_template (p_template_id IN NUMBER) RETURN BOOLEAN;
END auth_task_pkg;
/
CREATE OR REPLACE PACKAGE BODY auth_task_pkg AS

  FUNCTION has_role(p_role_static_id IN VARCHAR2) RETURN BOOLEAN IS
  BEGIN
    RETURN apex_util.current_user_in_role(p_role_static_id => p_role_static_id);
  EXCEPTION
    WHEN OTHERS THEN
      RETURN FALSE;
  END has_role;
```

> –Ø–∫—â–æ —Ç–∏ —Ä–∞–Ω—ñ—à–µ —á–∏—Ç–∞–≤ —Ä–æ–ª—ñ –∑ `APEX_APPL_ACL_USER_ROLES`, –º–æ–∂–µ—à –∑–∞–º—ñ—Å—Ç—å `apex_util.current_user_in_role` –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Å–≤—ñ–π SELECT.

### 1.2. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è ¬´–∞–∫—Ç–∏–≤–Ω–æ–≥–æ¬ª –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–∑–∞–º—ñ—â–µ–Ω–Ω—è)

```sql
  FUNCTION get_effective_user_id RETURN NUMBER IS
    l_user_id NUMBER;
  BEGIN
    IF NVL(:P0_SUBSTITUTION_MODE, 0) = 1 THEN
      l_user_id := :P0_NEW_USER_ID;
    ELSE
      l_user_id := :P0_CUR_USER_ID;
    END IF;

    RETURN l_user_id;
  END get_effective_user_id;
```

### 1.3. –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è `can_edit_task`

```sql
  FUNCTION can_edit_task (p_task_id IN NUMBER) RETURN BOOLEAN IS
    l_user_id          NUMBER;
    l_is_editor        BOOLEAN;
    l_is_chief_editor  BOOLEAN;
    l_task_department  TASKS.DEPARTMENT_ID%TYPE;
    l_created_by       TASKS.CREATED_BY%TYPE;
    l_cnt              PLS_INTEGER;
  BEGIN
    -- –•—Ç–æ –∑–∞—Ä–∞–∑ ¬´–¥—ñ–π—Å–Ω–∏–π¬ª –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–º—ñ—â–µ–Ω–Ω—è)
    l_user_id := get_effective_user_id;

    -- –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π
    IF l_user_id IS NULL THEN
      RETURN FALSE;
    END IF;

    -- –†–æ–ª—ñ
    l_is_editor       := has_role('EDITOR');
    l_is_chief_editor := has_role('CHIEF_EDITOR');

    IF NOT (l_is_editor OR l_is_chief_editor) THEN
      RETURN FALSE;
    END IF;

    -- –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —ñ –∞–≤—Ç–æ—Ä–∞ –∑–∞–≤–¥–∞–Ω–Ω—è
    BEGIN
      SELECT t.DEPARTMENT_ID,
             t.CREATED_BY
        INTO l_task_department,
             l_created_by
        FROM TASKS t
       WHERE t.ID = p_task_id;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RETURN FALSE;
    END;

    -- 1) –ü—Ä–∞–≤–æ CHIEF_EDITOR: –±—É–¥—å-—è–∫–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ —Å–≤–æ—î–º—É –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ñ
    IF l_is_chief_editor
       AND l_task_department = :P0_CUR_DEPARTMENT_ID THEN
      RETURN TRUE;
    END IF;

    -- 2) –ü—Ä–∞–≤–æ EDITOR —Ç—ñ–ª—å–∫–∏ –ø–æ —Å–≤–æ—ó—Ö –∑–∞–≤–¥–∞–Ω–Ω—è—Ö / –º–∞—Ä—à—Ä—É—Ç–∞—Ö

    -- 2.1. –Ø–∫—â–æ –≤—ñ–Ω –∞–≤—Ç–æ—Ä
    IF l_is_editor AND l_created_by = l_user_id THEN
      RETURN TRUE;
    END IF;

    -- 2.2. –Ø–∫—â–æ –≤—ñ–Ω –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å –∑ stage = 2 —É SIGNATURERIGHTS
    IF l_is_editor THEN
      SELECT COUNT(*)
        INTO l_cnt
        FROM SIGNATURERIGHTS s
       WHERE s.TASK_ID = p_task_id
         AND s.USER_ID = l_user_id
         AND s.STAGE   = 2; -- –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ AND s.IS_ACTIVE = 1, —è–∫—â–æ —î

      IF l_cnt > 0 THEN
        RETURN TRUE;
      END IF;
    END IF;

    RETURN FALSE;
  END can_edit_task;
```

### 1.4. –î–æ–∑–≤—ñ–ª –Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (–∑–∞–≤–¥–∞–Ω—å / —à–∞–±–ª–æ–Ω—ñ–≤)

–¢—É—Ç –ª–æ–≥—ñ–∫–∞ –ø—Ä–æ—Å—Ç–∞: **—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏** –º–æ–∂–Ω–∞, —è–∫—â–æ EDITOR –∞–±–æ CHIEF_EDITOR:

```sql
  FUNCTION can_create_task RETURN BOOLEAN IS
  BEGIN
    RETURN has_role('EDITOR') OR has_role('CHIEF_EDITOR');
  END can_create_task;
```

### 1.5. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —à–∞–±–ª–æ–Ω—ñ–≤

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ –¥–æ `TASKS`, —Ç—ñ–ª—å–∫–∏ —Ç–∞–±–ª–∏—Ü—è `TASK_TEMPLATES`:

```sql
  FUNCTION can_edit_template (p_template_id IN NUMBER) RETURN BOOLEAN IS
    l_user_id          NUMBER;
    l_is_editor        BOOLEAN;
    l_is_chief_editor  BOOLEAN;
    l_t_department     TASK_TEMPLATES.DEPARTMENT_ID%TYPE;
    l_created_by       TASK_TEMPLATES.CREATED_BY%TYPE;
  BEGIN
    l_user_id := get_effective_user_id;

    IF l_user_id IS NULL THEN
      RETURN FALSE;
    END IF;

    l_is_editor       := has_role('EDITOR');
    l_is_chief_editor := has_role('CHIEF_EDITOR');

    IF NOT (l_is_editor OR l_is_chief_editor) THEN
      RETURN FALSE;
    END IF;

    BEGIN
      SELECT t.DEPARTMENT_ID,
             t.CREATED_BY
        INTO l_t_department,
             l_created_by
        FROM TASK_TEMPLATES t
       WHERE t.ID = p_template_id;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RETURN FALSE;
    END;

    -- CHIEF_EDITOR –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É
    IF l_is_chief_editor
       AND l_t_department = :P0_CUR_DEPARTMENT_ID THEN
      RETURN TRUE;
    END IF;

    -- EDITOR —ñ –∞–≤—Ç–æ—Ä —à–∞–±–ª–æ–Ω—É
    IF l_is_editor AND l_created_by = l_user_id THEN
      RETURN TRUE;
    END IF;

    RETURN FALSE;
  END can_edit_template;

END auth_task_pkg;
/
```

---

## 2. –Ø–∫ –ø—ñ–¥–≤‚Äô—è–∑–∞—Ç–∏ —Ü–µ –≤ APEX

### 2.1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –∑–∞–≤–¥–∞–Ω–Ω—è (task_id)

–ü—Ä–∏–ø—É—Å—Ç—ñ–º–æ, –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–∞—Ä—Ç–∫–∏ –∑–∞–≤–¥–∞–Ω–Ω—è —î item `P6_TASK_ID`.

### –í–∞—Ä—ñ–∞–Ω—Ç –ê ‚Äî **Authorization Scheme**

1. **Shared Components ‚Üí Security ‚Üí Authorization Schemes ‚Üí Create**
2. –¢–∏–ø: **PL/SQL Function returning Boolean**
3. –ö–æ–¥, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:

```sql
RETURN auth_task_pkg.can_edit_task(:P6_TASK_ID);
```

4. –ù–∞–∑–≤–∞ —Å—Ö–µ–º–∏: `CAN_EDIT_TASK`.

–¢–µ–ø–µ—Ä:

* –¥–ª—è –∫–Ω–æ–ø–æ–∫ **¬´–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è¬ª**, **¬´–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ–≤¬ª**:

  * —É –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ **Authorization Scheme** –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ `CAN_EDIT_TASK`.

üëâ APEX —Å–∞–º –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤–∏–∫–ª–∏–∫–∞—î —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é, —ñ –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç—å –ø–æ–∫–∞–∑–∞–Ω—ñ / –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ.

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ:

* `CAN_EDIT_TEMPLATE` –∑—ñ —Å—Ç—Ä–æ–∫–æ—é:

```sql
RETURN auth_task_pkg.can_edit_template(:P7_TEMPLATE_ID);
```

—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à —Ü–µ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —à–∞–±–ª–æ–Ω—ñ–≤.

### 2.2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

–î–ª—è –∫–Ω–æ–ø–æ–∫ **¬´–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è¬ª**, **¬´–°—Ç–≤–æ—Ä–∏—Ç–∏ —à–∞–±–ª–æ–Ω¬ª**:

* —Ä–æ–±–∏—à –æ–∫—Ä–µ–º—É Authorization Scheme `CAN_CREATE_TASK` –∑ PL/SQL:

```sql
RETURN auth_task_pkg.can_create_task;
```

* —ñ —Å—Ç–∞–≤–∏—à —ó—ó –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫/—Å—Ç–æ—Ä—ñ–Ω–æ–∫.

---

## 3. –û–±–ª—ñ–∫ `P0_SUBSTITUTION_MODE` —Ç–∞ `P0_NEW_USER_ID`

–¶–µ —Ç–∏ –≤–∂–µ –∑–∞–∫–ª–∞–≤ —É —Ñ—É–Ω–∫—Ü—ñ—é `get_effective_user_id`:

* `:P0_SUBSTITUTION_MODE = 1` ‚Üí –±–µ—Ä–µ–º–æ `:P0_NEW_USER_ID`;
* `:P0_SUBSTITUTION_MODE = 0` ‚Üí –±–µ—Ä–µ–º–æ `:P0_CUR_USER_ID`.

–ì–æ–ª–æ–≤–Ω–µ:

* —â–æ–± —Ü—ñ **Page 0 items** –±—É–ª–∏ –≤ —Å–µ—Å—ñ—ó (–≤–æ–Ω–∏ –∂ —É —Ç–µ–±–µ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö ‚Äî –≤—Å–µ –æ–∫),
* —ñ —â–æ–± –≤–æ–Ω–∏ –±—É–ª–∏ **session state aware** (Default / Computation / –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –∑ –ª–æ–≥—ñ–∫–∏ –≤—Ö–æ–¥—É).

---

## 4. –ü—ñ–¥—Å—É–º–æ–≤—É—é

1. **–°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–∫–µ—Ç `auth_task_pkg`** —ñ–∑ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏:

   * `has_role`,
   * `get_effective_user_id`,
   * `can_edit_task(p_task_id)`,
   * `can_edit_template(p_template_id)`,
   * `can_create_task`.
2. **–ù–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö –∑–∞–≤–¥–∞–Ω—å/—à–∞–±–ª–æ–Ω—ñ–≤** —Ä–æ–±–∏–º–æ Authorization Schemes:

   * `CAN_EDIT_TASK` ‚Üí `auth_task_pkg.can_edit_task(:P6_TASK_ID);`
   * `CAN_EDIT_TEMPLATE` ‚Üí `auth_task_pkg.can_edit_template(:P7_TEMPLATE_ID);`
   * `CAN_CREATE_TASK` ‚Üí `auth_task_pkg.can_create_task;`
3. –£ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è—Ö **–∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è** —Å—Ç–∞–≤–∏–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É Authorization Scheme.
4. –õ–æ–≥—ñ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Ä–∞—Ö–æ–≤—É—î:

   * —Ä–æ–ª—å `EDITOR`,
   * —Ä–æ–ª—å `CHIEF_EDITOR`,
   * –∞–≤—Ç–æ—Ä–∞ (`CREATED_BY`),
   * –≤–∏–∫–æ–Ω–∞–≤—Ü—è –≤ `SIGNATURERIGHTS` –∑—ñ `STAGE = 2`,
   * –∑–∞–º—ñ—â–µ–Ω–Ω—è (`P0_SUBSTITUTION_MODE`, `P0_NEW_USER_ID`).

–Ø–∫—â–æ —Ö–æ—á–µ—à, —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫—Ä–æ—Ü—ñ –º–æ–∂—É –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –∫–æ–¥ –ø—ñ–¥ —Ç–≤–æ—é —Ä–µ–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–æ–ª–µ–π (–∑ —Ç–∞–±–ª–∏—Ü—ñ `APEX_APPL_ACL_USER_ROLES` —á–∏ —Ç–≤–æ—î—ó `GET_USER_ROLE_BY_CUSTOM_IDNTIFY`).
